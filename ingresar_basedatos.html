<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingresar Base de Datos - FACBA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuración para pdf.js para evitar problemas con workers
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

    <style>
        /* Estilos CSS personalizados */
        body {
            font-family: 'Inter', sans-serif; /* Asegura que la fuente Inter se aplique */
            background-color: #f2f2f7; /* Fondo gris muy claro */
            color: #1c1c1e; /* Color de texto oscuro por defecto */
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff; /* Fondo blanco para el contenedor */
            padding: 20px; /* Reducir padding en móviles */
            border-radius: 12px; /* Bordes redondeados */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* Sombra suave */
            max-width: 600px; /* Ancho máximo para el formulario */
            margin: 20px auto; /* Centra el contenedor y añade margen */
            position: relative; /* Necesario para el contexto del botón de atrás */
            width: 100%; /* Asegura que ocupe el ancho disponible en móviles */
            box-sizing: border-box; /* Incluye padding y borde en el ancho */
        }

        /* Ajustar padding del contenedor en pantallas más grandes */
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .container {
                padding: 30px;
            }
        }

        .action-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .action-buttons-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            background-color: #4f46e5; /* Azul/Morado */
            color: white;
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            border: none;
        }

        .action-button:hover {
            background-color: #4338ca; /* Azul/Morado más oscuro */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-button i {
            margin-right: 8px;
        }


        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #d1d5db; /* Gris claro */
            color: #1f2937; /* Gris oscuro */
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background-color: #9ca3af; /* Gris más oscuro */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        h1 {
            font-size: 1.8rem; /* Reducir tamaño en móviles */
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px; /* Reducir margen en móviles */
            color: #1f2937; /* Gris oscuro */
        }

        /* Ajustar tamaño del título en pantallas más grandes */
        @media (min-width: 640px) {
             h1 {
                 font-size: 2rem;
                 margin-bottom: 30px;
             }
        }


        .form-group {
            margin-bottom: 15px; /* Reducir espacio entre grupos en móviles */
        }

        /* Ajustar espacio entre grupos en pantallas más grandes */
        @media (min-width: 640px) {
             .form-group {
                 margin-bottom: 20px;
             }
        }


        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151; /* Gris medio */
            font-size: 0.9rem; /* Reducir tamaño de etiqueta en móviles */
        }

         @media (min-width: 640px) {
              .form-group label {
                  font-size: 1rem;
              }
         }


        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 10px; /* Reducir padding en móviles */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem; /* Reducir tamaño de fuente en móviles */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Incluye padding y borde en el ancho */
        }

         @media (min-width: 640px) {
             .form-group input[type="text"],
             .form-group input[type="number"],
             .form-group input[type="date"],
             .form-group select {
                 padding: 12px;
                 font-size: 1rem;
             }
         }


        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5; /* Color azul/morado */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Sombra de enfoque */
        }

        .form-buttons {
            display: flex;
            flex-direction: column; /* Apilar botones en móviles */
            gap: 10px; /* Espacio entre botones apilados */
            margin-top: 20px; /* Reducir margen en móviles */
        }

        /* Ajustar layout de botones en pantallas más grandes */
        @media (min-width: 640px) {
             .form-buttons {
                 flex-direction: row; /* Mostrar botones en fila */
                 justify-content: flex-end; /* Alinear a la derecha */
                 gap: 15px; /* Espacio entre botones en fila */
                 margin-top: 30px;
             }
        }


        .form-buttons button {
            padding: 12px 20px; /* Ajustar padding en móviles */
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%; /* Ocupar todo el ancho en móviles */
        }

         /* Ajustar ancho de botones en pantallas más grandes */
         @media (min-width: 640px) {
             .form-buttons button {
                 width: auto; /* Ancho automático */
                 padding: 12px 25px;
             }
         }


        .cancel-button {
            background-color: #e5e7eb; /* Gris claro */
            color: #374151; /* Gris oscuro */
        }

        .cancel-button:hover {
            background-color: #d1d5db; /* Gris más oscuro */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .submit-button {
            background-color: #4f46e5; /* Azul/Morado */
            color: white;
        }

        .submit-button:hover {
            background-color: #4338ca; /* Azul/Morado más oscuro */
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }

        /* Estilos para el mensaje de estado */
        #status-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0; /* Inicialmente oculto */
            transform: translateY(10px); /* Ligeramente hacia abajo */
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }

        #status-message.info {
            background-color: #eef2ff; /* Azul muy claro */
            color: #4f46e5; /* Azul/Morado */
        }

        #status-message.success {
            background-color: #d1fae5; /* Verde muy claro */
            color: #059669; /* Verde oscuro */
        }

        #status-message.error {
            background-color: #fee2e2; /* Rojo muy claro */
            color: #ef4444; /* Rojo oscuro */
        }


         /* Estilos para los modales */
         .modal-overlay {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.6); /* Fondo oscuro semitransparente */
             display: flex;
             justify-content: center;
             align-items: center;
             z-index: 1000; /* Asegura que esté por encima de todo */
             visibility: hidden; /* Oculto por defecto */
             opacity: 0;
             transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
         }

         .modal-overlay.show {
             visibility: visible;
             opacity: 1;
         }

         .modal-content {
             background-color: #ffffff;
             padding: 20px; /* Reducir padding en móviles */
             border-radius: 12px;
             box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
             max-width: 500px; /* Ancho máximo del modal */
             width: 90%; /* Ancho responsivo */
             position: relative;
             transform: translateY(-20px); /* Inicia ligeramente arriba */
             transition: transform 0.3s ease-in-out;
             box-sizing: border-box; /* Incluye padding y borde en el ancho */
         }

         @media (min-width: 640px) {
             .modal-content {
                 padding: 30px;
             }
         }


         .modal-overlay.show .modal-content {
             transform: translateY(0); /* Se desliza a su posición */
         }

         .modal-close-button {
             position: absolute;
             top: 10px; /* Ajustar posición en móviles */
             right: 10px; /* Ajustar posición en móviles */
             font-size: 1.5rem;
             color: #9ca3af; /* Gris */
             cursor: pointer;
             transition: color 0.2s ease-in-out;
         }

         @media (min-width: 640px) {
             .modal-close-button {
                 top: 15px;
                 right: 15px;
                 font-size: 1.8rem;
             }
         }


         .modal-content h2 {
             font-size: 1.5rem; /* Reducir tamaño en móviles */
             font-weight: 700;
             margin-bottom: 15px; /* Reducir margen en móviles */
             color: #1f2937;
             text-align: center;
         }

         @media (min-width: 640px) {
             .modal-content h2 {
                 font-size: 1.8rem;
                 margin-bottom: 20px;
             }
         }

         .modal-form-group {
             margin-bottom: 15px;
         }

         .modal-form-group label {
             display: block;
             font-weight: 600;
             margin-bottom: 8px;
             color: #374151;
             font-size: 0.9rem;
         }

         .modal-form-group input[type="text"],
         .modal-form-group select {
             width: 100%;
             padding: 10px;
             border: 1px solid #d1d5db;
             border-radius: 6px;
             font-size: 1rem;
             box-sizing: border-box;
         }

         .modal-form-group input[type="text"]:focus,
         .modal-form-group select:focus {
             outline: none;
             border-color: #4f46e5;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
         }

         .modal-buttons {
             display: flex;
             flex-direction: column; /* Apilar botones en móviles */
             justify-content: flex-end;
             gap: 10px;
             margin-top: 20px;
         }

         @media (min-width: 640px) {
             .modal-buttons {
                 flex-direction: row; /* Mostrar botones en fila */
             }
         }


         .modal-buttons button {
             padding: 10px 15px; /* Ajustar padding en móviles */
             border: none;
             border-radius: 6px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             width: 100%; /* Ocupar todo el ancho en móviles */
         }

         @media (min-width: 640px) {
             .modal-buttons button {
                 width: auto; /* Ancho automático */
                 padding: 10px 20px;
             }
         }

         .modal-buttons .cancel-button {
              background-color: #e5e7eb;
              color: #374151;
         }
         .modal-buttons .cancel-button:hover {
              background-color: #d1d5db;
         }

         .modal-buttons .save-changes-button {
              background-color: #10b981; /* Verde */
              color: white;
         }
         .modal-buttons .save-changes-button:hover {
              background-color: #059669; /* Verde oscuro */
         }

         /* Estilo para el input con botón al lado */
         .input-with-button {
             display: flex;
             align-items: center;
             gap: 10px; /* Espacio entre input y botón */
         }

         .input-with-button input,
         .input-with-button select {
             flex-grow: 1; /* Permite que el input o select ocupe el espacio disponible */
             width: auto; /* Anula el width: 100% del estilo general de input */
         }

         .input-with-button button {
             flex-shrink: 0; /* Evita que el botón se encoja */
             padding: 10px 15px;
             background-color: #e5e7eb; /* Gris claro */
             color: #374151; /* Gris oscuro */
             border: none;
             border-radius: 8px;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
         }

         .input-with-button button:hover {
             background-color: #d1d5db; /* Gris más oscuro */
         }

         /* Estilos para el checkbox de IBC */
         .ibc-label-container {
            display: flex;
            align-items: center;
            gap: 8px; /* Espacio entre el texto y el checkbox */
            margin-bottom: 8px; /* Espacio debajo de la etiqueta */
         }

         .ibc-label-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            /* Estilos básicos para el checkbox */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
         }

         .ibc-label-container input[type="checkbox"]:checked {
            background-color: #4f46e5; /* Color de fondo cuando está marcado */
            border-color: #4f46e5; /* Color del borde cuando está marcado */
            position: relative;
         }

         .ibc-label-container input[type="checkbox"]:checked::before {
            content: '\2713'; /* Símbolo de check (tick) */
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
         }

        /* Estilos para el modal de cámara */
        #camera-modal .modal-content {
            max-width: 700px;
            width: 95%;
        }

        #video-feed {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background-color: black;
            margin-bottom: 15px;
        }

        #camera-canvas {
            display: none; /* Oculto, usado para procesar frames */
        }

        #camera-modal-status {
            text-align: center;
            font-size: 1rem;
            color: #374151;
            margin-top: 10px;
        }

        /* Controles de cámara (flash, cambio de cámara) */
        .camera-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        }

        .camera-controls button,
        .camera-controls select {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: 1px solid #d1d5db;
            background-color: #f3f4f6;
            color: #374151;
        }

        .camera-controls button:hover,
        .camera-controls select:hover {
            background-color: #e5e7eb;
        }

        .camera-controls button.active-flash {
            background-color: #22c55e; /* Verde para flash activo */
            color: white;
            border-color: #22c55e;
        }

        .camera-controls button.active-flash:hover {
            background-color: #16a34a;
        }


        /* Estilos para el modal de PDF */
        #pdf-modal .modal-content {
            max-width: 600px;
            width: 90%;
        }

        #pdf-preview {
            width: 100%;
            height: 300px; /* Altura fija para el iframe de previsualización */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 15px;
            display: none; /* Oculto por defecto */
        }

        #pdf-modal-status {
            text-align: center;
            font-size: 1rem;
            color: #374151;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="action-buttons-container">
            <a href="https://soavanzar.github.io/FACBA/inicio_base_de_datos.html" class="back-button">
                <i class="fas fa-arrow-left"></i> Ir Atrás
            </a>
            <button type="button" id="scan-cedula-camera-btn" class="action-button">
                <i class="fas fa-camera"></i> Escanear Cédula (Cámara)
            </button>
            <button type="button" id="read-cedula-pdf-btn" class="action-button">
                <i class="fas fa-file-pdf"></i> Leer Cédula (PDF)
            </button>
        </div>

        <h1>Ingresar Nuevo Usuario</h1>

        <form id="user-form">
            <div class="form-group">
                <label for="primer-nombre">Primer Nombre:</label>
                <input type="text" id="primer-nombre" name="primerNombre" required>
            </div>
            <div class="form-group">
                <label for="segundo-nombre">Segundo Nombre:</label>
                <input type="text" id="segundo-nombre" name="segundoNombre">
            </div>
            <div class="form-group">
                <label for="primer-apellido">Primer Apellido:</label>
                <input type="text" id="primer-apellido" name="primerApellido" required>
            </div>
            <div class="form-group">
                <label for="segundo-apellido">Segundo Apellido:</label>
                <input type="text" id="segundo-apellido" name="segundoApellido">
            </div>

            <div class="form-group">
                <label for="tipo-identificacion">Tipo de Identificación:</label>
                <select id="tipo-identificacion" name="tipoIdentificacion" required>
                    <option value="">Selecciona</option>
                    <option value="CC">Cédula de Ciudadanía</option>
                    <option value="TI">Tarjeta de Identidad</option>
                    <option value="CE">Cédula de Extranjería</option>
                    <option value="PA">Pasaporte</option>
                    <option value="RC">Registro Civil</option>
                    <option value="TE">Tarjeta de Extranjería</option>
                    <option value="DIE">Documento de Identificación Extranjero</option>
                    <option value="PEP">Permiso Especial de Permanencia</option>
                    <option value="PT">Permiso De Protección Temporal</option>
                </select>
            </div>

            <div class="form-group">
                <label for="identificacion">Identificación:</label>
                <input type="number" id="identificacion" name="identificacion" required>
            </div>

            <div class="form-group">
                <label for="empresa">Empresa:</label>
                 <div class="input-with-button">
                    <select id="empresa" name="empresaId" required>
                        <option value="">Selecciona una empresa</option>
                        </select>
                     <button type="button" id="add-empresa-btn"><i class="fas fa-plus"></i></button>
                 </div>
            </div>

            <div class="form-group">
                <label for="arl">ARL:</label>
                <select id="arl" name="arlId">
                    <option value="">Selecciona una ARL</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="riesgo">Riesgo:</label>
                <input type="text" id="riesgo" name="riesgo">
            </div>

            <div class="form-group">
                <label for="eps">EPS:</label>
                <select id="eps" name="epsId">
                    <option value="">Selecciona una EPS</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="ccf">CCF:</label>
                <select id="ccf" name="ccfId">
                    <option value="">Selecciona una CCF</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="afp">AFP:</label>
                <select id="afp" name="afpId">
                    <option value="">Selecciona una AFP</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="fecha-ingreso">Fecha de Ingreso:</label>
                <input type="date" id="fecha-ingreso" name="fecha" required>
            </div>

            <div class="form-group">
                <label for="fecha-registro">Fecha de Registro Inicial:</label>
                <input type="date" id="fecha-registro" name="ingreso" required>
            </div>

            <div class="form-group">
                <label for="asesor">Asesor:</label>
                 <div class="input-with-button">
                    <select id="asesor" name="asesorId" required>
                        <option value="">Selecciona un asesor</option>
                        </select>
                     <button type="button" id="add-asesor-btn"><i class="fas fa-plus"></i></button>
                 </div>
            </div>

            <div class="form-group">
                <label for="valor-a-pagar">Valor a Pagar (COP):</label>
                <input type="number" id="valor-a-pagar" name="valorAPagar" step="0.01">
            </div>

             <div class="form-group ibc-group">
                 <div class="ibc-label-container">
                    <label for="ibc">IBC (Salario del trabajador):</label>
                    <input type="checkbox" id="ibc-smlv-checkbox">
                    <label for="ibc-smlv-checkbox">IBC S.M.L.V.</label>
                 </div>
                 <input type="number" id="ibc" name="ibc" step="0.01" placeholder="Salario del trabajador (IBC)">
             </div>
             <div class="form-buttons">
                <button type="button" class="cancel-button" id="cancel-button">Cancelar</button>
                <button type="submit" class="submit-button">Guardar Usuario</button>
            </div>
        </form>

        <div id="status-message"></div>
    </div>

    <div id="add-empresa-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-add-empresa-modal">&times;</span>
            <h2>Agregar Nueva Empresa</h2>
            <form id="add-empresa-form">
                <div class="modal-form-group">
                    <label for="new-empresa-name">Nombre:</label>
                    <input type="text" id="new-empresa-name" name="name" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-add-empresa">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-asesor-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-add-asesor-modal">&times;</span>
            <h2>Agregar Nuevo Asesor</h2>
            <form id="add-asesor-form">
                <div class="modal-form-group">
                    <label for="new-asesor-name">Nombre:</label>
                    <input type="text" id="new-asesor-name" name="name" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-add-asesor">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-camera-modal">&times;</span>
            <h2>Escanear Cédula (Cámara)</h2>
            <p class="text-sm text-gray-600 mb-4">
                Por favor, enfoca el código de barras PDF417 de la cédula en el centro de la cámara.
                <br>
                <span class="font-bold text-blue-500">Intentando leer PDF417 con ZXing-JS.</span>
                <span class="font-bold text-red-500">
                    Nota: La precisión de la lectura de PDF417 en el navegador puede variar según la calidad de la imagen y la iluminación.
                    <br>
                    Para rellenar automáticamente el formulario, se necesita una lógica de análisis específica para el formato de datos de la cédula colombiana, que es complejo y no está implementado en esta simulación.
                </span>
            </p>
            <video id="video-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" style="display:none;"></canvas>
            <div id="camera-modal-status" class="mt-4">Esperando código...</div>
            <div class="camera-controls">
                <button type="button" id="toggle-flash-btn" class="hidden">
                    <i class="fas fa-lightbulb"></i> Activar Flash
                </button>
                <select id="camera-select" class="p-2 border rounded-md"></select>
                <button type="button" class="cancel-button" id="stop-camera-btn">Detener Cámara</button>
            </div>
        </div>
    </div>

    <div id="pdf-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-pdf-modal">&times;</span>
            <h2>Leer Cédula (PDF)</h2>
            <p class="text-sm text-gray-600 mb-4">
                Selecciona un archivo PDF que contenga la cédula. Se intentará leer el código PDF417 de las imágenes en el PDF.
                <br>
                <span class="font-bold text-blue-500">Intentando leer PDF417 de imágenes dentro del PDF con ZXing-JS.</span>
                <span class="font-bold text-red-500">
                    Nota: La lectura de códigos de barras desde imágenes rasterizadas en PDFs puede ser un desafío. La calidad de la imagen y la resolución del PDF son cruciales.
                    <br>
                    Para rellenar automáticamente el formulario, se necesita una lógica de análisis específica para el formato de datos de la cédula colombiana.
                </span>
            </p>
            <input type="file" id="pdf-upload-input" accept="application/pdf" class="w-full p-2 border border-gray-300 rounded-md">
            <div id="pdf-modal-status" class="mt-4"></div>
            <iframe id="pdf-preview" class="mt-4" style="width: 100%; height: 300px; border: 1px solid #d1d5db; border-radius: 8px; display: none;"></iframe>
            <div class="modal-buttons mt-4">
                <button type="button" class="cancel-button" id="cancel-pdf-read-btn">Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCimRCv6S5u0FhsfWrW_3A0dQJy0uAKVro",
            authDomain: "facba-69d41.firebaseapp.com",
            projectId: "facba-69d41",
            storageBucket: "facba-69d41.firebaseapp.com", // Corrected storageBucket domain
            messagingSenderId: "264089433073",
            appId: "1:264089433073:web:968551648758972eb74a50",
            measurementId: "G-NL7Y6NDH99"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore(); // Initialize Firestore

        // References to Firestore collections
        const usersCollection = db.collection('usuarios');
        const empresasCollection = db.collection('empresas');
        const asesoresCollection = db.collection('asesores');
        const arlCollection = db.collection('arl'); // New collection for ARL
        const epsCollection = db.collection('eps');
        const ccfCollection = db.collection('ccf');
        const afpCollection = db.collection('afp');
        // NUEVO: Referencia a la colección de configuración para el IBC por defecto
        const settingsCollection = db.collection('settings');
        const defaultIbcDocRef = settingsCollection.doc('defaultIbc');


        // Get DOM elements
        const userForm = document.getElementById('user-form');
        const statusMessage = document.getElementById('status-message');
        const cancelButton = document.getElementById('cancel-button');

        // Form fields for names and surnames
        const primerNombreInput = document.getElementById('primer-nombre');
        const segundoNombreInput = document.getElementById('segundo-nombre');
        const primerApellidoInput = document.getElementById('primer-apellido');
        const segundoApellidoInput = document.getElementById('segundo-apellido');

        const tipoIdentificacionSelect = document.getElementById('tipo-identificacion');
        const identificacionInput = document.getElementById('identificacion');
        const empresaSelect = document.getElementById('empresa');
        const arlSelect = document.getElementById('arl'); // Selector for ARL
        const riesgoInput = document.getElementById('riesgo');
        const epsSelect = document.getElementById('eps'); // Selector for EPS
        const ccfSelect = document.getElementById('ccf'); // Selector for CCF
        const afpSelect = document.getElementById('afp'); // Selector for AFP
        const fechaIngresoInput = document.getElementById('fecha-ingreso');
        const fechaRegistroInput = document.getElementById('fecha-registro');
        const asesorSelect = document.getElementById('asesor');
        const valorAPagarInput = document.getElementById('valor-a-pagar');
        const ibcInput = document.getElementById('ibc'); // Input for IBC
        // NUEVO: Checkbox para IBC S.M.L.V.
        const ibcSmlvCheckbox = document.getElementById('ibc-smlv-checkbox');


        // Modal DOM elements (Add Entity Modals)
        const addEmpresaBtn = document.getElementById('add-empresa-btn');
        const addAsesorBtn = document.getElementById('add-asesor-btn');
        const addEmpresaModal = document.getElementById('add-empresa-modal');
        const addAsesorModal = document.getElementById('add-asesor-modal');
        const closeAddEmpresaModalButton = document.getElementById('close-add-empresa-modal');
        const closeAddAsesorModalButton = document.getElementById('close-add-asesor-modal');
        const cancelAddEmpresaButton = document.getElementById('cancel-add-empresa');
        const cancelAddAsesorButton = document.getElementById('cancel-add-asesor');
        const addEmpresaForm = document.getElementById('add-empresa-form');
        const addAsesorForm = document.getElementById('add-asesor-form');
        const newEmpresaNameInput = document.getElementById('new-empresa-name');
        const newAsesorNameInput = document.getElementById('new-asesor-name');

        // Nuevo: Elementos del modal de cámara
        const scanCedulaCameraButton = document.getElementById('scan-cedula-camera-btn');
        const cameraModal = document.getElementById('camera-modal');
        const closeCameraModalButton = document.getElementById('close-camera-modal');
        const videoFeed = document.getElementById('video-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const cameraModalStatus = document.getElementById('camera-modal-status');
        const stopCameraButton = document.getElementById('stop-camera-btn');
        const toggleFlashButton = document.getElementById('toggle-flash-btn'); // Nuevo botón de flash
        const cameraSelect = document.getElementById('camera-select'); // Nuevo selector de cámara

        let cameraStream = null; // Para almacenar la transmisión de la cámara
        let animationFrameId = null; // Para controlar el bucle de escaneo
        let isFlashOn = false; // Estado del flash

        // Instancia del lector de PDF417 de ZXing-JS
        const pdf417Reader = new ZXing.PDF417Reader();
        // Instancia del lector de QR de ZXing-JS (alternativa a jsQR si se desea unificar)
        // const qrReader = new ZXing.QRCodeReader();


        // Nuevo: Elementos del modal de PDF
        const readCedulaPdfButton = document.getElementById('read-cedula-pdf-btn');
        const pdfModal = document.getElementById('pdf-modal');
        const closePdfModalButton = document.getElementById('close-pdf-modal');
        const pdfUploadInput = document.getElementById('pdf-upload-input');
        const pdfModalStatus = document.getElementById('pdf-modal-status');
        const cancelPdfReadButton = document.getElementById('cancel-pdf-read-btn');
        const pdfPreview = document.getElementById('pdf-preview');


        // Variable para almacenar el valor de IBC por defecto
        let defaultIbcValue = 0;


        // --- Utility Functions ---

        // Function to show status messages
        function showStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = ''; // Reset classes
            statusMessage.classList.add(type);
            // Fade in
            statusMessage.style.opacity = '1';
            statusMessage.style.transform = 'translateY(0)';

            // Fade out after 5 seconds
            setTimeout(() => {
                statusMessage.style.opacity = '0';
                statusMessage.style.transform = 'translateY(10px)';
                 // Clear text after transition
                setTimeout(() => {
                     statusMessage.textContent = '';
                }, 400); // Match the transition duration
            }, 5000);
        }

        // Function to format date (Firestore Timestamp toYYYY-MM-DD) - Kept for potential future use or if needed elsewhere
        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) { // Check if it's a Firestore Timestamp
                 date = timestamp.toDate();
            } else if (typeof timestamp === 'string') { // Handle string dates
                 date = new Date(timestamp);
            } else { // Handle other potential date formats
                 date = new Date(timestamp);
            }

            if (isNaN(date.getTime())) {
                return ''; // Return empty string if date is invalid
            }

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // Function to format numbers as currency (COP) - Kept for potential future use or if needed elsewhere
        function formatCurrency(number) {
             let numericValue = number;
             if (typeof number === 'string') {
                 // More robust cleaning for currency strings
                 const cleanedString = number.replace(/[^0-9.,]/g, '') // Remove all except digits, comma, dot
                                            .replace(',', '.'); // Replace comma with dot for consistent float parsing

                 numericValue = parseFloat(cleanedString);
             }

             if (numericValue === undefined || numericValue === null || isNaN(numericValue)) {
                 return '';
             }

             return new Intl.NumberFormat('es-CO', {
                 style: 'currency',
                 currency: 'COP',
                 minimumFractionDigits: 0,
                 maximumFractionDigits: 2,
             }).format(numericValue);
        }


        // --- Real-time Data Loading and Select Population with onSnapshot ---

        // Function to populate a select element
        function populateSelect(selectElement, snapshot, defaultOptionText) {
            const currentValue = selectElement.value; // Save current selected value
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; // Clear and add default
            snapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().nombre || 'Nombre Desconocido';
                selectElement.appendChild(option);
            });
            // Restore previous selection if it still exists
            if (currentValue && Array.from(selectElement.options).some(option => option.value === currentValue)) {
                selectElement.value = currentValue;
            }
        }

        // Set up real-time listeners for each collection
        empresasCollection.onSnapshot(snapshot => {
            console.log("Empresas updated in real-time.");
            populateSelect(empresaSelect, snapshot, 'Selecciona una empresa');
        }, error => {
            console.error("Error listening to Empresas:", error);
            showStatusMessage('Error al cargar empresas en tiempo real.', 'error');
        });

        asesoresCollection.onSnapshot(snapshot => {
            console.log("Asesores updated in real-time.");
            populateSelect(asesorSelect, snapshot, 'Selecciona un asesor');
        }, error => {
            console.error("Error listening to Asesores:", error);
            showStatusMessage('Error al cargar asesores en tiempo real.', 'error');
        });

        arlCollection.onSnapshot(snapshot => {
            console.log("ARL updated in real-time.");
            populateSelect(arlSelect, snapshot, 'Selecciona una ARL');
        }, error => {
            console.error("Error listening to ARL:", error);
            showStatusMessage('Error al cargar ARLs en tiempo real.', 'error');
        });

        epsCollection.onSnapshot(snapshot => {
            console.log("EPS updated in real-time.");
            populateSelect(epsSelect, snapshot, 'Selecciona una EPS');
        }, error => {
            console.error("Error listening to EPS:", error);
            showStatusMessage('Error al cargar EPSs en tiempo real.', 'error');
        });

        ccfCollection.onSnapshot(snapshot => {
            console.log("CCF updated in real-time.");
            populateSelect(ccfSelect, snapshot, 'Selecciona una CCF');
        }, error => {
            console.error("Error listening to CCF:", error);
            showStatusMessage('Error al cargar CCFs en tiempo real.', 'error');
        });

        afpCollection.onSnapshot(snapshot => {
            console.log("AFP updated in real-time.");
            populateSelect(afpSelect, snapshot, 'Selecciona una AFP');
        }, error => {
            console.error("Error listening to AFP:", error);
            showStatusMessage('Error al cargar AFPs en tiempo real.', 'error');
        });

        // NUEVO: Listener para el IBC por defecto
        defaultIbcDocRef.onSnapshot(doc => {
            if (doc.exists) {
                defaultIbcValue = doc.data().value || 0;
                console.log("IBC por defecto actualizado en tiempo real:", defaultIbcValue);
                // Si el checkbox está marcado, actualizar el campo IBC
                if (ibcSmlvCheckbox.checked) {
                    ibcInput.value = defaultIbcValue;
                }
            } else {
                defaultIbcValue = 0;
                console.log("No se encontró IBC por defecto en Firestore.");
                // Si el checkbox está marcado y no hay valor por defecto, vaciar el campo
                if (ibcSmlvCheckbox.checked) {
                    ibcInput.value = '';
                }
            }
        }, error => {
            console.error("Error listening to default IBC:", error);
            showStatusMessage('Error al cargar el IBC por defecto en tiempo real.', 'error');
        });


        // --- Form Submission ---

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            // Gather form data
            const userData = {
                primerNombre: primerNombreInput.value,
                segundoNombre: segundoNombreInput.value,
                primerApellido: primerApellidoInput.value,
                segundoApellido: segundoApellidoInput.value,
                tipoIdentificacion: tipoIdentificacionSelect.value,
                identificacion: identificacionInput.value,
                empresaId: empresaSelect.value || null, // Store ID or null if not selected
                arlId: arlSelect.value || null, // Store ARL ID or null
                riesgo: riesgoInput.value,
                epsId: epsSelect.value || null, // Store EPS ID or null
                ccfId: ccfSelect.value || null, // Store CCF ID or null
                afpId: afpSelect.value || null, // Store AFP ID or null
                fecha: fechaIngresoInput.value, // Store asYYYY-MM-DD string
                ingreso: fechaRegistroInput.value, // Store asYYYY-MM-DD string
                asesorId: asesorSelect.value || null, // Store ID or null
                valorAPagar: parseFloat(valorAPagarInput.value) || 0, // Convert to number, default to 0 if empty/invalid
                ibc: parseFloat(ibcInput.value) || 0, // Store IBC as number, default to 0
                estado: 'activo', // Default status for new users
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                // fechaRetiro is not applicable for new users
            };

            // Basic validation (more comprehensive validation can be added)
            if (!userData.primerNombre || !userData.primerApellido || !userData.tipoIdentificacion || !userData.identificacion || !userData.empresaId || !userData.fecha || !userData.ingreso || !userData.asesorId) {
                 showStatusMessage('Por favor, completa todos los campos obligatorios (Primer Nombre, Primer Apellido, Tipo de Identificación, Identificación, Empresa, Fecha de Ingreso, Fecha de Registro Inicial, Asesor).', 'error');
                 return;
            }


            showStatusMessage('Guardando usuario...', 'info');

            try {
                const docRef = await usersCollection.add(userData);
                console.log("Document written with ID: ", docRef.id);
                showStatusMessage('Usuario guardado con éxito!', 'success');
                userForm.reset(); // Clear the form
                ibcSmlvCheckbox.checked = false; // Reset checkbox state
                // No need to call populateSelects() here, onSnapshot listeners will handle it
            } catch (e) {
                console.error("Error adding document: ", e);
                showStatusMessage('Error al guardar usuario: ' + e.message, 'error');
            }
        });


        // --- Cancel Button ---
        cancelButton.addEventListener('click', () => {
            // Redirect to the main database page
            window.location.href = 'https://soavanzar.github.io/FACBA/inicio_base_de_datos.html';
        });


        // --- Modal for Adding New Empresa ---

        // Show the add Empresa modal
        addEmpresaBtn.addEventListener('click', () => {
            addEmpresaModal.classList.add('show');
            newEmpresaNameInput.value = ''; // Clear input
        });

        // Hide the add Empresa modal
        function hideAddEmpresaModal() {
            addEmpresaModal.classList.remove('show');
            addEmpresaForm.reset(); // Reset the form
        }

        // Listeners to close the add Empresa modal
        closeAddEmpresaModalButton.addEventListener('click', hideAddEmpresaModal);
        cancelAddEmpresaButton.addEventListener('click', hideAddEmpresaModal);
        addEmpresaModal.addEventListener('click', (e) => {
            if (e.target === addEmpresaModal) {
                hideAddEmpresaModal();
            }
        });

        // Listener for submitting the add Empresa form
        addEmpresaForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default submission

            const entityName = newEmpresaNameInput.value.trim();

            if (!entityName) {
                showStatusMessage("Por favor, ingresa el nombre de la empresa.", 'error');
                return;
            }

            showStatusMessage(`Agregando Empresa ${entityName}...`, 'info');

            try {
                // Optional: Check if Empresa already exists before adding
                const existingEmpresas = await empresasCollection.where('nombre', '==', entityName).get();
                if (!existingEmpresas.empty) {
                     showStatusMessage(`La empresa "${entityName}" ya existe.`, 'error');
                     return;
                }

                await empresasCollection.add({
                     nombre: entityName,
                     createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showStatusMessage('Nueva Empresa agregada con éxito!', 'success');
                hideAddEmpresaModal(); // Close modal after saving

                // onSnapshot listener will automatically update the select
            } catch (error) {
                console.error(`Error adding Empresa:`, error);
                showStatusMessage(`Error al agregar Empresa: ` + error.message, 'error');
            }
        });

        // --- Modal for Adding New Asesor ---

        // Show the add Asesor modal
        addAsesorBtn.addEventListener('click', () => {
            addAsesorModal.classList.add('show');
            newAsesorNameInput.value = ''; // Clear input
        });

        // Hide the add Asesor modal
        function hideAddAsesorModal() {
            addAsesorModal.classList.remove('show');
            addAsesorForm.reset(); // Reset the form
        }

        // Listeners to close the add Asesor modal
        closeAddAsesorModalButton.addEventListener('click', hideAddAsesorModal);
        cancelAddAsesorButton.addEventListener('click', hideAddAsesorModal);
        addAsesorModal.addEventListener('click', (e) => {
            if (e.target === addAsesorModal) {
                hideAddAsesorModal();
            }
        });

        // Listener for submitting the add Asesor form
        addAsesorForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default submission

            const entityName = newAsesorNameInput.value.trim();

            if (!entityName) {
                 showStatusMessage("Por favor, ingresa el nombre del asesor.", 'error');
                return;
            }

            showStatusMessage(`Agregando Asesor ${entityName}...`, 'info');

            try {
                 // Optional: Check if Asesor already exists before adding
                 const existingAsesores = await asesoresCollection.where('nombre', '==', entityName).get();
                 if (!existingAsesores.empty) {
                      showStatusMessage(`El asesor "${entityName}" ya existe.`, 'error');
                      return;
                 }

                await asesoresCollection.add({
                     nombre: entityName,
                     createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showStatusMessage('Nuevo Asesor agregado con éxito!', 'success');
                hideAddAsesorModal(); // Close modal after saving

                // onSnapshot listener will automatically update the select
            } catch (error) {
                console.error(`Error adding Asesor:`, error);
                showStatusMessage(`Error al agregar Asesor: ` + error.message, 'error');
            }
        });


        // --- NUEVO: Lógica para el checkbox IBC S.M.L.V. ---
        ibcSmlvCheckbox.addEventListener('change', () => {
            if (ibcSmlvCheckbox.checked) {
                // Si el checkbox está marcado, usar el valor por defecto
                ibcInput.value = defaultIbcValue;
                ibcInput.readOnly = true; // Hacer el campo de solo lectura
            } else {
                // Si el checkbox está desmarcado, vaciar el campo
                ibcInput.value = '';
                ibcInput.readOnly = false; // Permitir edición
            }
        });


        // --- Funciones para rellenar el formulario (simuladas) ---
        // Esta función simula el llenado del formulario con datos de la cédula.
        // En un caso real, estos datos vendrían de un proceso de OCR o lectura de código de barras.
        function populateFormFromCedulaData(data) {
            // Ejemplo de cómo se rellenarían los campos si tuviéramos los datos extraídos
            // Adapta esto según la estructura real de los datos que obtengas del OCR/código
            if (data.identificacion) {
                identificacionInput.value = data.identificacion;
                tipoIdentificacionSelect.value = data.tipoIdentificacion || 'CC'; // Asume CC si no se especifica
            }
            if (data.primerNombre) primerNombreInput.value = data.primerNombre;
            if (data.segundoNombre) segundoNombreInput.value = data.segundoNombre;
            if (data.primerApellido) primerApellidoInput.value = data.primerApellido;
            if (data.segundoApellido) segundoApellidoInput.value = data.segundoApellido;
            // Podrías añadir más campos aquí (fecha de nacimiento, etc.)
            showStatusMessage('Formulario rellenado con datos de la cédula (simulado).', 'success');
        }


        // --- Lógica del Modal de Cámara ---

        // NUEVO: Función para detener solo la transmisión de la cámara (sin cerrar el modal)
        function stopMediaStream() {
            if (cameraStream) {
                if (isFlashOn) {
                    toggleFlash(false); // Asegurarse de apagar el flash
                }
                cameraStream.getTracks().forEach(track => track.stop());
                videoFeed.srcObject = null;
                cameraStream = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            toggleFlashButton.classList.add('hidden'); // Ocultar botón de flash al detener la transmisión
            toggleFlashButton.classList.remove('active-flash'); // Resetear estilo del botón de flash
            isFlashOn = false; // Resetear estado del flash
        }

        // Función para cerrar el modal de la cámara (y detener la transmisión)
        function closeCameraModal() {
            stopMediaStream(); // Detener la transmisión de la cámara
            cameraModal.classList.remove('show'); // Ocultar el modal
            cameraModalStatus.textContent = 'Esperando código...';
        }

        // Función para iniciar la cámara
        async function startCamera(deviceId = null) {
            stopMediaStream(); // Detener cualquier stream anterior sin cerrar el modal
            cameraModalStatus.textContent = 'Iniciando cámara...';
            try {
                const constraints = {
                    video: {
                        // Preferir cámara trasera si no se especifica un deviceId
                        facingMode: deviceId ? undefined : "environment",
                        deviceId: deviceId ? { exact: deviceId } : undefined
                    }
                };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoFeed.srcObject = cameraStream;
                videoFeed.play();
                cameraModalStatus.textContent = 'Cámara iniciada. Enfoca el código de barras PDF417.';

                // Verificar y mostrar el botón de flash
                const videoTrack = cameraStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    toggleFlashButton.classList.remove('hidden');
                } else {
                    toggleFlashButton.classList.add('hidden');
                }

                requestAnimationFrame(tick); // Iniciar el bucle de escaneo
            } catch (err) {
                console.error("Error al acceder a la cámara:", err);
                // Mensaje más específico para "Permission denied"
                if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
                    cameraModalStatus.textContent = 'Permiso de cámara denegado. Por favor, concede acceso a la cámara en la configuración de tu navegador para usar esta función.';
                    showStatusMessage('Permiso de cámara denegado. Habilítalo en la configuración del navegador.', 'error');
                } else {
                    cameraModalStatus.textContent = 'Error al iniciar la cámara. Asegúrate de dar permisos.';
                    showStatusMessage('Error al iniciar la cámara: ' + err.message, 'error');
                }
            }
        }

        // Función para alternar el flash/linterna
        async function toggleFlash(forceState = null) {
            const videoTrack = cameraStream.getVideoTracks()[0];
            if (!videoTrack) {
                console.warn("No hay pista de video activa para controlar el flash.");
                return;
            }

            try {
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    const newState = forceState !== null ? forceState : !isFlashOn;
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: newState }]
                    });
                    isFlashOn = newState;
                    toggleFlashButton.classList.toggle('active-flash', isFlashOn);
                    toggleFlashButton.textContent = isFlashOn ? 'Desactivar Flash' : 'Activar Flash';
                    console.log("Flash:", isFlashOn ? "ON" : "OFF");
                } else {
                    console.warn("La función de linterna (torch) no es soportada por esta cámara.");
                    showStatusMessage('Flash no disponible en esta cámara.', 'info');
                }
            } catch (err) {
                console.error("Error al alternar el flash:", err);
                showStatusMessage('Error al controlar el flash: ' + err.message, 'error');
            }
        }

        // Función para enumerar y poblar las cámaras disponibles
        async function enumerateCameras() {
            cameraSelect.innerHTML = ''; // Limpiar opciones existentes
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No se encontraron cámaras';
                    cameraSelect.appendChild(option);
                    cameraSelect.disabled = true;
                    return;
                }

                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Cámara ${device.deviceId.substring(0, 8)}...`;
                    cameraSelect.appendChild(option);
                });
                cameraSelect.disabled = false;

                // Intentar seleccionar la cámara que está actualmente activa o la primera
                if (cameraStream) {
                    const currentDeviceId = cameraStream.getVideoTracks()[0].getSettings().deviceId;
                    if (currentDeviceId) {
                        cameraSelect.value = currentDeviceId;
                    }
                } else if (videoDevices.length > 0) {
                    // Seleccionar la primera cámara por defecto si no hay una activa
                    cameraSelect.value = videoDevices[0].deviceId;
                }

            } catch (err) {
                console.error("Error al enumerar cámaras:", err);
                showStatusMessage('Error al listar cámaras: ' + err.message, 'error');
                cameraSelect.disabled = true;
            }
        }


        scanCedulaCameraButton.addEventListener('click', async () => {
            cameraModal.classList.add('show');
            await enumerateCameras(); // Enumerar cámaras al abrir el modal
            // Iniciar la cámara con la opción seleccionada o la primera por defecto
            await startCamera(cameraSelect.value);
        });

        closeCameraModalButton.addEventListener('click', closeCameraModal);
        stopCameraButton.addEventListener('click', closeCameraModal);
        cameraModal.addEventListener('click', (e) => {
            if (e.target === cameraModal) {
                closeCameraModal();
            }
        });

        toggleFlashButton.addEventListener('click', () => toggleFlash()); // Evento para el botón de flash
        cameraSelect.addEventListener('change', (e) => {
            startCamera(e.target.value); // Cambiar de cámara al seleccionar una nueva
        });


        async function tick() {
            if (videoFeed.readyState === videoFeed.HAVE_ENOUGH_DATA) {
                cameraCanvas.height = videoFeed.videoHeight;
                cameraCanvas.width = videoFeed.videoWidth;
                const ctx = cameraCanvas.getContext('2d');
                ctx.drawImage(videoFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                const imageData = ctx.getImageData(0, 0, cameraCanvas.width, cameraCanvas.height);

                let codeFound = false;

                // Intento de lectura de PDF417 con ZXing-JS
                try {
                    const pdf417Result = await pdf417Reader.decodeFromImageData(imageData);
                    if (pdf417Result && pdf417Result.text) {
                        console.log("Código PDF417 detectado (texto bruto):", pdf417Result.text);
                        cameraModalStatus.textContent = `Código PDF417 detectado (bruto): ${pdf417Result.text.substring(0, 50)}...`; // Mostrar parte del texto bruto
                        const cedulaData = parseCedulaDataFromPDF417(pdf417Result.text);
                        if (cedulaData) {
                            populateFormFromCedulaData(cedulaData);
                            closeCameraModal(); // Cierra el modal cuando se encuentra el código
                            codeFound = true;
                        } else {
                            cameraModalStatus.textContent += ' (No se pudo extraer datos de cédula)';
                            console.warn("PDF417 leído, pero no se pudo extraer datos de cédula con la lógica actual.");
                        }
                    }
                } catch (error) {
                    // console.warn("No se detectó PDF417 o error de lectura:", error);
                    // No es un error crítico si no se encuentra un código en cada frame
                }

                // Si no se encontró PDF417, intentar con QR (opcional, ya que las cédulas no usan QR)
                if (!codeFound) {
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    if (qrCode) {
                        console.log("Código QR detectado (texto bruto):", qrCode.data);
                        cameraModalStatus.textContent = `Código QR detectado (bruto): ${qrCode.data.substring(0, 50)}...`; // Mostrar parte del texto bruto
                        try {
                            const cedulaData = parseCedulaDataFromQR(qrCode.data);
                            if (cedulaData) {
                                populateFormFromCedulaData(cedulaData);
                                closeCameraModal(); // Cierra el modal cuando se encuentra el código
                                codeFound = true;
                            } else {
                                cameraModalStatus.textContent += ' (No se pudo extraer datos de cédula)';
                                console.warn("QR leído, pero no se pudo extraer datos de cédula con la lógica actual.");
                            }
                        } catch (e) {
                            console.error("Error al procesar el código QR:", e);
                            cameraModalStatus.textContent = 'Error al procesar el código QR.';
                        }
                    }
                }

                if (!codeFound) {
                    cameraModalStatus.textContent = 'No se detectó código de barras. Enfoca bien.';
                }
            }
            if (cameraStream && !codeFound) { // Continuar el bucle solo si la cámara está activa y no se ha encontrado un código
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        // Función ficticia para parsear datos de cédula de un QR (solo para demostración)
        function parseCedulaDataFromQR(qrData) {
            // NOTA IMPORTANTE: La cédula colombiana no usa códigos QR para los datos principales.
            // Esta función es solo para fines ilustrativos si se encontrara un QR en otro contexto.
            // Para una cédula real, el PDF417 es el código relevante.

            // Ejemplo: si el QR contiene "CC|123456789|Juan|Perez"
            const parts = qrData.split('|');
            if (parts.length >= 4 && parts[0] === 'CC') {
                return {
                    tipoIdentificacion: parts[0],
                    identificacion: parts[1],
                    primerNombre: parts[2],
                    primerApellido: parts[3]
                };
            }
            return null;
        }

        // Función para parsear datos de cédula de un PDF417
        // NOTA CRÍTICA: La estructura de datos del PDF417 de la cédula colombiana es específica, compleja y propietaria.
        // Este es un ejemplo SIMULADO basado en un posible formato simple o JSON.
        // Para una implementación real y precisa, necesitarías:
        // 1. La especificación oficial del formato de datos del PDF417 de la cédula colombiana.
        // 2. Un algoritmo de parsing que pueda decodificar esa estructura binaria/de texto comprimida.
        // 3. Posiblemente, librerías o APIs especializadas para el OCR/lectura de cédulas.
        function parseCedulaDataFromPDF417(pdf417Data) {
            console.log("Intentando parsear datos PDF417:", pdf417Data);

            // --- EJEMPLO SIMULADO DE PARSEO ---
            // Esto NO funcionará con una cédula colombiana real sin la especificación exacta.
            // Si el PDF417 contuviera un JSON simple (poco probable para cédulas):
            try {
                const parsedJson = JSON.parse(pdf417Data);
                if (parsedJson.id && parsedJson.firstName && parsedJson.lastName) {
                    console.log("PDF417 parseado como JSON (simulado).");
                    return {
                        tipoIdentificacion: parsedJson.idType || 'CC',
                        identificacion: parsedJson.id,
                        primerNombre: parsedJson.firstName,
                        segundoNombre: parsedJson.middleName || '',
                        primerApellido: parsedJson.lastName,
                        segundoApellido: parsedJson.secondLastName || ''
                    };
                }
            } catch (e) {
                // console.warn("PDF417 no es un JSON válido o no contiene las claves esperadas.");
            }

            // Si el PDF417 contuviera un formato simple delimitado por '|' (poco probable para cédulas):
            const parts = pdf417Data.split('|');
            if (parts.length >= 4) {
                console.log("PDF417 parseado por delimitador '|' (simulado).");
                return {
                    tipoIdentificacion: 'CC', // Asumimos Cédula de Ciudadanía
                    identificacion: parts[0] || '',
                    primerNombre: parts[1] || '',
                    segundoNombre: parts[2] || '',
                    primerApellido: parts[3] || '',
                    segundoApellido: parts[4] || '' // Puede que no siempre esté
                };
            }

            // Si no se pudo parsear con las simulaciones, retorna null
            console.log("No se pudo parsear el PDF417 con la lógica simulada.");
            return null;
        }


        // --- Lógica del Modal de PDF ---

        readCedulaPdfButton.addEventListener('click', () => {
            pdfModal.classList.add('show');
            pdfUploadInput.value = ''; // Limpiar el input de archivo
            pdfModalStatus.textContent = 'Carga un archivo PDF.';
            pdfPreview.style.display = 'none'; // Ocultar previsualización
            pdfPreview.src = '';
        });

        closePdfModalButton.addEventListener('click', hidePdfModal);
        cancelPdfReadButton.addEventListener('click', hidePdfModal);
        pdfModal.addEventListener('click', (e) => {
            if (e.target === pdfModal) {
                hidePdfModal();
            }
        });

        function hidePdfModal() {
            pdfModal.classList.remove('show');
            pdfUploadInput.value = '';
            pdfModalStatus.textContent = '';
            pdfPreview.style.display = 'none';
            pdfPreview.src = '';
        }

        pdfUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                pdfModalStatus.textContent = 'Ningún archivo seleccionado.';
                return;
            }

            if (file.type !== 'application/pdf') {
                pdfModalStatus.textContent = 'Por favor, selecciona un archivo PDF válido.';
                showStatusMessage('Archivo no es PDF.', 'error');
                return;
            }

            pdfModalStatus.textContent = 'Leyendo PDF...';
            pdfPreview.style.display = 'block';
            pdfPreview.src = URL.createObjectURL(file); // Mostrar previsualización del PDF

            const reader = new FileReader();
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                try {
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let codeFoundInPdf = false;

                    // Iterar sobre las páginas para intentar leer PDF417 de las imágenes
                    for (let i = 1; i <= pdf.numPages; i++) {
                        pdfModalStatus.textContent = `Procesando página ${i} de ${pdf.numPages}...`;
                        const page = await pdf.getPage(i);

                        // Renderizar la página a un canvas temporal
                        const viewport = page.getViewport({ scale: 2.0 }); // Aumentar escala para mejor detección
                        const tempCanvas = document.createElement('canvas');
                        const tempContext = tempCanvas.getContext('2d');
                        tempCanvas.height = viewport.height;
                        tempCanvas.width = viewport.width;

                        await page.render({ canvasContext: tempContext, viewport: viewport }).promise;

                        // Obtener los datos de la imagen del canvas
                        const imageData = tempContext.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

                        // Intentar decodificar PDF417 de la imagen de la página
                        try {
                            const pdf417Result = await pdf417Reader.decodeFromImageData(imageData);
                            if (pdf417Result && pdf417Result.text) {
                                console.log(`PDF417 detectado en página ${i} (texto bruto):`, pdf417Result.text);
                                pdfModalStatus.textContent = `Código PDF417 detectado en página ${i} (bruto): ${pdf417Result.text.substring(0, 50)}...`;
                                const cedulaData = parseCedulaDataFromPDF417(pdf417Result.text);
                                if (cedulaData) {
                                    populateFormFromCedulaData(cedulaData);
                                    hidePdfModal();
                                    codeFoundInPdf = true;
                                    break; // Salir del bucle si se encontró el código
                                } else {
                                    pdfModalStatus.textContent += ' (No se pudo extraer datos de cédula)';
                                    console.warn(`PDF417 en página ${i} leído, pero no se pudo extraer datos de cédula con la lógica actual.`);
                                }
                            }
                        } catch (error) {
                            // console.warn(`No se detectó PDF417 en página ${i} o error de lectura:`, error);
                        }
                    }

                    if (!codeFoundInPdf) {
                        // Si no se encontró PDF417 en ninguna imagen, intentar extraer texto (comportamiento original)
                        pdfModalStatus.textContent = 'No se encontraron códigos PDF417 en las imágenes. Intentando extraer texto del PDF...';
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        console.log("Texto extraído del PDF:", fullText);
                        const cedulaData = parseCedulaDataFromPdfText(fullText); // Función ficticia
                        if (cedulaData) {
                            populateFormFromCedulaData(cedulaData);
                            pdfModalStatus.textContent = 'Formulario rellenado con datos del texto del PDF (simulado).';
                            hidePdfModal();
                        } else {
                            pdfModalStatus.textContent = 'No se pudieron extraer datos de cédula del texto del PDF.';
                            showStatusMessage('No se detectaron datos de cédula en el PDF.', 'error');
                        }
                    }

                } catch (error) {
                    console.error("Error al leer el PDF:", error);
                    pdfModalStatus.textContent = 'Error al leer el PDF. Asegúrate de que sea un PDF válido.';
                    showStatusMessage('Error al leer el PDF: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Función ficticia para parsear datos de cédula de texto de PDF (solo para demostración)
        function parseCedulaDataFromPdfText(text) {
            const identificacionMatch = text.match(/Identificación:\s*(\d+)/i);
            const primerNombreMatch = text.match(/Primer Nombre:\s*([A-Za-zÀ-ÿ\s]+)/i);
            const primerApellidoMatch = text.match(/Primer Apellido:\s*([A-Za-zÀ-ÿ\s]+)/i);

            const data = {};
            if (identificacionMatch && identificacionMatch[1]) {
                data.identificacion = identificacionMatch[1].trim();
                data.tipoIdentificacion = 'CC'; // Asumimos CC
            }
            if (primerNombreMatch && primerNombreMatch[1]) {
                data.primerNombre = primerNombreMatch[1].trim();
            }
            if (primerApellidoMatch && primerApellidoMatch[1]) {
                data.primerApellido = primerApellidoMatch[1].trim();
            }
            return Object.keys(data).length > 0 ? data : null;
        }


        // --- Initialization ---
        // No need to call populateSelects() here, onSnapshot listeners will handle initial population
        // and subsequent real-time updates.
        // The defaultIbcDocRef.onSnapshot will also load the default IBC value on page load.


    </script>

</body>
</html>
