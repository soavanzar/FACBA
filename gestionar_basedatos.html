<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Base de Datos - FACBA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>


    <style>
        /* Estilos CSS personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f2f2f7; /* Fondo gris muy claro */
            color: #1c1c1e; /* Color de texto oscuro por defecto */
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative; /* Necesario para posicionar los botones superiores */
        }

        .container {
            background-color: #ffffff; /* Fondo blanco para el contenedor */
            padding: 30px;
            border-radius: 12px; /* Bordes redondeados */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* Sombra suave */
            max-width: 1200px; /* Ancho máximo para la tabla */
            margin: 20px auto; /* Centra el contenedor y añade margen */
            position: relative; /* Necesario para el contexto del botón de atrás */
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #d1d5db; /* Gris claro */
            color: #1f2937; /* Gris oscuro */
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background-color: #9ca3af; /* Gris más oscuro */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Contenedor para los iconos superiores */
        .top-icons {
            position: absolute; /* Posicionamiento absoluto */
            top: 20px; /* Ajusta según sea necesario */
            right: 30px; /* Ajusta según sea necesario */
            display: flex; /* Usa flexbox para alinear los iconos */
            gap: 15px; /* Espacio entre iconos */
            z-index: 10; /* Asegura que esté por encima del contenido */
        }

        /* Estilo para el icono de configuración */
        .settings-button,
        .chat-button { /* Aplica estilos comunes a ambos iconos */
            font-size: 2.5rem; /* Tamaño del icono (ajustado para ser más grande) */
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .settings-button {
            color: #4b5563; /* Color gris oscuro para la tuerca */
        }

        .settings-button:hover {
            color: #1f2937; /* Gris más oscuro al pasar el ratón */
            transform: rotate(15deg); /* Pequeña rotación al pasar el ratón */
        }

         /* Estilo para el nuevo icono de chat */
         .chat-button {
             color: #3b82f6; /* Color azul para el chat */
         }

         .chat-button:hover {
             color: #2563eb; /* Azul más oscuro al pasar el ratón */
             transform: scale(1.1); /* Ligeramente más grande al pasar el ratón */
         }


        .filter-buttons {
            margin-bottom: 15px; /* Espacio entre los botones de filtro y la barra de búsqueda */
            display: flex; /* Usa flexbox para alinear los botones */
            gap: 10px; /* Espacio entre botones */
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
        }

        .filter-button {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #d1d5db; /* Borde sutil */
            background-color: #f9fafb; /* Fondo muy claro */
            color: #374151; /* Texto gris oscuro */
        }

        .filter-button:hover {
             background-color: #e5e7eb; /* Fondo gris al pasar el ratón */
        }

        .filter-button.active {
            background-color: #4f46e5; /* Color azul/morado para el botón activo */
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2); /* Sombra para el botón activo */
        }


        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* --- Estilos de Tabla con CSS Grid (Vista de Escritorio) --- */

        .user-table {
            width: 100%;
            border-collapse: collapse; /* Elimina el espacio entre bordes */
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Sombra suave para la tabla */
            display: grid; /* <<-- MODIFICACION AQUI: Usar Grid para la tabla */
            grid-template-columns: repeat(9, 1fr); /* <<-- MODIFICACION AQUI: 9 columnas flexibles */
            /* Definir áreas para thead y tbody */
            grid-template-areas:
                "header header header header header header header header header"
                "body body body body body body body body body";
            /* Asegurar que las filas no creen sus propios contextos de grid/flex */
             grid-auto-rows: auto; /* Ajustar altura de filas automáticamente */
        }

        .user-table thead {
            display: contents; /* <<-- MODIFICACION AQUI: Permite que los th sean items del grid de la tabla */
             grid-area: header; /* Asignar a la área de encabezado */
        }

        .user-table tbody {
            display: contents; /* <<-- MODIFICACION AQUI: Permite que los td sean items del grid de la tabla */
             grid-area: body; /* Asignar a la área del cuerpo */
        }

        .user-table tr {
             display: contents; /* <<-- MODIFICACION AQUI: Permite que los th/td sean items del grid de thead/tbody */
        }


        .user-table th,
        .user-table td {
            padding: 12px 15px; /* Espaciado interno */
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Borde inferior para filas */
            /* Eliminar estilos de tabla nativos que no aplican a grid items */
            display: block; /* Asegura que sean bloques dentro del grid */
        }

        .user-table th {
            background-color: #eef2ff; /* Fondo azul/morado muy claro para encabezados */
            color: #1f2937; /* Texto oscuro */
            font-weight: 600;
            text-transform: uppercase; /* Texto en mayúsculas */
            font-size: 0.9rem;
             /* Asegurar que los th se alineen con las columnas del grid */
             grid-column: span 1;
             /* Añadir borde derecho a los encabezados */
             border-right: 1px solid #d1d5db; /* Borde derecho */
        }
         .user-table th:last-child {
             border-right: none; /* Sin borde derecho en el último encabezado */
         }


        .user-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* Fondo ligeramente diferente para filas pares (efecto cebra) */
        }

        .user-table tbody tr:hover {
            background-color: #e5e7eb; /* Fondo gris claro al pasar el ratón */
            transition: background-color 0.2s ease-in-out;
        }

        .user-table td {
            font-size: 0.95rem; /* Tamaño de fuente por defecto para escritorio */
            color: #374151; /* Texto gris oscuro */
             /* Asegurar que los td se alineen con las columnas del grid */
             grid-column: span 1;
             /* Añadir borde derecho a las celdas */
             border-right: 1px solid #e5e7eb; /* Borde derecho */
        }
         .user-table td:last-child {
             border-right: none; /* Sin borde derecho en la última celda */
         }


        /* Estilos para las celdas de acciones */
        .action-cell {
            text-align: center; /* Centra el contenido en la celda de acciones */
            position: relative; /* Necesario para posicionar los botones de acción */
            /* Asegurar que la tuerca esté visible por defecto */
            display: flex; /* Usar flexbox para alinear la tuerca */
            justify-content: center; /* Centrar la tuerca */
            align-items: center; /* Alinear la tuerca verticalmente */
        }

        .action-cell .action-buttons-container {
             display: none; /* Oculto por defecto */
             position: absolute; /* Posicionamiento absoluto */
             top: 50%; /* Centrar verticalmente */
             left: 50%; /* Centrar horizontalmente */
             transform: translate(-50%, -50%); /* Ajustar para centrado exacto */
             background-color: #ffffff; /* Fondo blanco */
             padding: 8px; /* Espaciado interno */
             border-radius: 8px; /* Bordes redondeados */
             box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Sombra */
             z-index: 20; /* Asegura que esté por encima de otros elementos de la tabla */
             white-space: nowrap; /* Evita que los botones se rompan */
             gap: 8px; /* Espacio entre botones */
             align-items: center; /* Centra los botones verticalmente */
        }

         .action-cell .action-buttons-container.show {
             display: flex; /* Mostrar cuando tiene la clase 'show' */
         }

        .action-button {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
            border: none; /* Sin borde por defecto */
            color: white; /* Letra blanca para todos los action-button */
        }

        .action-button i {
             margin-right: 4px; /* Espacio entre icono y texto */
        }

        .edit-button {
            background-color: #60a5fa; /* Azul */
        }
        .edit-button:hover {
            background-color: #3b82f6; /* Azul más oscuro */
        }

        .delete-button {
            background-color: #f87171; /* Rojo */
        }
        .delete-button:hover {
            background-color: #ef4444; /* Rojo más oscuro */
        }

        .status-button {
            background-color: #a78bfa; /* Morado */
        }
        .status-button:hover {
            background-color: #8b5cf6; /* Morado más oscuro */
        }

         /* NUEVOS ESTILOS PARA BOTONES DE PAGO Y FACTURACIÓN */
         .add-payment-button {
             background-color: #10b981; /* Verde */
         }
         .add-payment-button:hover {
             background-color: #059669; /* Verde más oscuro */
         }

         .billing-button {
             background-color: #3b82f6; /* Azul */
         }
         .billing-button:hover {
             background-color: #2563eb; /* Azul más oscuro */
         }
         /* FIN NUEVOS ESTILOS */


         /* Estilo para el icono de tuerca */
         .gear-icon {
             font-size: 1.2rem; /* Tamaño del icono */
             color: #6b7280; /* Color gris */
             cursor: pointer;
             transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
             display: inline-block; /* Asegurar que la tuerca se muestre por defecto */
         }

         .gear-icon:hover {
             color: #1f2937; /* Gris más oscuro al pasar el ratón */
             transform: rotate(90deg); /* Rotar al pasar el ratón */
         }

         /* Estilos para los iconos de estado (chulo/cruz) */
         .status-icon {
             font-size: 1.2rem; /* Tamaño del icono */
             vertical-align: middle; /* Alinea verticalmente con el texto si lo hay */
             margin: 0 auto; /* Centra si la celda lo permite */
             display: block; /* Asegura que ocupe su propio espacio para centrar */
             width: fit-content; /* Ajusta el ancho al contenido */
             cursor: pointer; /* Add cursor pointer to indicate it's clickable */
         }

         .text-green-500 { color: #10b981; /* Verde */ }
         .text-red-500 { color: #ef4444; /* Rojo */ }


        /* Estilos para los modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente más oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px; /* Ancho máximo del modal */
            position: relative;
            max-height: 90vh; /* Altura máxima para scroll */
            overflow-y: auto; /* Habilita scroll si el contenido es largo */
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #9ca3af; /* Gris */
            transition: color 0.2s ease-in-out;
        }

        .modal-close-button:hover {
            color: #6b7280; /* Gris más oscuro */
        }

        .modal-content h2 {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
            color: #1f2937;
        }

        .modal-form-group {
            margin-bottom: 18px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .modal-form-group input[type="text"],
        .modal-form-group input[type="number"],
        .modal-form-group input[type="date"],
        .modal-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box;
        }

         .modal-form-group input:focus,
         .modal-form-group select:focus {
             outline: none;
             border-color: #4f46e5;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
         }


        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
        }

        .save-changes-button {
            background-color: #10b981; /* Verde */
            color: white;
        }
        .save-changes-button:hover {
            background-color: #059669; /* Verde más oscuro */
        }

        .cancel-button {
            background-color: #9ca3af; /* Gris */
            color: white;
        }
        .cancel-button:hover {
            background-color: #6b7280; /* Gris más oscuro */
        }

        /* Estilos para mensajes de estado (el pequeño, si se sigue usando) */
        #status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-in-out;
        }

        #status-message.success {
            background-color: #d4edda; /* Verde claro */
            color: #155724; /* Verde oscuro */
            border: 1px solid #c3e6cb;
            opacity: 1;
            transform: translateY(0);
        }

        #status-message.error {
            background-color: #f8d7da; /* Rojo claro */
            color: #721c24; /* Rojo oscuro */
            border: 1px solid #f5c6cb;
            opacity: 1;
            transform: translateY(0);
        }

        #status-message.info {
            background-color: #cce5ff; /* Azul claro */
            color: #004085; /* Azul oscuro */
            border: 1px solid #b8daff;
            opacity: 1;
            transform: translateY(0);
        }

        /* --- NUEVOS ESTILOS PARA EL MENSAJE GRANDE Y ANIMADO --- */
        #large-status-message {
            position: fixed; /* Posición fija para estar siempre visible */
            top: 50%; /* Centrar verticalmente */
            left: 50%; /* Centrar horizontalmente */
            transform: translate(-50%, -50%); /* Centrar */
            padding: 30px 40px; /* Espaciado interno generoso */
            border-radius: 15px; /* Bordes muy redondeados */
            font-size: 1.8rem; /* Tamaño de fuente grande */
            font-weight: 700; /* Peso de fuente negrita */
            color: white; /* Texto blanco */
            text-align: center; /* Centrar texto */
            z-index: 2000; /* Asegurar que esté por encima de todo lo demás */
            opacity: 0; /* Empezar invisible */
            visibility: hidden; /* Ocultar completamente cuando no está visible */
            /* Transición simplificada */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); /* Sombra pronunciada */
            min-width: 300px; /* Ancho mínimo */
            max-width: 90%; /* Ancho máximo en pantallas pequeñas */
        }

        #large-status-message.show {
            opacity: 1; /* Mostrar */
            visibility: visible; /* Hacer visible */
            /* Eliminar la escala inicial para simplificar */
            transform: translate(-50%, -50%);
        }

        #large-status-message.success {
            background-color: #10b981; /* Verde */
        }

        #large-status-message.error {
            background-color: #ef4444; /* Rojo */
        }

        #large-status-message.info {
             background-color: #3b82f6; /* Azul para info */
        }

        /* --- FIN NUEVOS ESTILOS --- */


        /* --- Estilos Responsivos para la Tabla (Vista de Tarjeta en Móviles) --- */

        /* Aplicar estilos solo en pantallas pequeñas (menos de 768px, breakpoint 'md' de Tailwind) */
        @media (max-width: 767px) {
            .user-table {
                 display: block; /* <<-- MODIFICACION AQUI: Volver a block en móvil */
                 grid-template-columns: none; /* <<-- MODIFICACION AQUI: Eliminar columnas de grid */
                 grid-template-areas: none; /* <<-- MODIFICACION AQUI: Eliminar áreas de grid */
                 box-shadow: none; /* <<-- MODIFICACION AQUI: Eliminar sombra de tabla en móvil */
            }

            .user-table thead {
                display: none; /* Ocultar encabezados de tabla */
            }

            .user-table tbody {
                 display: block; /* <<-- MODIFICACION AQUI: Volver a block en móvil */
            }

            .user-table tr {
                display: block; /* Hacer que los elementos de la tabla se comporten como bloques */
                width: 100%; /* Ocupar todo el ancho */
                margin-bottom: 20px; /* Más espacio entre filas apiladas (tarjetas) */
                border: 1px solid #d1d5db; /* Borde alrededor de cada "tarjeta" de fila */
                border-radius: 10px; /* Bordes más redondeados */
                background-color: #ffffff; /* Fondo blanco para cada fila */
                box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Sombra suave */
                padding: 15px; /* Espaciado interno dentro de la tarjeta */
            }

            .user-table td {
                display: flex; /* Usar Flexbox para cada celda */
                justify-content: space-between; /* Espacio entre la etiqueta y el valor */
                align-items: center; /* Alinear elementos verticalmente */
                padding: 8px 15px; /* Espaciado interno para las celdas */
                position: relative; /* Para posicionar la etiqueta */
                border-bottom: 1px dashed #e5e7eb; /* Borde inferior punteado */
                font-size: 0.9rem; /* Reducir tamaño de fuente para móviles */
                border-right: none; /* <<-- MODIFICACION AQUI: Eliminar borde derecho en móvil */
            }

             .user-table td:last-child {
                 border-bottom: none; /* No borde inferior en la última celda */
                 padding-bottom: 0; /* Eliminar padding inferior en la última celda */
                 margin-top: 15px; /* Espacio encima de los botones de acción */
             }


            .user-table td::before {
                content: attr(data-label); /* Mostrar el contenido del atributo data-label */
                flex-basis: 120px; /* Base inicial de 120px */
                flex-shrink: 0; /* Evitar que se encoja */
                padding-right: 10px; /* Espacio entre etiqueta y contenido */
                font-weight: 600; /* Peso de fuente semibold para la etiqueta */
                color: #4b5563; /* Color gris oscuro para la etiqueta */
                text-align: left; /* Alinear etiqueta a la izquierda */
                position: static; /* Posicionamiento estático */
                transform: none; /* Eliminar transformación */
            }

            /* Ajuste específico para la celda de acciones */
            .action-cell {
                 display: block; /* Volver a block para la celda de acciones */
                 text-align: center; /* Centrar el contenido en la celda de acciones */
                 padding-left: 15px; /* Mantener padding izquierdo */
            }

             .action-cell::before {
                 content: ''; /* No mostrar etiqueta para la celda de acciones */
                 display: none; /* Ocultar el before en la celda de acciones */
             }

             /* Asegurar que los botones de acción estén bien espaciados en la vista de tarjeta */
             .action-cell .action-buttons-container {
                 position: static; /* Posicionamiento estático en móvil */
                 transform: none; /* Eliminar transformación */
                 display: flex; /* Mostrar siempre en móvil si la tuerca se clickea */
                 justify-content: center; /* Centrar los botones */
                 gap: 10px; /* Espacio entre botones */
                 background-color: transparent; /* Fondo transparente */
                 box-shadow: none; /* Sin sombra */
                 padding: 0; /* Sin padding */
                 margin-top: 10px; /* Espacio encima de los botones */
             }
             /* En móvil, la tuerca se ocultará y los botones se mostrarán directamente */
             .action-cell .gear-icon {
                 display: none; /* Ocultar la tuerca en móvil cuando se activa */
             }
             .action-cell .action-buttons-container.show + .gear-icon {
                 display: none; /* Ocultar la tuerca cuando los botones se muestran */
             }
             .action-cell .action-buttons-container:not(.show) {
                 display: none; /* Asegurar que los botones estén ocultos por defecto en móvil */
             }
             .action-cell .action-buttons-container:not(.show) + .gear-icon {
                 display: inline-block; /* Mostrar la tuerca en móvil por defecto */
             }


        }

         /* Asegurar que los modales se vean bien en pantallas pequeñas */
         @media (max-width: 600px) {
             .modal-content {
                 padding: 20px; /* Reducir padding en pantallas muy pequeñas */
             }

             .modal-content h2 {
                 font-size: 1.5rem; /* Reducir tamaño del título del modal */
             }

             .modal-buttons {
                 flex-direction: column; /* Apilar botones en pantallas muy pequeñas */
                 gap: 8px; /* Reducir espacio entre botones apilados */
             }

             .modal-buttons button {
                 width: 100%; /* Hacer que los botones apilados ocupen todo el ancho */
             }
         }

         /* Estilos para el modal de configuración/menú */
         #settings-modal .modal-content {
             max-width: 350px; /* Ancho más pequeño para el modal de menú */
         }

         #settings-modal .menu-option-button {
             display: block; /* Cada opción como un bloque */
             width: 100%; /* Ocupa todo el ancho */
             padding: 12px 15px; /* Espaciado interno */
             margin-bottom: 10px; /* Espacio entre opciones */
             background-color: #eef2ff; /* Fondo azul/morado muy claro */
             color: #1f2937; /* Texto oscuro */
             font-weight: 500; /* Peso de fuente medio */
             border: none;
             border-radius: 6px;
             text-align: left; /* Alinear texto a la izquierda */
             cursor: pointer;
             transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
         }

         #settings-modal .menu-option-button:hover {
             background-color: #dadaff; /* Fondo un poco más oscuro al pasar el ratón */
             transform: translateX(5px); /* Mover ligeramente a la derecha */
         }

         #settings-modal .menu-option-button:last-child {
             margin-bottom: 0; /* Sin margen inferior en el último botón */
         }

         #settings-modal .modal-buttons {
             margin-top: 20px; /* Espacio encima de los botones de acción del modal */
         }

         /* Estilos para el modal genérico de agregar entidad */
         #add-entity-modal .modal-content {
             max-width: 400px; /* Ancho adecuado para el formulario simple */
         }

         /* Estilos para el nuevo modal genérico de gestión de entidades */
         #manage-entity-modal .modal-content {
             max-width: 500px; /* Ancho adecuado para la lista */
         }

         #manage-entity-modal .entity-list {
             list-style: none;
             padding: 0;
             margin: 0;
         }

         #manage-entity-modal .entity-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 10px 0;
             border-bottom: 1px solid #e5e7eb;
         }

         #manage-entity-modal .entity-item:last-child {
             border-bottom: none;
         }

         #manage-entity-modal .entity-name {
             flex-grow: 1; /* Permite que el nombre ocupe el espacio disponible */
             margin-right: 10px; /* Espacio entre el nombre y el botón */
             font-size: 1rem;
             color: #374151;
         }

         #manage-entity-modal .delete-entity-button {
             background-color: #f87171; /* Rojo */
             color: white;
             padding: 5px 10px;
             border-radius: 4px;
             font-size: 0.8rem;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             border: none;
         }

         #manage-entity-modal .delete-entity-button:hover {
             background-color: #ef4444; /* Rojo más oscuro */
         }

         #manage-entity-modal .add-new-button-container {
             margin-top: 20px;
             text-align: center;
         }

         #manage-entity-modal .add-new-button {
             background-color: #10b981; /* Verde */
             color: white;
             padding: 10px 15px;
             border-radius: 8px;
             font-weight: 600;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             border: none;
         }

         #manage-entity-modal .add-new-button:hover {
             background-color: #059669; /* Verde más oscuro */
         }

         /* Estilos para el modal de Importar Usuarios */
         #import-users-modal .modal-content {
             max-width: 450px; /* Ancho adecuado */
         }

         #import-users-modal input[type="file"] {
             display: block; /* Asegura que ocupe su propia línea */
             width: 100%;
             padding: 10px;
             border: 1px solid #d1d5db;
             border-radius: 6px;
             font-size: 1rem;
             box-sizing: border-box;
             margin-bottom: 15px; /* Espacio debajo del input */
         }

         #import-users-modal .import-instructions {
             font-size: 0.9rem;
             color: #4b5563;
             margin-bottom: 20px;
             padding: 10px;
             background-color: #f9fafb;
             border-left: 4px solid #4f46e5;
             border-radius: 4px;
         }

         #import-users-modal .import-instructions strong {
             color: #1f2937;
         }

         /* Estilos para el mensaje temporal de tooltip en click */
         .click-tooltip-message {
             position: fixed; /* Fixed position to float over content */
             top: 20px; /* Position from the top */
             left: 50%; /* Center horizontally */
             transform: translateX(-50%); /* Adjust for exact centering */
             background-color: rgba(0, 0, 0, 0.8); /* Dark background */
             color: white; /* White text */
             padding: 10px 15px;
             border-radius: 8px;
             font-size: 0.9rem;
             z-index: 1001; /* Ensure it's above modals */
             opacity: 0; /* Start hidden */
             visibility: hidden;
             transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
             max-width: 90%; /* Max width on small screens */
             text-align: center;
         }

         .click-tooltip-message.show {
             opacity: 1;
             visibility: visible;
         }

         /* Estilos específicos para los nuevos modales de Pago y Facturación */
         #add-payment-modal .modal-content,
         #billing-modal .modal-content,
         #payment-history-modal .modal-content,
         #invoice-history-modal .modal-content,
         #edit-payment-modal .modal-content, /* NUEVO: Modal de edición de pago */
         #edit-invoice-modal .modal-content /* NUEVO: Modal de edición de factura */
         {
             max-width: 600px; /* Aumentar ancho para formularios/historiales */
         }

         #payment-history-list,
         #invoice-history-list,
         #full-payment-history-list, /* NUEVO: Lista en modal de historial completo */
         #full-invoice-history-list /* NUEVO: Lista en modal de historial completo */
         {
             list-style: none;
             padding: 0;
             margin-top: 20px;
             border-top: 1px solid #e5e7eb;
         }

         #payment-history-list li,
         #invoice-history-list li,
         #full-payment-history-list li, /* NUEVO */
         #full-invoice-history-list li /* NUEVO */
         {
             padding: 10px 0;
             border-bottom: 1px solid #e5e7eb;
             font-size: 0.95rem;
             color: #374151;
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
         }

         #payment-history-list li:last-child,
         #invoice-history-list li:last-child,
         #full-payment-history-list li:last-child, /* NUEVO */
         #full-invoice-history-list li:last-child /* NUEVO */
         {
             border-bottom: none;
         }

         #payment-history-list li span,
         #invoice-history-list li span,
         #full-payment-history-list li span, /* NUEVO */
         #full-invoice-history-list li span /* NUEVO */
         {
             margin-right: 15px; /* Espacio entre elementos */
         }

         /* Estilos para la sección de historial dentro de los modales */
         .history-section {
             margin-top: 25px;
             padding-top: 15px;
             border-top: 1px solid #d1d1db; /* Cambio de color para diferenciar */
         }

         .history-section h3 {
             font-size: 1.2rem;
             font-weight: 600;
             margin-bottom: 15px;
             color: #1f2937;
         }

         /* Estilos para el área de visualización de factura generada */
         #generated-invoice-details {
             margin-top: 20px;
             padding: 15px;
             border: 1px dashed #d1d5db;
             border-radius: 8px;
             background-color: #f9fafb;
             min-height: 150px; /* Altura mínima */
             white-space: pre-wrap; /* Respeta saltos de línea y espacios */
             font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; /* Fuente monoespaciada */
             font-size: 0.9rem;
             color: #374151;
             overflow-x: auto; /* Permite scroll horizontal si es necesario */
         }

         #generated-invoice-details strong {
             color: #1f2937;
         }

         /* Estilos para los botones específicos de facturación */
         .billing-buttons {
             display: flex;
             justify-content: flex-end;
             gap: 10px;
             margin-top: 20px;
         }

         .billing-buttons button {
             padding: 8px 15px;
             border-radius: 6px;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             border: none;
         }

         /* Aplicar estilos de action-button a los botones específicos */
         .generate-invoice-button.action-button {
             background-color: #10b981; /* Verde */
             color: white; /* Texto blanco */
         }
         .generate-invoice-button.action-button:hover {
             background-color: #059669; /* Verde más oscuro */
         }

         .save-invoice-button.action-button {
             background-color: #10b981; /* Verde */
             color: white; /* Texto blanco */
         }
         .save-invoice-button.action-button:hover {
             background-color: #059669; /* Verde más oscuro */
         }

         .view-invoices-button.action-button {
             background-color: #6366f1; /* Indigo */
             color: white; /* Texto blanco */
         }
         .view-invoices-button.action-button:hover {
             background-color: #4f46e5; /* Indigo más oscuro */
         }

         .generate-pdf-button.action-button {
             background-color: #ef4444; /* Rojo */
             color: white; /* Texto blanco */
         }
         .generate-pdf-button.action-button:hover {
             background-color: #dc2626; /* Rojo más oscuro */
         }

         /* Estilos para la lista de historial de facturas */
         #invoice-history-list li,
         #full-invoice-history-list li /* NUEVO */
         {
             flex-direction: column; /* Apilar elementos en cada item de factura */
             align-items: flex-start; /* Alinear a la izquierda */
             position: relative; /* Necesario para posicionar la tuerca/botones */
             padding-right: 40px; /* Espacio para la tuerca/botones */
         }

         #invoice-history-list li .invoice-summary,
         #full-invoice-history-list li .invoice-summary /* NUEVO */
         {
             width: 100%; /* Ocupar todo el ancho */
             margin-bottom: 10px; /* Espacio debajo del resumen */
         }

         /* Contenedor de acciones dentro de los items de historial de factura */
         #invoice-history-list li .invoice-actions,
         #full-invoice-history-list li .invoice-actions /* NUEVO */
         {
             display: none; /* Oculto por defecto */
             position: absolute; /* Posicionamiento absoluto */
             top: 50%; /* Centrar verticalmente */
             right: 5px; /* Posicionar a la derecha */
             transform: translateY(-50%); /* Ajustar para centrado exacto */
             background-color: #ffffff; /* Fondo blanco */
             padding: 5px; /* Espaciado interno */
             border-radius: 6px; /* Bordes redondeados */
             box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Sombra */
             z-index: 10; /* Asegura que esté por encima del contenido de la lista */
             white-space: nowrap; /* Evita que los botones se rompan */
             gap: 5px; /* Espacio entre botones */
             align-items: center; /* Centra los botones verticalmente */
         }

         #invoice-history-list li .invoice-actions.show,
         #full-invoice-history-list li .invoice-actions.show /* NUEVO */
         {
             display: flex; /* Mostrar cuando tiene la clase 'show' */
             opacity: 1; /* Asegurar opacidad 1 */
             visibility: visible; /* Asegurar visibilidad */
         }

         #invoice-history-list li .invoice-actions button,
         #full-invoice-history-list li .invoice-actions button /* NUEVO */
         {
             padding: 5px 10px;
             font-size: 0.85rem;
         }

         /* Icono de tuerca dentro de los items de historial de factura */
         #invoice-history-list li .gear-icon,
         #full-invoice-history-list li .gear-icon /* NUEVO */
         {
             position: absolute; /* Posicionamiento absoluto */
             top: 50%; /* Centrar verticalmente */
             right: 10px; /* Posicionar a la derecha */
             transform: translateY(-50%); /* Ajustar para centrado exacto */
             font-size: 1.2rem; /* Tamaño del icono */
             color: #6b7280; /* Color gris */
             cursor: pointer;
             transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
             z-index: 11; /* Asegura que esté por encima del contenedor de acciones (cuando está oculto) */
         }

         #invoice-history-list li .gear-icon:hover,
         #full-invoice-history-list li .gear-icon:hover /* NUEVO */
         {
             color: #1f2937; /* Gris más oscuro al pasar el ratón */
             transform: translateY(-50%) rotate(90deg); /* Rotar al pasar el ratón */
         }


         /* NUEVOS ESTILOS: Botones de acción en listas de historial */
         .history-item-actions {
             display: flex;
             gap: 8px; /* Espacio entre botones */
             align-items: center;
             margin-left: auto; /* Empuja los botones a la derecha */
         }

         .history-item-actions .action-button {
             padding: 4px 8px; /* Padding más pequeño para botones en lista */
             font-size: 0.75rem; /* Tamaño de fuente más pequeño */
             /* Asegurar que el color del texto sea visible */
             color: white; /* Mantener blanco por defecto, pero asegurar contraste con background */
         }

         /* Estilos específicos para los botones de editar y eliminar en las listas de historial */
         .history-item-actions .edit-payment-button,
         .history-item-actions .edit-invoice-button {
              background-color: #60a5fa; /* Azul */
         }
         .history-item-actions .edit-payment-button:hover,
         .history-item-actions .edit-invoice-button:hover {
              background-color: #3b82f6; /* Azul más oscuro */
         }

         .history-item-actions .delete-payment-button,
         .history-item-actions .delete-invoice-button {
              background-color: #f87171; /* Rojo */
         }
         .history-item-actions .delete-payment-button:hover,
         .history-item-actions .delete-invoice-button:hover { /* CORRECCIÓN: Aplicar hover a delete-invoice-button */
              background-color: #ef4444; /* Rojo más oscuro */
         }

         .history-item-actions .view-invoice-details-button {
              background-color: #6366f1; /* Indigo */
         }
         .history-item-actions .view-invoice-details-button:hover {
              background-color: #4f46e5; /* Indigo más oscuro */
         }

         .history-item-actions .generate-invoice-pdf-button {
             background-color: #ef4444; /* Rojo */
         }
         .history-item-actions .generate-invoice-pdf-button:hover {
             background-color: #dc2626; /* Rojo más oscuro */
         }

         /* CORRECCIÓN: Asegurar opacidad 1 en hover para los action buttons en historial */
         .history-item-actions .action-button:hover {
             opacity: 1; /* Asegurar que los botones no se vuelvan transparentes al pasar el ratón */
         }


         /* Ajuste para que los detalles del pago/factura y los botones de acción estén en la misma línea si hay espacio */
         #payment-history-list li,
         #full-payment-history-list li {
             flex-direction: row; /* Volver a fila si hay espacio */
             justify-content: space-between; /* Espacio entre detalles y acciones */
             align-items: center;
         }

         #payment-history-list li span,
         #full-payment-history-list li span {
             margin-right: 10px; /* Espacio entre los spans de detalles */
             flex-shrink: 0; /* Evitar que se encojan demasiado */
         }

         #payment-history-list li .history-item-actions,
         #full-payment-history-list li .history-item-actions {
             margin-left: auto; /* Asegura que los botones estén a la derecha */
             flex-shrink: 0; /* Evitar que se encojan demasiado */
         }

         /* En pantallas pequeñas, volver a apilar */
         @media (max-width: 767px) {
              #payment-history-list li,
              #full-payment-history-list li {
                  flex-direction: column;
                  align-items: flex-start;
              }
              #payment-history-list li span,
              #full-payment-history-list li span {
                  margin-right: 0;
                  margin-bottom: 5px; /* Espacio entre detalles apilados */
              }
              #payment-history-list li .history-item-actions,
              #full-payment-history-list li .history-item-actions {
                  width: 100%; /* Ocupa todo el ancho */
                  justify-content: flex-end; /* Alinear botones a la derecha */
                  margin-top: 10px; /* Espacio encima de los botones */
              }

              /* Asegurar que los elementos de la factura se apilen correctamente en móvil */
              #invoice-history-list li,
              #full-invoice-history-list li {
                  flex-direction: column; /* Apilar */
                  align-items: flex-start; /* Alinear a la izquierda */
                   padding-right: 15px; /* Reducir padding derecho en móvil */
              }
               #invoice-history-list li .invoice-summary,
               #full-invoice-history-list li .invoice-summary {
                    margin-bottom: 10px; /* Espacio debajo del resumen */
               }
              #invoice-history-list li .invoice-actions,
              #full-invoice-history-list li .invoice-actions {
                   position: static; /* Posicionamiento estático en móvil */
                   transform: none; /* Eliminar transformación */
                   width: 100%; /* Ocupa todo el ancho */
                   justify-content: flex-end; /* Alinear botones a la derecha */
                   margin-top: 10px; /* Espacio encima de los botones */
                   background-color: transparent; /* Fondo transparente */
                   box-shadow: none; /* Sin sombra */
                   padding: 0; /* Sin padding */
              }
               #invoice-history-list li .gear-icon,
               #full-invoice-history-list li .gear-icon {
                    position: static; /* Posicionamiento estático en móvil */
                    transform: none; /* Eliminar transformación */
                    margin-left: auto; /* Empujar a la derecha */
                    margin-top: 10px; /* Espacio encima */
               }
               #invoice-history-list li .invoice-actions.show + .gear-icon,
               #full-invoice-history-list li .invoice-actions.show + .gear-icon {
                    display: none; /* Ocultar tuerca cuando botones se muestran en móvil */
               }
               #invoice-history-list li .invoice-actions:not(.show),
               #full-invoice-history-list li .invoice-actions:not(.show) {
                    display: none; /* Ocultar botones por defecto en móvil */
               }


         }

    </style>
</head>
<body>

    <div class="container">
        <a href="https://soavanzar.github.io/FACBA/inicio_base_de_datos.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Ir Atrás
        </a>

        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Gestionar Usuarios</h1>

        <div class="top-icons">
            <i class="fas fa-comment-dots chat-button" id="chat-button" title="Abrir Chat"></i> <i class="fas fa-cog settings-button" id="settings-button" title="Configuración"></i> </div>


        <div class="filter-buttons">
            <button class="filter-button active" data-filter="todos">Todos</button>
            <button class="filter-button" data-filter="activo">Activos</button>
            <button class="filter-button" data-filter="retirado">Retirados</button>
            <button class="filter-button" data-filter="empresa">Filtrar por Empresa</button>
            <button class="filter-button" data-filter="asesor">Filtrar por Asesor</button>
             <button class="filter-button" data-filter="arl">Filtrar por ARL</button> <button class="filter-button" data-filter="eps">Filtrar por EPS</button>
            <button class="filter-button" data-filter="ccf">Filtrar por CCF</button>
            <button class="filter-button" data-filter="afp">Filtrar por AFP</button>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Buscar por nombre, identificación, empresa, EPS, AFP...">
        </div>

        <div class="table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Empresa</th>
                        <th>Valor a Pagar</th>
                        <th>IBC</th>
                        <th>EPS</th>
                        <th>ARL</th>
                        <th>AFP</th>
                        <th>CCF</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    </tbody>
            </table>
        </div>

        </div>

    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-edit-modal">&times;</span>
            <h2>Editar Usuario</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id"> <div class="modal-form-group">
                    <label for="edit-nombre">Nombre:</label>
                    <input type="text" id="edit-nombre" name="nombre" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-tipo-identificacion">Tipo de Identificación:</label>
                    <select id="edit-tipo-identificacion" name="tipoIdentificacion" required>
                        <option value="">Selecciona</option>
                        <option value="CC">Cédula de Ciudadanía</option>
                        <option value="TI">Tarjeta de Identidad</option>
                        <option value="CE">Cédula de Extranjería</option>
                        <option value="PA">Pasaporte</option>
                        </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-identificacion">Identificación:</label>
                    <input type="number" id="edit-identificacion" name="identificacion" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-empresa">Empresa:</label>
                     <select id="edit-empresa" name="empresaId" required>
                         <option value="">Selecciona una empresa</option>
                         </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-arl">ARL:</label>
                     <select id="edit-arl" name="arlId">
                         <option value="">Selecciona una ARL</option>
                         </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-riesgo">Riesgo:</label>
                    <input type="text" id="edit-riesgo" name="riesgo">
                </div>

                <div class="modal-form-group">
                    <label for="edit-eps">EPS:</label>
                     <select id="edit-eps" name="epsId">
                         <option value="">Selecciona una EPS</option>
                         </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-ccf">CCF:</label>
                     <select id="edit-ccf" name="ccfId">
                         <option value="">Selecciona una CCF</option>
                         </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-afp">AFP:</label>
                     <select id="edit-afp" name="afpId">
                         <option value="">Selecciona una AFP</option>
                         </select>
                </div>


                <div class="modal-form-group">
                    <label for="edit-fecha-ingreso">Fecha de Ingreso:</label>
                    <input type="date" id="edit-fecha-ingreso" name="fecha" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-fecha-registro">Fecha de Registro Inicial:</label>
                    <input type="date" id="edit-fecha-registro" name="ingreso" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-asesor">Asesor:</label>
                     <select id="edit-asesor" name="asesorId" required>
                         <option value="">Selecciona un asesor</option>
                         </select>
                </div>

                 <div class="modal-form-group">
                    <label for="edit-valor-a-pagar">Valor a Pagar (COP):</label>
                    <input type="number" id="edit-valor-a-pagar" name="valorAPagar" step="0.01">
                </div>

                 <div class="modal-form-group">
                    <label for="edit-ibc">IBC (COP):</label>
                    <input type="number" id="edit-ibc" name="ibc" step="0.01">
                </div>


                 <div class="modal-form-group">
                    <label for="edit-estado">Estado:</label>
                    <select id="edit-estado" name="estado" required>
                        <option value="activo">Activo</option>
                        <option value="retirado">Retirado</option>
                        </select>
                </div>

                 <div class="modal-form-group" id="edit-fecha-retiro-group" style="display: none;">
                    <label for="edit-fecha-retiro">Fecha de Retiro:</label>
                    <input type="date" id="edit-fecha-retiro" name="fechaRetiro">
                </div>


                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-edit">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-filter-modal">&times;</span>
            <h2 id="filter-modal-title">Filtrar</h2>
            <div class="modal-form-group" id="filter-empresa-group" style="display: none;">
                <label for="filter-empresa-select">Seleccionar Empresa:</label>
                <select id="filter-empresa-select">
                    <option value="">Todas las Empresas</option>
                    </select>
            </div>
            <div class="modal-form-group" id="filter-asesor-group" style="display: none;">
                <label for="filter-asesor-select">Seleccionar Asesor:</label>
                <select id="filter-asesor-select">
                    <option value="">Todos los Asesores</option>
                    </select>
            </div>
            <div class="modal-form-group" id="filter-arl-group" style="display: none;">
                <label for="filter-arl-select">Seleccionar ARL:</label>
                <select id="filter-arl-select">
                    <option value="">Todas las ARL</option>
                    </select>
            </div>
            <div class="modal-form-group" id="filter-eps-group" style="display: none;">
                <label for="filter-eps-select">Seleccionar EPS:</label>
                <select id="filter-eps-select">
                    <option value="">Todas las EPS</option>
                    </select>
            </div>
             <div class="modal-form-group" id="filter-ccf-group" style="display: none;">
                <label for="filter-ccf-select">Seleccionar CCF:</label>
                <select id="filter-ccf-select">
                    <option value="">Todas las CCF</option>
                    </select>
            </div>
             <div class="modal-form-group" id="filter-afp-group" style="display: none;">
                <label for="filter-afp-select">Seleccionar AFP:</label>
                <select id="filter-afp-select">
                    <option value="">Todas las AFP</option>
                    </select>
            </div>


            <div class="modal-buttons">
                <button type="button" class="cancel-button" id="cancel-filter">Cancelar</button>
                <button type="button" class="save-changes-button" id="apply-filter">Aplicar Filtro</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close-button" id="close-settings-modal">&times;</span>
             <h2>Opciones de Configuración</h2>
             <button class="menu-option-button" data-entity-type="arl">Gestionar ARL</button> <button class="menu-option-button" data-entity-type="eps">Gestionar EPS</button>
             <button class="menu-option-button" data-entity-type="ccf">Gestionar CCF</button>
             <button class="menu-option-button" data-entity-type="afp">Gestionar AFP</button>
             <button class="menu-option-button" data-entity-type="asesor">Gestionar Asesores</button>
             <button class="menu-option-button" data-entity-type="empresa">Gestionar Empresas</button>
             <button class="menu-option-button" id="export-users-button">Exportar Usuarios a Excel</button>
             <button class="menu-option-button" id="import-users-button">Importar Usuarios desde Excel</button>

             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-settings-modal-button">Cerrar</button>
             </div>
        </div>
    </div>

    <div id="add-entity-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-add-entity-modal">&times;</span>
            <h2 id="add-entity-modal-title">Agregar Nueva Entidad</h2>
            <form id="add-entity-form">
                <input type="hidden" id="add-entity-type"> <div class="modal-form-group">
                    <label for="entity-name" class="block text-gray-700 text-sm font-semibold mb-2">Nombre:</label>
                    <input type="text" id="entity-name" name="name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-primary_blue">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-add-entity">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-entity-modal" class="modal-overlay">
         <div class="modal-content">
             <span class="modal-close-button" id="close-manage-entity-modal">&times;</span>
             <h2 id="manage-entity-modal-title">Gestionar Entidades</h2>
             <input type="hidden" id="manage-entity-type"> <ul class="entity-list" id="entity-list">
                 </ul>

             <div class="add-new-button-container">
                 <button class="add-new-button" id="open-add-from-manage-button">Agregar Nuevo</button>
             </div>

             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-manage-entity-modal-button">Cerrar</button>
             </div>
         </div>
    </div>

    <div id="import-users-modal" class="modal-overlay">
         <div class="modal-content">
             <span class="modal-close-button" id="close-import-modal">&times;</span>
             <h2>Importar Usuarios desde Excel</h2>
             <div class="import-instructions">
                 Por favor, asegúrate de que tu archivo Excel (.xlsx) tenga **exactamente** las siguientes columnas en la primera fila (el orden no importa):<br>
                 <strong>NOMBRE, TIPO DE IDENTIFICACION, IDENTIFICACION, EMPRESA, ARL, RIESGO, EPS, CCF, AFP, FECHA INGRESO, ASESOR, VALOR A PAGAR, IBC</strong> <br>
                 Si una Empresa, Asesor, ARL, EPS, CCF o AFP no existe, se creará automáticamente. Para indicar que un usuario no tiene una entidad asignada (como EPS, ARL, etc.), deja la celda correspondiente **vacía** o escribe **N/A**.
             </div>
             <input type="file" id="excel-file-input" accept=".xlsx, .xls">
             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="cancel-import">Cancelar</button>
                 <button type="button" class="save-changes-button" id="process-import-button">Procesar Importación</button>
             </div>
             <div id="import-status-message" class="mt-4 text-center text-sm text-gray-600"></div>
         </div>
    </div>

    <div id="click-tooltip-message" class="click-tooltip-message"></div>

    <div id="large-status-message"></div>
    <div id="add-payment-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-add-payment-modal">&times;</span>
            <h2>Agregar Pago</h2>
            <form id="add-payment-form">
                <input type="hidden" id="payment-user-id">
                <div class="modal-form-group">
                    <label for="payment-date">Fecha:</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="modal-form-group">
                    <label for="payment-value">Valor (COP):</label>
                    <input type="number" id="payment-value" step="0.01" required>
                </div>
                 <div class="modal-form-group">
                    <label for="payment-novelty">Novedad:</label>
                    <select id="payment-novelty" required>
                        <option value="">Selecciona</option>
                        <option value="APO">APO</option>
                        <option value="ING">ING</option>
                        <option value="RET">RET</option>
                         <option value="OTRO">OTRO</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-add-payment">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar Pago</button>
                </div>
            </form>

            <div class="history-section">
                 <h3>Historial de Pagos Recientes</h3>
                 <ul id="payment-history-list">
                     <li>Cargando historial...</li>
                 </ul>
                 <button class="view-history-button mt-4 action-button view-invoices-button" id="view-all-payments-button" style="display: none;">Ver Historial Completo</button>
            </div>
        </div>
    </div>
    <div id="payment-history-modal" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close-button" id="close-payment-history-modal">&times;</span>
             <h2 id="payment-history-modal-title">Historial de Pagos</h2>
             <ul id="full-payment-history-list">
                 <li>Cargando historial...</li>
             </ul>
             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-payment-history-modal-button">Cerrar</button>
             </div>
        </div>
    </div>
    <div id="edit-payment-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-edit-payment-modal">&times;</span>
            <h2>Editar Pago</h2>
            <form id="edit-payment-form">
                <input type="hidden" id="edit-payment-id">
                 <input type="hidden" id="edit-payment-user-id"> <div class="modal-form-group">
                    <label for="edit-payment-date">Fecha:</label>
                    <input type="date" id="edit-payment-date" required>
                </div>
                <div class="modal-form-group">
                    <label for="edit-payment-value">Valor (COP):</label>
                    <input type="number" id="edit-payment-value" step="0.01" required>
                </div>
                 <div class="modal-form-group">
                    <label for="edit-payment-novelty">Novedad:</label>
                    <select id="edit-payment-novelty" required>
                        <option value="">Selecciona</option>
                        <option value="APO">APO</option>
                        <option value="ING">ING</option>
                        <option value="RET">RET</option>
                         <option value="OTRO">OTRO</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-edit-payment">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <div id="billing-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-billing-modal">&times;</span>
            <h2>Facturación</h2>
            <form id="billing-form">
                <input type="hidden" id="billing-user-id">
                <div class="modal-form-group">
                    <label for="billing-start-date">Fecha Inicio:</label>
                    <input type="date" id="billing-start-date" required>
                </div>
                <div class="modal-form-group">
                    <label for="billing-end-date">Fecha Fin:</label>
                    <input type="date" id="billing-end-date" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="generate-invoice-button action-button" id="generate-invoice-button">Generar Factura</button>
                </div>
            </form>

            <div class="history-section" id="generated-invoice-section" style="display: none;">
                 <h3>Detalles de Factura Generada</h3>
                 <div id="generated-invoice-details">
                     </div>
                 <div class="billing-buttons">
                      <button type="button" class="save-invoice-button action-button" id="save-invoice-button" style="display: none;">Guardar Factura</button>
                     <button type="button" class="generate-pdf-button action-button" id="generate-generated-pdf-button" style="display: none;"><i class="fas fa-file-pdf"></i> Generar PDF (Actual)</button>
                     </div>
            </div>

             <div class="history-section">
                 <h3>Historial de Facturas Recientes</h3>
                 <ul id="invoice-history-list">
                     <li>Cargando historial...</li>
                 </ul>
                 <button class="view-history-button mt-4 action-button view-invoices-button" id="view-all-invoices-button" style="display: none;">Ver Historial Completo</button>
             </div>
        </div>
    </div>
    <div id="invoice-history-modal" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close-button" id="close-invoice-history-modal">&times;</span>
             <h2 id="invoice-history-modal-title">Historial de Facturas</h2>
             <ul id="full-invoice-history-list">
                 <li>Cargando historial...</li>
             </ul>
             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-invoice-history-modal-button">Cerrar</button>
             </div>
        </div>
    </div>
    <div id="edit-invoice-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-edit-invoice-modal">&times;</span>
            <h2>Editar Factura</h2>
            <form id="edit-invoice-form">
                <input type="hidden" id="edit-invoice-id">
                 <input type="hidden" id="edit-invoice-user-id"> <div class="modal-form-group">
                    <label for="edit-invoice-code">Código de Factura:</label>
                    <input type="text" id="edit-invoice-code" required>
                </div>
                <div class="modal-form-group">
                    <label for="edit-invoice-start-date">Fecha Inicio:</label>
                    <input type="date" id="edit-invoice-start-date" required>
                </div>
                <div class="modal-form-group">
                    <label for="edit-invoice-end-date">Fecha Fin:</label>
                    <input type="date" id="edit-invoice-end-date" required>
                </div>
                 <div class="modal-form-group">
                     <label for="edit-invoice-details">Detalles:</label>
                     <textarea id="edit-invoice-details" rows="10" class="w-full p-2 border rounded"></textarea>
                 </div>

                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-edit-invoice">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCimRCv6S5u0FhsfWrW_3A0dQJy0uAKVro",
            authDomain: "facba-69d41.firebaseapp.com",
            projectId: "facba-69d41",
            storageBucket: "facba-69d41.firebasestorage.app",
            messagingSenderId: "264089433073",
            appId: "1:264089433073:web:968551648758972eb74a50",
            measurementId: "G-NL7Y6NDH99"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore(); // Inicializar Firestore

        // Referencias a las colecciones en Firestore
        const usersCollection = db.collection('usuarios');
        const empresasCollection = db.collection('empresas');
        const asesoresCollection = db.collection('asesores');
        const arlCollection = db.collection('arl'); // Nueva colección para ARL
        const epsCollection = db.collection('eps');
        const ccfCollection = db.collection('ccf');
        const afpCollection = db.collection('afp');
        const pagosCollection = db.collection('pagos'); // NUEVA COLECCIÓN: Pagos
        const facturasCollection = db.collection('facturas'); // NUEVA COLECCIÓN: Facturas


        // Obtener elementos del DOM
        const userTableBody = document.getElementById('user-table-body');
        const searchInput = document.getElementById('search-input');
        // const statusMessage = document.getElementById('status-message'); // El pequeño ya no se usa para mensajes principales
        const filterButtonsContainer = document.querySelector('.filter-buttons'); // Contenedor de botones de filtro
        const filterButtons = document.querySelectorAll('.filter-button'); // Botones de filtro
        const settingsButton = document.getElementById('settings-button'); // Botón de configuración
        const chatButton = document.getElementById('chat-button'); // NUEVO: Botón de chat
        const clickTooltipMessage = document.getElementById('click-tooltip-message'); // Elemento para el tooltip en click

        // --- NUEVO ELEMENTO: Mensaje grande y animado ---
        const largeStatusMessage = document.getElementById('large-status-message');
        let largeStatusTimeout; // Variable para controlar el timeout del mensaje grande
        // --- FIN NUEVO ELEMENTO ---


        // Modal de Edición DOM elements
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditModalButton = document.getElementById('close-edit-modal');
        const cancelEditButton = document.getElementById('cancel-edit');
        const editUserForm = document.getElementById('edit-user-form');

        // Campos del formulario de edición
        const editUserIdInput = document.getElementById('edit-user-id');
        const editNombreInput = document.getElementById('edit-nombre');
        const editTipoIdentificacionSelect = document.getElementById('edit-tipo-identificacion');
        const editIdentificacionInput = document.getElementById('edit-identificacion');
        const editEmpresaSelect = document.getElementById('edit-empresa');
        const editArlSelect = document.getElementById('edit-arl'); // Selector para ARL
        const editRiesgoInput = document.getElementById('edit-riesgo');
        const editEpsSelect = document.getElementById('edit-eps'); // Selector para EPS
        const editCcfSelect = document.getElementById('edit-ccf'); // Selector para CCF
        const editAfpSelect = document.getElementById('edit-afp'); // Selector para AFP
        const editFechaIngresoInput = document.getElementById('edit-fecha-ingreso');
        const editFechaRegistroInput = document.getElementById('edit-fecha-registro');
        const editAsesorSelect = document.getElementById('edit-asesor');
        const editValorAPagarInput = document.getElementById('edit-valor-a-pagar');
        const editIbcInput = document.getElementById('edit-ibc'); // Nuevo input para IBC
        const editEstadoSelect = document.getElementById('edit-estado');
        const editFechaRetiroGroup = document.getElementById('edit-fecha-retiro-group');
        const editFechaRetiroInput = document.getElementById('edit-fecha-retiro');

        // Modal de Filtro DOM elements
        const filterModal = document.getElementById('filter-modal');
        const closeFilterModalButton = document.getElementById('close-filter-modal');
        const cancelFilterButton = document.getElementById('cancel-filter');
        const applyFilterButton = document.getElementById('apply-filter');
        const filterModalTitle = document.getElementById('filter-modal-title');
        const filterEmpresaGroup = document.getElementById('filter-empresa-group');
        const filterEmpresaSelect = document.getElementById('filter-empresa-select');
        const filterAsesorGroup = document.getElementById('filter-asesor-group');
        const filterAsesorSelect = document.getElementById('filter-asesor-select');
        const filterArlGroup = document.getElementById('filter-arl-group'); // Grupo de filtro para ARL
        const filterArlSelect = document.getElementById('filter-arl-select'); // Selector para ARL
        const filterEpsGroup = document.getElementById('filter-eps-group'); // Grupo de filtro para EPS
        const filterEpsSelect = document.getElementById('filter-eps-select'); // Selector para EPS
        const filterCcfGroup = document.getElementById('filter-ccf-group'); // Grupo de filtro para CCF
        const filterCcfSelect = document.getElementById('filter-ccf-select'); // Selector para CCF
        const filterAfpGroup = document.getElementById('filter-afp-group'); // Grupo de filtro para AFP
        const filterAfpSelect = document.getElementById('filter-afp-select'); // Selector para AFP


        // Modal de Configuración/Menú DOM elements
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const closeSettingsModalButtonInModal = document.getElementById('close-settings-modal-button'); // Botón "Cerrar" dentro del modal

        // Botones de opción dentro del modal de configuración
        const menuOptionButtons = document.querySelectorAll('#settings-modal .menu-option-button');
        const exportUsersButton = document.getElementById('export-users-button'); // Botón Exportar
        const importUsersButton = document.getElementById('import-users-button'); // Botón Importar


        // Modal Genérico para Agregar Entidades DOM elements
        const addEntityModal = document.getElementById('add-entity-modal');
        const closeAddEntityModalButton = document.getElementById('close-add-entity-modal');
        const cancelAddEntityButton = document.getElementById('cancel-add-entity');
        const addEntityModalTitle = document.getElementById('add-entity-modal-title');
        const addEntityForm = document.getElementById('add-entity-form');
        const addEntityTypeInput = document.getElementById('add-entity-type');
        const entityNameInput = document.getElementById('entity-name');

        // Nuevo Modal Genérico para Gestionar Entidades DOM elements
        const manageEntityModal = document.getElementById('manage-entity-modal');
        const closeManageEntityModalButton = document.getElementById('close-manage-entity-modal');
        const closeManageEntityModalButtonInModal = document.getElementById('close-manage-entity-modal-button');
        const manageEntityModalTitle = document.getElementById('manage-entity-modal-title');
        const manageEntityTypeInput = document.getElementById('manage-entity-type');
        const entityList = document.getElementById('entity-list');
        const openAddFromManageButton = document.getElementById('open-add-from-manage-button');

        // Nuevo Modal para Importar Usuarios DOM elements
        const importUsersModal = document.getElementById('import-users-modal');
        const closeImportModalButton = document.getElementById('close-import-modal');
        const cancelImportButton = document.getElementById('cancel-import');
        const excelFileInput = document.getElementById('excel-file-input');
        const processImportButton = document.getElementById('process-import-button');
        const importStatusMessage = document.getElementById('import-status-message');

        // --- NUEVOS ELEMENTOS DE MODALES DE PAGO Y FACTURACIÓN ---
        const addPaymentModal = document.getElementById('add-payment-modal');
        const closeAddPaymentModalButton = document.getElementById('close-add-payment-modal');
        const cancelAddPaymentButton = document.getElementById('cancel-add-payment');
        const addPaymentForm = document.getElementById('add-payment-form');
        const paymentUserIdInput = document.getElementById('payment-user-id');
        const paymentDateInput = document.getElementById('payment-date');
        const paymentValueInput = document.getElementById('payment-value');
        const paymentNoveltySelect = document.getElementById('payment-novelty');
        const paymentHistoryList = document.getElementById('payment-history-list');
        const viewAllPaymentsButton = document.getElementById('view-all-payments-button');

        const paymentHistoryModal = document.getElementById('payment-history-modal');
        const closePaymentHistoryModalButton = document.getElementById('close-payment-history-modal');
        const closePaymentHistoryModalButtonInModal = document.getElementById('close-payment-history-modal-button');
        const fullPaymentHistoryList = document.getElementById('full-payment-history-list');
        const paymentHistoryModalTitle = document.getElementById('payment-history-modal-title');

        // NUEVO: Modal de Edición de Pago
        const editPaymentModal = document.getElementById('edit-payment-modal');
        const closeEditPaymentModalButton = document.getElementById('close-edit-payment-modal');
        const cancelEditPaymentButton = document.getElementById('cancel-edit-payment');
        const editPaymentForm = document.getElementById('edit-payment-form');
        const editPaymentIdInput = document.getElementById('edit-payment-id');
        const editPaymentUserIdInput = document.getElementById('edit-payment-user-id');
        const editPaymentDateInput = document.getElementById('edit-payment-date');
        const editPaymentValueInput = document.getElementById('edit-payment-value');
        const editPaymentNoveltySelect = document.getElementById('edit-payment-novelty');


        const billingModal = document.getElementById('billing-modal');
        const closeBillingModalButton = document.getElementById('close-billing-modal');
        const billingForm = document.getElementById('billing-form');
        const billingUserIdInput = document.getElementById('billing-user-id');
        const billingStartDateInput = document.getElementById('billing-start-date');
        const billingEndDateInput = document.getElementById('billing-end-date');
        const generateInvoiceButton = document.getElementById('generate-invoice-button');
        const generatedInvoiceSection = document.getElementById('generated-invoice-section');
        const generatedInvoiceDetails = document.getElementById('generated-invoice-details');
        const saveInvoiceButton = document.getElementById('save-invoice-button');
        // const generatePdfButton = document.getElementById('generate-pdf-button'); // Este botón ahora se genera dinámicamente en el historial
        const generateGeneratedPdfButton = document.getElementById('generate-generated-pdf-button'); // NUEVO: Botón para PDF de factura GENERADA

        const invoiceHistoryList = document.getElementById('invoice-history-list');
        const viewAllInvoicesButton = document.getElementById('view-all-invoices-button');

        const invoiceHistoryModal = document.getElementById('invoice-history-modal');
        const closeInvoiceHistoryModalButton = document.getElementById('close-invoice-history-modal');
        const closeInvoiceHistoryModalButtonInModal = document.getElementById('close-invoice-history-modal-button');
        const fullInvoiceHistoryList = document.getElementById('full-invoice-history-list');
        const invoiceHistoryModalTitle = document.getElementById('invoice-history-modal-title');

        // NUEVO: Modal de Editar Factura
        const editInvoiceModal = document.getElementById('edit-invoice-modal');
        const closeEditInvoiceModalButton = document.getElementById('close-edit-invoice-modal');
        const cancelEditInvoiceButton = document.getElementById('cancel-edit-invoice');
        const editInvoiceForm = document.getElementById('edit-invoice-form');
        const editInvoiceIdInput = document.getElementById('edit-invoice-id');
        const editInvoiceUserIdInput = document.getElementById('edit-invoice-user-id');
        const editInvoiceCodeInput = document.getElementById('edit-invoice-code');
        const editInvoiceStartDateInput = document.getElementById('edit-invoice-start-date');
        const editInvoiceEndDateInput = document.getElementById('edit-invoice-end-date');
        const editInvoiceDetailsTextarea = document.getElementById('edit-invoice-details');


        // --- FIN NUEVOS ELEMENTOS ---


        // Mapas para almacenar nombres de entidades (para mostrar en la tabla y selectores)
        let empresasMap = new Map();
        let asesoresMap = new Map();
        let arlMap = new Map(); // Nuevo mapa para ARL
        let epsMap = new Map(); // Nuevo mapa para EPS
        let ccfMap = new Map(); // Nuevo mapa para CCF
        let afpMap = new Map(); // Nuevo mapa para AFP


        // Variable para almacenar todos los documentos de usuario fetched por onSnapshot
        let allUserDocs = [];
        // Variable para almacenar el usuario actualmente seleccionado en un modal
        let currentUserData = null;


        // Variables para almacenar los filtros actuales
        let currentStatusFilter = 'todos'; // 'todos', 'activo', 'retirado'
        let currentEmpresaFilterId = ''; // ID de empresa seleccionado para filtrar
        let currentAsesorFilterId = ''; // ID de asesor seleccionado para filtrar
        let currentArlFilterId = ''; // Nuevo: ID de ARL seleccionado para filtrar
        let currentEpsFilterId = ''; // Nuevo: ID de EPS seleccionado para filtrar
        let currentCcfFilterId = ''; // Nuevo: ID de CCF seleccionado para filtrar
        let currentAfpFilterId = ''; // Nuevo: ID de AFP seleccionado para filtrar


        // --- Funciones de Utilidad ---

        // Función para mostrar mensajes de estado (AHORA USA EL ELEMENTO GRANDE)
        function showStatusMessage(message, type = 'info') {
            console.log(`showStatusMessage called: "${message}", type: "${type}"`); // Debugging

            // Clear any existing timeout and hide any visible message
            clearTimeout(largeStatusTimeout);

            // Reset classes and styles immediately before setting new ones
            largeStatusMessage.className = ''; // Remove all classes
            largeStatusMessage.style.opacity = '0';
            largeStatusMessage.style.visibility = 'hidden'; // Hide immediately
            largeStatusMessage.textContent = ''; // Clear text


            if (!message) {
                 console.log("showStatusMessage: Message is empty, not showing."); // Debugging
                 return; // Don't show empty messages
            }

            largeStatusMessage.textContent = message;
            largeStatusMessage.classList.add(type, 'show'); // Add type class and show class
            largeStatusMessage.style.visibility = 'visible'; // Make visible
            largeStatusMessage.style.opacity = '1'; // Ensure opacity is 1 when showing

            console.log(`showStatusMessage: Added classes "${type}", "show". Visibility set to visible, opacity to 1.`); // Debugging


            // Set timeout to hide the message after 5 seconds
            largeStatusTimeout = setTimeout(() => {
                console.log("showStatusMessage: Timeout reached, hiding message."); // Debugging
                largeStatusMessage.classList.remove('show'); // Trigger fade out (opacity transition)
                 // Hide completely after the transition duration
                 setTimeout(() => {
                      largeStatusMessage.style.visibility = 'hidden';
                      largeStatusMessage.className = ''; // Clean up classes
                      largeStatusMessage.textContent = ''; // Clear text
                      console.log("showStatusMessage: Message hidden and cleaned up."); // Debugging
                 }, 500); // Match CSS transition duration (0.5s)
            }, 5000); // Show for 5 seconds
        }


         // Función para mostrar mensajes de estado en el modal de importación (mantiene el elemento pequeño)
         function showImportStatusMessage(message, type = 'info') {
             const importStatusElement = document.getElementById('import-status-message'); // Get the specific import status element
             importStatusElement.textContent = message;
             importStatusElement.className = 'mt-4 text-center text-sm'; // Reset classes and apply base styles
             if (type === 'success') {
                 importStatusElement.classList.add('text-green-600');
             } else if (type === 'error') {
                 importStatusElement.classList.add('text-red-600');
             } else {
                 importStatusElement.classList.add('text-gray-600');
             }
             // No fade out for import status message, it stays until the modal is closed or a new message appears
         }


        // --- NUEVA FUNCION: Mostrar mensaje temporal de tooltip al hacer click ---
        let tooltipTimeout; // Variable para almacenar el timeout del tooltip
        function showClickTooltipMessage(message) {
            // Clear any existing timeout and hide any visible message
            clearTimeout(tooltipTimeout);
            clickTooltipMessage.classList.remove('show'); // Start fade out if visible
             // Wait for fade out before showing new message if needed, or just hide immediately
            clickTooltipMessage.style.visibility = 'hidden'; // Hide immediately

            if (!message) return; // Don't show empty messages

            clickTooltipMessage.textContent = message;
            clickTooltipMessage.classList.add('show');
            clickTooltipMessage.style.visibility = 'visible';

            // Hide the message after 3 seconds
            tooltipTimeout = setTimeout(() => {
                clickTooltipMessage.classList.remove('show'); // Trigger fade out
                 // Hide completely after the transition
                 setTimeout(() => {
                      clickTooltipMessage.style.visibility = 'hidden';
                 }, 300); // Match CSS transition duration
            }, 3000); // Show for 3 seconds
        }


        // Función para formatear fechas (Firestore Timestamp aYYYY-MM-DD)
        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) { // Check if it's a Firestore Timestamp
                 date = timestamp.toDate();
            } else if (typeof timestamp === 'string') { // Handle string dates
                 date = new Date(timestamp);
            } else { // Handle other potential date formats
                 date = new Date(timestamp);
            }

            if (isNaN(date.getTime())) {
                return ''; // Return empty string if date is invalid
            }

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

         // Función para formatear fechas y hora (Firestore Timestamp a DD/MM/YYYY HH:mm)
         function formatDateTime(timestamp) {
             if (!timestamp) return '';
             let date;
             if (timestamp.toDate) { // Check if it's a Firestore Timestamp
                  date = timestamp.toDate();
             } else if (typeof timestamp === 'string') { // Handle string dates
                  date = new Date(timestamp);
             } else { // Handle other potential date formats
                  date = new Date(timestamp);
             }

             if (isNaN(date.getTime())) {
                 return ''; // Return empty string if date is invalid
             }

             const day = ('0' + date.getDate()).slice(-2);
             const month = ('0' + (date.getMonth() + 1)).slice(-2);
             const year = date.getFullYear();
             const hours = ('0' + date.getHours()).slice(-2);
             const minutes = ('0' + date.getMinutes()).slice(-2);

             return `${day}/${month}/${year} ${hours}:${minutes}`;
         }


        // Función para formatear números como moneda (COP)
        function formatCurrency(number) {
             let numericValue = number;
             if (typeof number === 'string') {
                 const cleanedString = number.replace(/COP/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                 numericValue = parseFloat(cleanedString);
             }

             if (numericValue === undefined || numericValue === null || isNaN(numericValue)) {
                 return '';
             }

             return new Intl.NumberFormat('es-CO', {
                 style: 'currency',
                 currency: 'COP',
                 minimumFractionDigits: 0,
                 maximumFractionDigits: 2,
             }).format(numericValue);
        }


        // --- Carga de Datos Inicial y Filtrado ---

        // Cargar mapas de todas las entidades (empresas, asesores, arl, eps, ccf, afp)
        async function loadLookupMaps() {
            try {
                const [empresasSnapshot, asesoresSnapshot, arlSnapshot, epsSnapshot, ccfSnapshot, afpSnapshot] = await Promise.all([
                    empresasCollection.get(),
                    asesoresCollection.get(),
                    arlCollection.get(), // Cargar ARL
                    epsCollection.get(), // Cargar EPS
                    ccfCollection.get(), // Cargar CCF
                    afpCollection.get()  // Cargar AFP
                ]);

                empresasMap = new Map();
                empresasSnapshot.forEach(doc => {
                    empresasMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                asesoresMap = new Map();
                asesoresSnapshot.forEach(doc => {
                    asesoresMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                arlMap = new Map(); // Llenar mapa de ARL
                arlSnapshot.forEach(doc => {
                    arlMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                epsMap = new Map(); // Llenar mapa de EPS
                epsSnapshot.forEach(doc => {
                    epsMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                ccfMap = new Map(); // Llenar mapa de CCF
                ccfSnapshot.forEach(doc => {
                    ccfMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                afpMap = new Map(); // Llenar mapa de AFP
                afpSnapshot.forEach(doc => {
                    afpMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });


                 console.log("Mapas de Empresas, Asesores, ARL, EPS, CCF, AFP cargados."); // Debugging
                 console.log("ARL Map:", Array.from(arlMap.entries()));
                 console.log("EPS Map:", Array.from(epsMap.entries()));
                 console.log("CCF Map:", Array.from(ccfMap.entries()));
                 console.log("AFP Map:", Array.from(afpMap.entries()));


            } catch (error) {
                console.error("Error al cargar mapas:", error);
                showStatusMessage('Error al cargar datos de referencia (empresas, asesores, ARL, EPS, CCF, AFP).', 'error');
            }
        }

        // Poblar selectores de entidades en los modales (edición y filtro)
        async function populateSelects() {
             try {
                 // Empresas
                 const empresasSnapshot = await empresasCollection.get();
                 editEmpresaSelect.innerHTML = '<option value="">Selecciona una empresa</option>'; // Limpiar y añadir opción por defecto
                 filterEmpresaSelect.innerHTML = '<option value="">Todas las Empresas</option>';
                 empresasSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editEmpresaSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterEmpresaSelect.appendChild(optionFilter);
                 });

                 // Asesores
                 const asesoresSnapshot = await asesoresCollection.get();
                 editAsesorSelect.innerHTML = '<option value="">Selecciona un asesor</option>'; // Limpiar y añadir opción por defecto
                 filterAsesorSelect.innerHTML = '<option value="">Todos los Asesores</option>';
                 asesoresSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editAsesorSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterAsesorSelect.appendChild(optionFilter);
                 });

                 // ARL
                 const arlSnapshot = await arlCollection.get();
                 editArlSelect.innerHTML = '<option value="">Selecciona una ARL</option>'; // Limpiar y añadir opción por defecto
                 filterArlSelect.innerHTML = '<option value="">Todas las ARL</option>';
                 arlSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editArlSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterArlSelect.appendChild(optionFilter);
                 });

                 // EPS
                 const epsSnapshot = await epsCollection.get();
                 editEpsSelect.innerHTML = '<option value="">Selecciona una EPS</option>'; // Limpiar y añadir opción por defecto
                 filterEpsSelect.innerHTML = '<option value="">Todas las EPS</option>';
                 epsSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editEpsSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterEpsSelect.appendChild(optionFilter);
                 });

                 // CCF
                 const ccfSnapshot = await ccfCollection.get();
                 editCcfSelect.innerHTML = '<option value="">Selecciona una CCF</option>'; // Limpiar y añadir opción por defecto
                 filterCcfSelect.innerHTML = '<option value="">Todas las CCF</option>';
                 ccfSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editCcfSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterCcfSelect.appendChild(optionFilter);
                 });

                 // AFP
                 const afpSnapshot = await afpCollection.get();
                 editAfpSelect.innerHTML = '<option value="">Selecciona una AFP</option>'; // Limpiar y añadir opción por defecto
                 filterAfpSelect.innerHTML = '<option value="">Todas las AFP</option>';
                 afpSnapshot.forEach(doc => {
                     const optionEdit = document.createElement('option');
                     optionEdit.value = doc.id;
                     optionEdit.textContent = doc.data().nombre || 'Nombre Desconocido';
                     editAfpSelect.appendChild(optionEdit);

                     const optionFilter = document.createElement('option');
                     optionFilter.value = doc.id;
                     optionFilter.textContent = doc.data().nombre || 'Nombre Desconocido';
                     filterAfpSelect.appendChild(optionFilter);
                 });


                  console.log("Selectores poblados."); // Debugging
             } catch (error) {
                 console.error("Error al poblar selectores:", error);
                 showStatusMessage('Error al cargar opciones de empresa/asesor/ARL/EPS/CCF/AFP.', 'error');
             }
        }

        // Function to check if a value indicates "not assigned" OR the corresponding lookup name is missing/unknown/N/A
        const isNotAssignedOrUnknown = (entityId, entityMap) => {
            // Check if the ID itself is null, empty string, or "N/A" (case-insensitive)
            if (entityId === null || entityId === '' || (typeof entityId === 'string' && entityId.trim().toUpperCase() === 'N/A')) {
                return true;
            }
            // If the ID exists, check if the corresponding name in the map is missing, indicates unknown, or is "N/A"
            const entityName = entityMap.get(entityId);
            return entityName === undefined || entityName === null || entityName === '' || entityName === 'Nombre Desconocido' || (typeof entityName === 'string' && entityName.trim().toUpperCase() === 'N/A');
        };


        // Renderizar una fila de usuario en la tabla (ahora adaptada para Grid)
        function renderUserRow(userDoc) {
            const user = userDoc.data();
            const row = document.createElement('tr');
            row.dataset.id = userDoc.id; // Guardar el ID del documento en la fila

            // Obtener nombres de entidades usando los mapas
            const empresaNombre = empresasMap.get(user.empresaId) || 'Desconocida';
            const valorAPagarFormatted = formatCurrency(user.valorAPagar);
            const ibcFormatted = formatCurrency(user.ibc); // Formatear IBC
            const estado = user.estado || 'activo'; // Estado por defecto para el botón de estado

            // --- Determinar iconos y tooltips usando isNotAssignedOrUnknown ---

            // Determine EPS Info
            const epsName = epsMap.get(user.epsId); // Get the name from the map
            const isEpsAssigned = !isNotAssignedOrUnknown(user.epsId, epsMap); // Check if it's considered assigned
            const epsTooltip = isEpsAssigned ? (epsName || 'EPS Asignada (Nombre Desconocido)') : 'EPS No Asignada';
            const epsIcon = isEpsAssigned ?
                            '<i class="fas fa-check-circle text-green-500 status-icon" title="' + epsTooltip + '"></i>' :
                            '<i class="fas fa-times-circle text-red-500 status-icon" title="' + epsTooltip + '"></i>';


            // Determine ARL Info (including Risk in tooltip)
            const arlName = arlMap.get(user.arlId); // Get the name from the map
            const isArlAssigned = !isNotAssignedOrUnknown(user.arlId, arlMap); // Check if it's considered assigned
            const arlTooltip = isArlAssigned ? `${(arlName || 'ARL Asignada (Nombre Desconocido)')}${user.riesgo ? ' - ' + user.riesgo : ''}` : 'ARL No Asignada';
            const arlIcon = isArlAssigned ?
                            '<i class="fas fa-check-circle text-green-500 status-icon" title="' + arlTooltip + '"></i>' :
                            '<i class="fas fa-times-circle text-red-500 status-icon" title="' + arlTooltip + '"></i>';


            // Determine AFP Info
            const afpName = afpMap.get(user.afpId); // Get the name from the map
            const isAfpAssigned = !isNotAssignedOrUnknown(user.afpId, afpMap); // Check if it's considered assigned
            const afpTooltip = isAfpAssigned ? (afpName || 'AFP Asignada (Nombre Desconocido)') : 'AFP No Asignada';
            const afpIcon = isAfpAssigned ?
                            '<i class="fas fa-check-circle text-green-500 status-icon" title="' + afpTooltip + '"></i>' :
                            '<i class="fas fa-times-circle text-red-500 status-icon" title="' + afpTooltip + '"></i>';


            // Determine CCF Info
            const ccfName = ccfMap.get(user.ccfId); // Get the name from the map
            const isCcfAssigned = !isNotAssignedOrUnknown(user.ccfId, ccfMap); // Check if it's considered assigned
            const ccfTooltip = isCcfAssigned ? (ccfName || 'CCF Asignada (Nombre Desconocido)') : 'CCF No Asignada';
            const ccfIcon = isCcfAssigned ?
                            '<i class="fas fa-check-circle text-green-500 status-icon" title="' + ccfTooltip + '"></i>' :
                            '<i class="fas fa-times-circle text-red-500 status-icon" title="' + ccfTooltip + '"></i>';


            // Añadir data-label para la responsividad de la tabla
            row.innerHTML = `
                <td data-label="Nombre">${user.nombre || 'Sin Nombre'}</td>
                <td data-label="Empresa">${empresaNombre}</td>
                <td data-label="Valor a Pagar">${valorAPagarFormatted}</td>
                <td data-label="IBC">${ibcFormatted}</td>
                <td data-label="EPS">${epsIcon}</td>
                <td data-label="ARL">${arlIcon}</td>
                <td data-label="AFP">${afpIcon}</td>
                <td data-label="CCF">${ccfIcon}</td>
                <td class="action-cell" data-label="Acciones">
                    <div class="action-buttons-container">
                        <button class="action-button edit-button" data-id="${userDoc.id}" title="Editar"><i class="fas fa-edit"></i> Editar</button>
                        <button class="action-button delete-button" data-id="${userDoc.id}" title="Eliminar"><i class="fas fa-trash-alt"></i> Eliminar</button>
                        <button class="action-button status-button" data-id="${userDoc.id}" data-current-status="${estado}" title="${estado === 'activo' ? 'Marcar como Retirado' : 'Marcar como Activo'}">
                             <i class="fas ${estado === 'activo' ? 'fa-user-slash' : 'fa-user'}"></i> ${estado === 'activo' ? 'Retirar' : 'Activar'}
                        </button>
                         <button class="action-button add-payment-button" data-id="${userDoc.id}" title="Agregar Pago"><i class="fas fa-dollar-sign"></i> Pago</button> <button class="action-button billing-button" data-id="${userDoc.id}" title="Facturación"><i class="fas fa-file-invoice"></i> Factura</button> </div>
                    <i class="fas fa-cog gear-icon" data-id="${userDoc.id}" title="Mostrar Acciones"></i>
                </td>
            `;
            return row;
        }

        // Función para renderizar la tabla con los usuarios filtrados
        function renderFilteredUsers() {
            userTableBody.innerHTML = ''; // Limpiar tabla actual
            const filterText = searchInput.value.toLowerCase();

            let filteredDocs = allUserDocs.filter(userDoc => {
                const user = userDoc.data();
                const empresaNombre = empresasMap.get(user.empresaId) || 'Desconocida';
                const asesorNombre = asesoresMap.get(user.asesorId) || 'Desconocido';
                const arlNombre = arlMap.get(user.arlId) || 'Desconocida'; // Usar mapa para ARL
                const epsNombre = epsMap.get(user.epsId) || 'Desconocida'; // Usar mapa para EPS
                const ccfNombre = ccfMap.get(user.ccfId) || 'Desconocida'; // Usar mapa para CCF
                const afpNombre = afpMap.get(user.afpId) || 'Desconocida'; // Usar mapa para AFP
                const estado = user.estado || 'activo'; // Estado por defecto

                // Aplicar filtro de estado
                const matchesStatusFilter = currentStatusFilter === 'todos' || estado === currentStatusFilter;

                // Aplicar filtro de empresa
                const matchesEmpresaFilter = currentEmpresaFilterId === '' || user.empresaId === currentEmpresaFilterId;

                // Aplicar filtro de asesor
                const matchesAsesorFilter = currentAsesorFilterId === '' || user.asesorId === currentAsesorFilterId;

                 // Aplicar filtro de ARL
                 const matchesArlFilter = currentArlFilterId === '' || user.arlId === currentArlFilterId;

                 // Aplicar filtro de EPS
                 const matchesEpsFilter = currentEpsFilterId === '' || user.epsId === currentEpsFilterId;

                 // Aplicar filtro de CCF
                 const matchesCcfFilter = currentCcfFilterId === '' || user.ccfId === currentCcfFilterId;

                 // Aplicar filtro de AFP
                 const matchesAfpFilter = currentAfpFilterId === '' || user.afpId === currentAfpFilterId;


                // Aplicar filtro de búsqueda (en nombre, identificación, empresa, estado, asesor, ARL, Riesgo, EPS, CCF, AFP, IBC)
                const matchesSearch = filterText === '' ||
                    (user.nombre && user.nombre.toLowerCase().includes(filterText)) ||
                    (user.identificacion && String(user.identificacion).toLowerCase().includes(filterText)) ||
                    (empresaNombre.toLowerCase().includes(filterText)) ||
                    (estado.toLowerCase().includes(filterText)) ||
                    (asesorNombre.toLowerCase().includes(filterText)) ||
                    (arlMap.get(user.arlId) || '').toLowerCase().includes(filterText) || // Incluir ARL nombre en búsqueda
                    (user.riesgo && user.riesgo.toLowerCase().includes(filterText)) ||
                    (epsMap.get(user.epsId) || '').toLowerCase().includes(filterText) || // Incluir EPS nombre en búsqueda
                    (ccfMap.get(user.ccfId) || '').toLowerCase().includes(filterText) || // Incluir CCF nombre en búsqueda
                    (afpMap.get(user.afpId) || '').toLowerCase().includes(filterText) || // Incluir AFP nombre en búsqueda
                     (user.ibc !== undefined && user.ibc !== null && String(user.ibc).toLowerCase().includes(filterText)); // Incluir IBC en búsqueda


                // Retornar true si coincide con TODOS los filtros
                return matchesStatusFilter && matchesEmpresaFilter && matchesAsesorFilter && matchesArlFilter && matchesEpsFilter && matchesCcfFilter && matchesAfpFilter && matchesSearch;
            });

            // Renderizar las filas filtradas
            if (filteredDocs.length > 0) {
                filteredDocs.forEach(doc => {
                    const row = renderUserRow(doc);
                    userTableBody.appendChild(row);
                });
            } else {
                const noDataRow = document.createElement('tr');
                // Actualizar colspan a 9 para que ocupe todo el ancho de las 9 columnas visibles (8 + 1 IBC)
                noDataRow.innerHTML = `<td colspan="9" class="text-center text-gray-500">No hay usuarios que coincidan con los filtros.</td>`;
                userTableBody.appendChild(noDataRow);
            }

             console.log(`Tabla de usuarios renderizada. ${filteredDocs.length} usuarios mostrados.`); // Debugging
        }


        // Cargar usuarios inicialmente y configurar el listener de onSnapshot
        async function loadUsersTable() {
             // Cargar mapas antes de la primera carga de la tabla si aún no están cargados
             if (empresasMap.size === 0 || asesoresMap.size === 0 || arlMap.size === 0 || epsMap.size === 0 || ccfMap.size === 0 || afpMap.size === 0) {
                 await loadLookupMaps();
             }

             // Usar onSnapshot para escuchar cambios en tiempo real
             usersCollection.orderBy('nombre').onSnapshot(snapshot => {
                 // Almacenar todos los documentos en la variable global
                 allUserDocs = snapshot.docs;
                 console.log(`onSnapshot triggered. ${allUserDocs.length} total users fetched.`); // Debugging

                 // Renderizar la tabla con los filtros actuales
                 renderFilteredUsers();

             }, error => {
                 console.error("Error al cargar usuarios con onSnapshot:", error);
                 showStatusMessage('Error al cargar usuarios.', 'error');
             });
        }


        // --- Funcionalidad de Búsqueda ---
        searchInput.addEventListener('input', () => {
            // Al cambiar el input de búsqueda, re-renderizar la tabla con el nuevo filtro
            renderFilteredUsers();
        });


        // --- Funcionalidad de Filtro por Estado, Empresa, Asesor, ARL, EPS, CCF, AFP ---
        filterButtonsContainer.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.filter-button');
            if (!targetButton) return; // No es un botón de filtro

            const filterType = targetButton.dataset.filter;

            // Remover clase 'active' de todos los botones de estado (Todos, Activos, Retirados)
            document.querySelectorAll('.filter-button[data-filter="todos"], .filter-button[data-filter="activo"], .filter-button[data-filter="retirado"]').forEach(button => button.classList.remove('active'));
             // Remover clase 'active' de los botones de filtro de modal
             document.querySelectorAll('.filter-button[data-filter="empresa"], .filter-button[data-filter="asesor"], .filter-button[data-filter="arl"], .filter-button[data-filter="eps"], .filter-button[data-filter="ccf"], .filter-button[data-filter="afp"]').forEach(button => button.classList.remove('active'));


            if (filterType === 'todos' || filterType === 'activo' || filterType === 'retirado') {
                // Filtro por estado
                targetButton.classList.add('active');
                currentStatusFilter = filterType;
                // Resetear todos los filtros de ID
                currentEmpresaFilterId = '';
                currentAsesorFilterId = '';
                currentArlFilterId = ''; // Resetear filtro de ARL
                currentEpsFilterId = '';
                currentCcfFilterId = '';
                currentAfpFilterId = '';
                console.log("Filtro de estado cambiado a:", currentStatusFilter);
                renderFilteredUsers(); // Re-renderizar la tabla con el nuevo filtro

            } else { // Es un filtro que usa modal (empresa, asesor, arl, eps, ccf, afp)
                 targetButton.classList.add('active');
                 // Resetear la visualización de todos los grupos de filtro de modal
                 filterEmpresaGroup.style.display = 'none';
                 filterAsesorGroup.style.display = 'none';
                 filterArlGroup.style.display = 'none'; // Ocultar grupo de ARL
                 filterEpsGroup.style.display = 'none';
                 filterCcfGroup.style.display = 'none';
                 filterAfpGroup.style.display = 'none';

                 // Mostrar el grupo de filtro correcto
                 switch (filterType) {
                      case 'empresa':
                           filterModalTitle.textContent = 'Filtrar por Empresa';
                           filterEmpresaGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterEmpresaSelect.value = currentEmpresaFilterId; // Seleccionar filtro actual si existe
                           break;
                      case 'asesor':
                           filterModalTitle.textContent = 'Filtrar por Asesor';
                           filterAsesorGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterAsesorSelect.value = currentAsesorFilterId; // Seleccionar filtro actual si existe
                           break;
                      case 'arl': // Mostrar grupo de ARL
                           filterModalTitle.textContent = 'Filtrar por ARL';
                           filterArlGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterArlSelect.value = currentArlFilterId; // Seleccionar filtro actual si existe
                           break;
                      case 'eps':
                           filterModalTitle.textContent = 'Filtrar por EPS';
                           filterEpsGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterEpsSelect.value = currentEpsFilterId; // Seleccionar filtro actual si existe
                           break;
                      case 'ccf':
                           filterModalTitle.textContent = 'Filtrar por CCF';
                           filterCcfGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterCcfSelect.value = currentCcfFilterId; // Seleccionar filtro actual si existe
                           break;
                      case 'afp':
                           filterModalTitle.textContent = 'Filtrar por AFP';
                           filterAfpGroup.style.display = 'block';
                           await populateSelects(); // Asegurarse de que los selectores estén poblados
                           filterAfpSelect.value = currentAfpFilterId; // Seleccionar filtro actual si existe
                           break;
                 }

                 showFilterModal();
            }

        });

        // --- Manejo del Modal de Filtro ---
        function showFilterModal() {
            filterModal.classList.add('show');
        }

        function hideFilterModal() {
            filterModal.classList.remove('show');
            // Resetear la visualización de todos los grupos de filtro de modal
            filterEmpresaGroup.style.display = 'none';
            filterAsesorGroup.style.display = 'none';
            filterArlGroup.style.display = 'none'; // Ocultar grupo de ARL
            filterEpsGroup.style.display = 'none';
            filterCcfGroup.style.display = 'none';
            filterAfpGroup.style.display = 'none';
             // Asegurarse de que el botón de filtro de modal activo se desactive si se cierra sin aplicar
             document.querySelectorAll('.filter-button[data-filter="empresa"], .filter-button[data-filter="asesor"], .filter-button[data-filter="arl"], .filter-button[data-filter="eps"], .filter-button[data-filter="ccf"], .filter-button[data-filter="afp"]').forEach(button => button.classList.remove('active'));
        }

        closeFilterModalButton.addEventListener('click', hideFilterModal);
        cancelFilterButton.addEventListener('click', hideFilterModal);

        filterModal.addEventListener('click', (e) => {
            if (e.target === filterModal) {
                hideFilterModal();
            }
        });

        applyFilterButton.addEventListener('click', () => {
             // Aplicar el filtro seleccionado del modal
             // Resetear todos los filtros de ID primero
             currentEmpresaFilterId = '';
             currentAsesorFilterId = '';
             currentArlFilterId = ''; // Resetear filtro de ARL
             currentEpsFilterId = '';
             currentCcfFilterId = '';
             currentAfpFilterId = '';

             // Aplicar el filtro del selector visible
             if (filterEmpresaGroup.style.display !== 'none') {
                  currentEmpresaFilterId = filterEmpresaSelect.value;
                  console.log("Filtro de Empresa aplicado:", currentEmpresaFilterId);
             } else if (filterAsesorGroup.style.display !== 'none') {
                  currentAsesorFilterId = filterAsesorSelect.value;
                  console.log("Filtro de Asesor aplicado:", currentAsesorFilterId);
             } else if (filterArlGroup.style.display !== 'none') { // Aplicar filtro de ARL
                  currentArlFilterId = filterArlSelect.value;
                  console.log("Filtro de ARL aplicado:", currentArlFilterId);
             } else if (filterEpsGroup.style.display !== 'none') {
                  currentEpsFilterId = filterEpsSelect.value;
                  console.log("Filtro de EPS aplicado:", currentEpsFilterId);
             } else if (filterCcfGroup.style.display !== 'none') {
                  currentCcfFilterId = filterCcfSelect.value;
                  console.log("Filtro de CCF aplicado:", currentCcfFilterId);
             } else if (filterAfpGroup.style.display !== 'none') {
                  currentAfpFilterId = filterAfpSelect.value;
                  console.log("Filtro de AFP aplicado:", currentAfpFilterId);
             }

             // Asegurarse de que el filtro de estado sea 'todos' cuando se aplica filtro de ID
             currentStatusFilter = 'todos';
             document.querySelector('.filter-button[data-filter="todos"]').classList.add('active');
             document.querySelectorAll('.filter-button[data-filter="activo"], .filter-button[data-filter="retirado"]').forEach(button => button.classList.remove('active'));


             hideFilterModal();
             renderFilteredUsers(); // Re-renderizar la tabla con los nuevos filtros
        });


        // --- Funcionalidad de Edición, Eliminación y Cambio de Estado de Usuarios ---

        // Listener para los botones de acción y iconos de estado en la tabla (usando delegación de eventos)
        userTableBody.addEventListener('click', async (e) => {
            const target = e.target;

            // Check if the clicked element or its parent is a status icon
            if (target.classList.contains('status-icon') || target.parentElement.classList.contains('status-icon')) {
                const iconElement = target.classList.contains('status-icon') ? target : target.parentElement;
                const tooltipText = iconElement.title; // Get the tooltip text from the title attribute
                showClickTooltipMessage(tooltipText); // Show the temporary message
                return; // Stop further processing for status icon clicks
            }


            const userId = target.dataset.id || target.closest('.action-button, .gear-icon')?.dataset.id;

            if (!userId) return; // No hay ID de usuario asociado al clic

            const userDoc = allUserDocs.find(doc => doc.id === userId);
            if (!userDoc) {
                console.error("Documento de usuario no encontrado para ID:", userId);
                showStatusMessage('Error: Datos de usuario no encontrados.', 'error');
                return;
            }

            // Almacenar los datos del usuario seleccionado globalmente
            currentUserData = userDoc.data();
            currentUserData.id = userDoc.id; // Guardar también el ID


            const actionCell = target.closest('.action-cell');
            const actionButtonsContainer = actionCell ? actionCell.querySelector('.action-buttons-container') : null;
            const gearIcon = actionCell ? actionCell.querySelector('.gear-icon') : null;


            if (target.classList.contains('gear-icon')) {
                // Acción de mostrar/ocultar botones al hacer clic en la tuerca
                console.log("Gear icon clicked for user:", userId);
                // Ocultar todos los contenedores de botones de acción abiertos
                document.querySelectorAll('.action-buttons-container.show').forEach(container => {
                    container.classList.remove('show');
                    // Mostrar la tuerca correspondiente
                    const parentCell = container.closest('.action-cell');
                    if (parentCell) {
                         parentCell.querySelector('.gear-icon').style.display = 'inline-block';
                    }
                });

                // Mostrar el contenedor de botones de acción para esta fila
                if (actionButtonsContainer && gearIcon) {
                     actionButtonsContainer.classList.add('show');
                     gearIcon.style.display = 'none'; // Ocultar la tuerca
                }

            } else if (target.closest('.action-button')) {
                // Es un botón de acción (Editar, Eliminar, Estado, Agregar Pago, Facturación)
                const actionButton = target.closest('.action-button');

                // Ocultar los botones de acción después de la acción
                if (actionButtonsContainer && gearIcon) {
                     actionButtonsContainer.classList.remove('show');
                     gearIcon.style.display = 'inline-block'; // Mostrar la tuerca de nuevo
                }


                if (actionButton.classList.contains('edit-button')) {
                    // Acción de Editar
                    console.log("Botón Editar clickeado para usuario:", userId);
                    await populateSelects(); // Asegurarse de que los selectores estén poblados con las últimas entidades
                    await loadUserDataForEdit(userId);
                    showEditModal();

                } else if (actionButton.classList.contains('delete-button')) {
                    // Acción de Eliminar
                    console.log("Botón Eliminar clickeado para usuario:", userId);
                    if (confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción es irreversible mientras no se implemente la funcionalidad de recuperación.')) {
                        deleteUser(userId);
                    }

                } else if (actionButton.classList.contains('status-button')) {
                    // Acción de Cambiar Estado
                    console.log("Botón Cambiar Estado clickeado para usuario:", userId);
                    const currentStatus = actionButton.dataset.currentStatus;
                    const newStatus = currentStatus === 'activo' ? 'retirado' : 'activo';
                    changeUserStatus(userId, newStatus);
                } else if (actionButton.classList.contains('add-payment-button')) {
                    // Acción de Agregar Pago
                    console.log("Botón Agregar Pago clickeado para usuario:", userId);
                    showAddPaymentModal(userId); // Pasar el ID del usuario al modal de pago
                } else if (actionButton.classList.contains('billing-button')) {
                    // Acción de Facturación
                    console.log("Botón Facturación clickeado para usuario:", userId);
                    showBillingModal(userId); // Pasar el ID del usuario al modal de facturación
                }
            }
        });

         // Ocultar los botones de acción si se hace clic en cualquier otro lugar del documento
         document.addEventListener('click', (e) => {
             // Verificar si el clic fue fuera de una celda de acción o dentro de un botón de acción
             const isClickInsideActionCell = e.target.closest('.action-cell');
             const isActionButton = e.target.closest('.action-button');
             const isGearIcon = e.target.closest('.gear-icon');
             const isStatusIcon = e.target.closest('.status-icon'); // Also check for status icons
             const isClickInsideInvoiceListItem = e.target.closest('#invoice-history-list li, #full-invoice-history-list li'); // Check if click is inside an invoice list item
             const isClickInsideInvoiceActions = e.target.closest('.invoice-actions'); // Check if click is inside invoice actions container
             const isClickInsideInvoiceGear = e.target.closest('#invoice-history-list li .gear-icon, #full-invoice-history-list li .gear-icon'); // Check if click is on invoice gear icon


             // If the click was not inside an action cell, or if it was on an action button/gear/status icon
             // within an action cell, we don't hide the buttons for that specific cell.
             // But we want to hide ANY other open action button containers.

             if (!isClickInsideActionCell || isActionButton || isGearIcon || isStatusIcon) {
                 document.querySelectorAll('.action-buttons-container.show').forEach(container => {
                      const parentCell = container.closest('.action-cell');
                      // Hide only if the click was NOT on the gear icon of *this* cell
                      if (!isGearIcon || (isGearIcon && parentCell !== isClickInsideActionCell)) {
                            container.classList.remove('show');
                            // Show the corresponding gear icon
                            if (parentCell) {
                                parentCell.querySelector('.gear-icon').style.display = 'inline-block';
                            }
                      }
                 });
             }

             // Also hide invoice action buttons if the click is outside an invoice list item or within its actions/gear
             if (!isClickInsideInvoiceListItem || isClickInsideInvoiceActions || isClickInsideInvoiceGear) {
                 document.querySelectorAll('#invoice-history-list li .invoice-actions.show, #full-invoice-history-list li .invoice-actions.show').forEach(container => {
                      const parentListItem = container.closest('li');
                      // Hide only if the click was NOT on the gear icon of *this* list item
                      if (!isClickInsideInvoiceGear || (isClickInsideInvoiceGear && parentListItem !== isClickInsideInvoiceListItem)) {
                           container.classList.remove('show');
                           // Show the corresponding gear icon
                           if (parentListItem) {
                                parentListItem.querySelector('.gear-icon').style.display = 'inline-block';
                           }
                      }
                 });
             }

             // If the click was on the gear icon, the logic to show/hide was already handled in the userTableBody listener
             // If the click was on a status icon, the tooltip message was handled, no action buttons to hide here.
         });



        // Cargar datos de un usuario en el modal de edición
        async function loadUserDataForEdit(userId) {
            try {
                const userDoc = await usersCollection.doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log("Datos del usuario cargados para edición:", userData);

                    // Llenar el formulario del modal
                    editUserIdInput.value = userId;
                    editNombreInput.value = userData.nombre || '';
                    editTipoIdentificacionSelect.value = userData.tipoIdentificacion || '';
                    editIdentificacionInput.value = userData.identificacion || '';
                    editEmpresaSelect.value = userData.empresaId || ''; // Seleccionar por ID
                    editArlSelect.value = userData.arlId || ''; // Seleccionar por ID de ARL
                    editRiesgoInput.value = userData.riesgo || '';
                    editEpsSelect.value = userData.epsId || ''; // Seleccionar por ID de EPS
                    editCcfSelect.value = userData.ccfId || ''; // Seleccionar por ID de CCF
                    editAfpSelect.value = userData.afpId || ''; // Seleccionar por ID de AFP
                    editFechaIngresoInput.value = formatDate(userData.fecha);
                    editFechaRegistroInput.value = formatDate(userData.ingreso);
                    editAsesorSelect.value = userData.asesorId || ''; // Seleccionar por ID
                    let valorAPagarNumeric = userData.valorAPagar;
                     if (typeof userData.valorAPagar === 'string') {
                         const cleanedString = userData.valorAPagar.replace(/COP/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                         numericValue = parseFloat(cleanedString);
                     }
                    editValorAPagarInput.value = valorAPagarNumeric || ''; // Poner el valor numérico o vacío

                    // Cargar valor de IBC
                    let ibcNumeric = userData.ibc;
                    if (typeof userData.ibc === 'string') {
                         const cleanedString = userData.ibc.replace(/COP/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                         ibcNumeric = parseFloat(cleanedString);
                    }
                    editIbcInput.value = ibcNumeric || ''; // Poner el valor numérico o vacío para IBC


                    editEstadoSelect.value = userData.estado || 'activo'; // Estado por defecto

                    // Mostrar/ocultar campo fechaRetiro basado en el estado
                    if (editEstadoSelect.value === 'retirado') {
                        editFechaRetiroGroup.style.display = 'block';
                        // Opcional: establecer la fecha actual por defecto si se cambia a retirado
                        if (!editFechaRetiroInput.value) {
                             editFechaRetiroInput.valueAsDate = new Date();
                        }
                    } else {
                        editFechaRetiroGroup.style.display = 'none';
                        editFechaRetiroInput.value = ''; // Limpiar si no está retirado
                    }

                } else {
                    console.error("Usuario no encontrado para edición:", userId);
                    showStatusMessage('Error: Usuario no encontrado para editar.', 'error');
                    hideEditModal();
                }
            } catch (error) {
                console.error("Error al cargar datos para edición:", error);
                showStatusMessage('Error al cargar datos del usuario para edición.', 'error');
                hideEditModal();
            }
        }

        // Listener para el cambio en el selector de estado en el modal de edición
        editEstadoSelect.addEventListener('change', (e) => {
            if (e.target.value === 'retirado') {
                editFechaRetiroGroup.style.display = 'block';
                // Opcional: establecer la fecha actual por defecto si se cambia a retirado
                if (!editFechaRetiroInput.value) {
                     editFechaRetiroInput.valueAsDate = new Date();
                }
            } else {
                editFechaRetiroGroup.style.display = 'none';
                editFechaRetiroInput.value = ''; // Limpiar el campo si no está retirado
            }
        });


        // Mostrar el modal de edición
        function showEditModal() {
            editUserModal.classList.add('show');
        }

        // Ocultar el modal de edición
        function hideEditModal() {
            editUserModal.classList.remove('show');
            editUserForm.reset(); // Resetear formulario al cerrar
             editFechaRetiroGroup.style.display = 'none'; // Ocultar campo fecha retiro al cerrar
        }

        // Listener para cerrar modal de edición con la X
        closeEditModalButton.addEventListener('click', hideEditModal);

        // Listener para cerrar modal de edición con el botón Cancelar
        cancelEditButton.addEventListener('click', hideEditModal);

        // Listener para cerrar modal de edición haciendo clic fuera del contenido
        editUserModal.addEventListener('click', (e) => {
            if (e.target === editUserModal) {
                hideEditModal();
            }
        });

        // Listener para guardar cambios del formulario de edición
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevenir envío por defecto

            const userId = editUserIdInput.value;

            // --- Inicio de modificación para manejar fechas como Timestamp ---
            // Obtener valores de fecha como strings del input date
            const fechaIngresoString = editFechaIngresoInput.value;
            const fechaRegistroString = editFechaRegistroInput.value;
            const fechaRetiroString = editFechaRetiroInput.value;

            // Convertir strings de fecha a objetos Date (considerando zona horaria para evitar problemas)
            // Añadimos 'T00:00:00' y 'Z' para asegurar que se interprete como UTC y evitar desfases por zona horaria local
            const fechaIngresoDate = fechaIngresoString ? new Date(fechaIngresoString + 'T00:00:00Z') : null;
            const fechaRegistroDate = fechaRegistroString ? new Date(fechaRegistroString + 'T00:00:00Z') : null;
            const fechaRetiroDate = fechaRetiroString ? new Date(fechaRetiroString + 'T00:00:00Z') : null;

            // Validar si las fechas son válidas Date objects
            const fechaIngresoTimestamp = fechaIngresoDate && !isNaN(fechaIngresoDate.getTime()) ? firebase.firestore.Timestamp.fromDate(fechaIngresoDate) : null;
            const fechaRegistroTimestamp = fechaRegistroDate && !isNaN(fechaRegistroDate.getTime()) ? firebase.firestore.Timestamp.fromDate(fechaRegistroDate) : null;
            let fechaRetiroTimestamp = fechaRetiroDate && !isNaN(fechaRetiroDate.getTime()) ? firebase.firestore.Timestamp.fromDate(fechaRetiroDate) : null;
            // --- Fin de modificación para manejar fechas como Timestamp ---


            const updatedData = {
                nombre: editNombreInput.value,
                tipoIdentificacion: editTipoIdentificacionSelect.value,
                identificacion: editIdentificacionInput.value,
                empresaId: editEmpresaSelect.value || null, // Guardar ID o null si no se selecciona
                arlId: editArlSelect.value || null, // Guardar ID de ARL o null
                riesgo: editRiesgoInput.value,
                epsId: editEpsSelect.value || null, // Guardar ID de EPS o null
                ccfId: editCcfSelect.value || null, // Guardar ID de CCF o null
                afpId: editAfpSelect.value || null, // Guardar ID de AFP o null
                // --- Usar los Timestamps generados ---
                fecha: fechaIngresoTimestamp, // Guardar como Timestamp
                ingreso: fechaRegistroTimestamp, // Guardar como Timestamp
                // --- Fin de uso de Timestamps ---
                asesorId: editAsesorSelect.value || null, // Guardar ID o null
                valorAPagar: parseFloat(editValorAPagarInput.value) || 0, // Convertir a número antes de guardar
                ibc: parseFloat(editIbcInput.value) || 0, // Guardar IBC como número
                estado: editEstadoSelect.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Añadir fechaRetiro solo si el estado es 'retirado' y el Timestamp es válido
            if (updatedData.estado === 'retirado' && fechaRetiroTimestamp) {
                updatedData.fechaRetiro = fechaRetiroTimestamp; // Guardar como Timestamp
            } else {
                 // Si el estado no es retirado o el Timestamp de fechaRetiro no es válido, eliminar el campo
                 updatedData.fechaRetiro = firebase.firestore.FieldValue.delete();
            }

            // --- Debugging: Log para verificar el ID y los datos antes de guardar ---
            console.log("Intentando guardar usuario con ID:", userId);
            console.log("Datos a enviar a Firestore:", updatedData);
            // --- Fin de Debugging ---


            showStatusMessage('Guardando cambios...', 'info');

            try {
                // Asegurarse de que el userId no esté vacío antes de intentar guardar
                if (!userId) {
                    console.error("Error: userId está vacío. No se puede guardar el documento.");
                    showStatusMessage('Error al guardar cambios: ID de usuario no válido.', 'error');
                    return; // Detener la ejecución si no hay ID
                }

                await usersCollection.doc(userId).update(updatedData);
                showStatusMessage('Cambios guardados con éxito!', 'success');
                hideEditModal(); // Cerrar modal después de guardar
            } catch (error) {
                console.error("Error al guardar cambios:", error);
                showStatusMessage('Error al guardar cambios: ' + error.message, 'error');
            }
        });


        // Eliminar un usuario
        async function deleteUser(userId) {
            showStatusMessage('Eliminando usuario...', 'info');
            try {
                await usersCollection.doc(userId).delete();
                showStatusMessage('Usuario eliminado con éxito!', 'success');
            } catch (error) {
                console.error("Error al eliminar usuario:", error);
                showStatusMessage('Error al eliminar usuario: ' + error.message, 'error');
            }
        }

        // Cambiar el estado de un usuario
        async function changeUserStatus(userId, newStatus) {
             showStatusMessage(`Cambiando estado a "${newStatus}"...`, 'info');
             const updateData = {
                 estado: newStatus,
                 updatedAt: firebase.firestore.FieldValue.serverTimestamp()
             };

             // Añadir/eliminar fechaRetiro según el nuevo estado
             if (newStatus === 'retirado') {
                  // Si se cambia a retirado, añadir la fecha actual como Timestamp
                  updateData.fechaRetiro = firebase.firestore.Timestamp.fromDate(new Date());
             } else {
                  // Si se cambia a activo, eliminar el campo fechaRetiro
                  updateData.fechaRetiro = firebase.firestore.FieldValue.delete();
             }


             try {
                 await usersCollection.doc(userId).update(updateData);
                 showStatusMessage(`Estado actualizado a "${newStatus}" con éxito!`, 'success');
             } catch (error) {
                 console.error("Error al cambiar estado:", error);
                 showStatusMessage('Error al cambiar estado: ' + error.message, 'error');
             }
        }

        // --- Manejo del Modal de Configuración/Menú ---

        // Mostrar el modal de configuración
        function showSettingsModal() {
            settingsModal.classList.add('show');
        }

        // Ocultar el modal de configuración
        function hideSettingsModal() {
            settingsModal.classList.remove('show');
        }

        // Listener para abrir el modal de configuración al hacer clic en el icono de engranaje
        settingsButton.addEventListener('click', showSettingsModal);

        // Listeners para cerrar el modal de configuración
        closeSettingsModalButton.addEventListener('click', hideSettingsModal);
        closeSettingsModalButtonInModal.addEventListener('click', hideSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                hideSettingsModal();
            }
        });

        // --- Manejo del Modal Genérico para Agregar Entidades ---

        // Mostrar el modal genérico de agregar entidad
        function showAddEntityModal(title, entityType) {
            addEntityModalTitle.textContent = title;
            addEntityTypeInput.value = entityType; // Guardar el tipo de entidad
            entityNameInput.value = ''; // Limpiar el campo de nombre
            addEntityModal.classList.add('show');
        }

        // Ocultar el modal genérico de agregar entidad
        function hideAddEntityModal() {
            addEntityModal.classList.remove('show');
            addEntityForm.reset(); // Resetear el formulario
        }

        // Listeners para cerrar el modal genérico de agregar entidad
        closeAddEntityModalButton.addEventListener('click', hideAddEntityModal);
        cancelAddEntityButton.addEventListener('click', hideAddEntityModal);
        addEntityModal.addEventListener('click', (e) => {
            if (e.target === addEntityModal) {
                hideAddEntityModal();
            }
        });

        // Listener para el envío del formulario del modal genérico de agregar entidad
        addEntityForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevenir envío por defecto

            const entityType = addEntityTypeInput.value;
            const entityName = entityNameInput.value.trim(); // Corregido: usar entityNameInput

            if (!entityName) {
                alert("Por favor, ingresa el nombre.");
                return;
            }

            let collectionRef;
            let successMessage = '';
            let entityData = {
                 nombre: entityName,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Determinar la colección y el mensaje de éxito basado en el tipo de entidad
            switch (entityType) {
                case 'arl': // Caso para ARL
                    collectionRef = arlCollection;
                    successMessage = 'Nueva ARL agregada con éxito!';
                    break;
                case 'eps':
                    collectionRef = epsCollection;
                    successMessage = 'Nueva EPS agregada con éxito!';
                    break;
                case 'ccf':
                    collectionRef = ccfCollection;
                    successMessage = 'Nueva CCF agregada con éxito!';
                    break;
                case 'afp':
                    collectionRef = afpCollection;
                    successMessage = 'Nueva AFP agregada con éxito!';
                    break;
                case 'asesor':
                    collectionRef = asesoresCollection;
                    successMessage = 'Nuevo Asesor agregado con éxito!';
                    break;
                case 'empresa':
                    collectionRef = empresasCollection;
                    successMessage = 'Nueva Empresa agregada con éxito!';
                    break;
                default:
                    showStatusMessage('Error: Tipo de entidad desconocido.', 'error');
                    return;
            }

            showStatusMessage(`Agregando ${entityName}...`, 'info');

            try {
                await collectionRef.add(entityData);
                showStatusMessage(successMessage, 'success');
                hideAddEntityModal(); // Cerrar modal después de guardar

                // Después de agregar una nueva entidad, recargar los mapas y poblar los selectores
                 await loadLookupMaps(); // Recargar todos los mapas globales
                 await populateSelects(); // Repoblar todos los selectores en los modales


                // Si el modal de gestión de esta entidad está abierto, recargarlo
                if (manageEntityModal.classList.contains('show') && manageEntityTypeInput.value === entityType) {
                     loadEntitiesForManagement(entityType);
                }


            } catch (error) {
                console.error(`Error al agregar ${entityType}:`, error);
                showStatusMessage(`Error al agregar ${entityType}: ` + error.message, 'error');
            }
        });

        // --- Manejo del Nuevo Modal Genérico para Gestionar Entidades ---

        // Mostrar el modal de gestión de entidades
        function showManageEntityModal(title, entityType) {
             manageEntityModalTitle.textContent = title;
             manageEntityTypeInput.value = entityType; // Guardar el tipo de entidad
             entityList.innerHTML = ''; // Limpiar la lista actual
             manageEntityModal.classList.add('show');
             loadEntitiesForManagement(entityType); // Cargar las entidades al abrir el modal
        }

        // Ocultar el modal de gestión de entidades
        function hideManageEntityModal() {
             manageEntityModal.classList.remove('show');
             entityList.innerHTML = ''; // Limpiar la lista al cerrar
        }

        // Listeners para cerrar el modal de gestión
        closeManageEntityModalButton.addEventListener('click', hideManageEntityModal);
        closeManageEntityModalButtonInModal.addEventListener('click', hideManageEntityModal);
        manageEntityModal.addEventListener('click', (e) => {
             if (e.target === manageEntityModal) {
                 hideManageEntityModal();
             }
        });

        // Listener para abrir el modal de agregar desde el modal de gestión
        openAddFromManageButton.addEventListener('click', () => {
             const entityType = manageEntityTypeInput.value;
             let modalTitle = '';
             switch (entityType) {
                 case 'arl': modalTitle = 'Agregar Nueva ARL'; break; // Caso para ARL
                 case 'eps': modalTitle = 'Agregar Nueva EPS'; break;
                 case 'ccf': modalTitle = 'Agregar Nueva CCF'; break;
                 case 'afp': modalTitle = 'Agregar Nueva AFP'; break;
                 case 'asesor': modalTitle = 'Agregar Nuevo Asesor'; break;
                 case 'empresa': modalTitle = 'Agregar Nueva Empresa'; break;
                 default: modalTitle = 'Agregar Nueva Entidad';
             }
             hideManageEntityModal(); // Ocultar el modal de gestión
             showAddEntityModal(modalTitle, entityType); // Mostrar el modal de agregar
        });


        // Función para cargar y mostrar entidades en el modal de gestión
        async function loadEntitiesForManagement(entityType) {
            entityList.innerHTML = '<li>Cargando...</li>'; // Mensaje de carga
            let collectionRef;
            let entityTypeName = '';

            switch (entityType) {
                case 'arl': collectionRef = arlCollection; entityTypeName = 'ARL'; break; // Caso para ARL
                case 'eps': collectionRef = epsCollection; entityTypeName = 'EPS'; break;
                case 'ccf': collectionRef = ccfCollection; entityTypeName = 'CCF'; break;
                case 'afp': collectionRef = afpCollection; entityTypeName = 'AFP'; break;
                case 'asesor': collectionRef = asesoresCollection; entityTypeName = 'Asesor'; break;
                case 'empresa': collectionRef = empresasCollection; entityTypeName = 'Empresa'; break;
                default:
                    entityList.innerHTML = '<li>Error: Tipo de entidad desconocido.</li>';
                    return;
            }

            manageEntityModalTitle.textContent = `Gestionar ${entityTypeName}s`; // Actualizar título del modal

            try {
                const snapshot = await collectionRef.orderBy('nombre').get();
                entityList.innerHTML = ''; // Limpiar lista

                if (snapshot.empty) {
                    entityList.innerHTML = `<li>No hay ${entityTypeName}s registrados.</li>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const entity = doc.data();
                    const listItem = document.createElement('li');
                    listItem.classList.add('entity-item');
                    listItem.dataset.id = doc.id;
                    listItem.dataset.type = entityType;

                    listItem.innerHTML = `
                        <span class="entity-name">${entity.nombre || 'Sin Nombre'}</span>
                        <button class="delete-entity-button" data-id="${doc.id}" data-type="${entityType}">Eliminar</button>
                    `;
                    entityList.appendChild(listItem);
                });

            } catch (error) {
                console.error(`Error al cargar ${entityTypeName}s:`, error);
                entityList.innerHTML = `<li>Error al cargar ${entityTypeName}s.</li>`;
                showStatusMessage(`Error al cargar ${entityTypeName}s.`, 'error');
            }
        }

        // Listener para los botones de eliminar en el modal de gestión (usando delegación)
        entityList.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.delete-entity-button');
            if (!targetButton) return; // No es un botón de eliminar

            const entityId = targetButton.dataset.id;
            const entityType = targetButton.dataset.type;
            const entityName = targetButton.parentElement.querySelector('.entity-name').textContent; // Obtener el nombre para la confirmación

            if (confirm(`¿Estás seguro de que deseas eliminar "${entityName}"? Esta acción es irreversible.`)) {
                deleteEntity(entityType, entityId, entityName);
            }
        });

        // Función para eliminar una entidad
        async function deleteEntity(entityType, entityId, entityName) {
             // Determine the entity type name for the status message
             let entityTypeName = '';
             switch (entityType) {
                 case 'arl': entityTypeName = 'ARL'; break; // Caso para ARL
                 case 'eps': entityTypeName = 'EPS'; break;
                 case 'ccf': entityTypeName = 'CCF'; break;
                 case 'afp': entityTypeName = 'AFP'; break;
                 case 'asesor': entityTypeName = 'Asesor'; break;
                 case 'empresa': entityTypeName = 'Empresa'; break;
                 default: entityTypeName = 'Entidad';
             }

             showStatusMessage(`Eliminando ${entityTypeName}...`, 'info');

             let collectionRef;

             switch (entityType) {
                 case 'arl': collectionRef = arlCollection; break; // Caso para ARL
                 case 'eps': collectionRef = epsCollection; break;
                 case 'ccf': collectionRef = ccfCollection; break;
                 case 'afp': collectionRef = afpCollection; break;
                 case 'asesor': collectionRef = asesoresCollection; break;
                 case 'empresa': collectionRef = empresasCollection; break;
                 default:
                     showStatusMessage('Error: Tipo de entidad desconocido para eliminar.', 'error');
                     return;
             }

             try {
                 await collectionRef.doc(entityId).delete();
                 showStatusMessage(`${entityTypeName} "${entityName}" eliminado con éxito!`, 'success');

                 // Recargar la lista en el modal de gestión
                 loadEntitiesForManagement(entityType);

                 // Después de eliminar una entidad, recargar los mapas y selectores
                 await loadLookupMaps(); // Recargar todos los mapas globales
                 await populateSelects(); // Repoblar todos los selectores en los modales
                 // Re-renderizar la tabla de usuarios por si algún usuario estaba asociado a la entidad eliminada
                 renderFilteredUsers();


             } catch (error) {
                 console.error(`Error al eliminar ${entityTypeName}:`, error);
                 showStatusMessage(`Error al eliminar ${entityTypeName} "${entityName}": ` + error.message, 'error');
                 // Considerar si se debe manejar el caso de que la entidad esté referenciada por usuarios
                 // En una aplicación real, probablemente querrías evitar la eliminación si hay referencias
             }
        }


        // Listener para los botones de opción en el modal de configuración (actualizados para abrir el modal de gestión o importar/exportar)
        menuOptionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const entityType = e.target.dataset.entityType;

                if (entityType) { // Si tiene data-entity-type, es un botón de gestionar entidad
                    let entityTypeName = '';
                    switch (entityType) {
                        case 'arl': entityTypeName = 'ARL'; break; // Caso para ARL
                        case 'eps': entityTypeName = 'EPS'; break;
                        case 'ccf': entityTypeName = 'CCF'; break;
                        case 'afp': entityTypeName = 'AFP'; break;
                        case 'asesor': entityTypeName = 'Asesor'; break;
                        case 'empresa': entityTypeName = 'Empresa'; break;
                        default: entityTypeName = 'Entidad';
                    }
                    const modalTitle = `Gestionar ${entityTypeName}s`;
                    hideSettingsModal();
                    showManageEntityModal(modalTitle, entityType);
                }
            });
        });

        // Listener para el botón Exportar Usuarios
        exportUsersButton.addEventListener('click', () => {
            hideSettingsModal(); // Ocultar el modal de configuración
            exportUsersToCsv(); // Llamar a la función de exportación
        });

        // Listener para el botón Importar Usuarios
        importUsersButton.addEventListener('click', () => {
            hideSettingsModal(); // Ocultar el modal de configuración
            showImportUsersModal(); // Mostrar el modal de importación
        });


        // --- Funcionalidad de Exportar Usuarios a CSV ---
        function exportUsersToCsv() {
             showStatusMessage('Preparando exportación...', 'info');

             // Obtener los datos actualmente filtrados y mostrados en la tabla
             // Una forma simple es iterar sobre las filas renderizadas,
             // pero es más robusto usar los `filteredDocs` que se usan para renderizar.
             // Sin embargo, `filteredDocs` no es global. Vamos a usar `allUserDocs`
             // y aplicar los filtros actuales para garantizar que se exporte lo que se ve.

             const filterText = searchInput.value.toLowerCase();
             const usersToExport = allUserDocs.filter(userDoc => {
                 const user = userDoc.data();
                 const empresaNombre = empresasMap.get(user.empresaId) || 'Desconocida';
                 const asesorNombre = asesoresMap.get(user.asesorId) || 'Desconocido';
                 const arlNombre = arlMap.get(user.arlId) || 'Desconocida'; // Usar mapa para ARL
                 const epsNombre = epsMap.get(user.epsId) || 'Desconocida'; // Usar mapa para EPS
                 const ccfNombre = ccfMap.get(user.ccfId) || 'Desconocida'; // Usar mapa para CCF
                 const afpNombre = afpMap.get(user.afpId) || 'Desconocida'; // Usar mapa para AFP
                 const estado = user.estado || 'activo';

                 const matchesStatusFilter = currentStatusFilter === 'todos' || estado === currentStatusFilter;
                 const matchesEmpresaFilter = currentEmpresaFilterId === '' || user.empresaId === currentEmpresaFilterId;
                 const matchesAsesorFilter = currentAsesorFilterId === '' || user.asesorId === currentAsesorFilterId;
                 const matchesArlFilter = currentArlFilterId === '' || user.arlId === currentArlFilterId; // Aplicar filtro de ARL
                 const matchesEpsFilter = currentEpsFilterId === '' || user.epsId === currentEpsFilterId;
                 const matchesCcfFilter = currentCcfFilterId === '' || user.ccfId === currentCcfFilterId;
                 const matchesAfpFilter = currentAfpFilterId === '' || user.afpId === currentAfpFilterId;

                 const matchesSearch = filterText === '' ||
                     (user.nombre && user.nombre.toLowerCase().includes(filterText)) ||
                     (user.identificacion && String(user.identificacion).toLowerCase().includes(filterText)) ||
                     (empresaNombre.toLowerCase().includes(filterText)) ||
                     (estado.toLowerCase().includes(filterText)) ||
                     (asesorNombre.toLowerCase().includes(filterText)) ||
                     (arlMap.get(user.arlId) || '').toLowerCase().includes(filterText) || // Incluir ARL nombre en búsqueda
                     (user.riesgo && user.riesgo.toLowerCase().includes(filterText)) ||
                     (epsMap.get(user.epsId) || '').toLowerCase().includes(filterText) || // Incluir EPS nombre en búsqueda
                     (ccfMap.get(user.ccfId) || '').toLowerCase().includes(filterText) ||
                     (afpMap.get(user.afpId) || '').toLowerCase().includes(filterText) ||
                     (user.ibc !== undefined && user.ibc !== null && String(user.ibc).toLowerCase().includes(filterText)); // Incluir IBC en búsqueda


                 return matchesStatusFilter && matchesEmpresaFilter && matchesAsesorFilter && matchesArlFilter && matchesEpsFilter && matchesCcfFilter && matchesAfpFilter && matchesSearch;
             });


             if (usersToExport.length === 0) {
                 showStatusMessage('No hay usuarios para exportar con los filtros actuales.', 'info');
                 return;
             }

             // Definir los encabezados del CSV
             const headers = [
                 "NOMBRE", "TIPO DE IDENTIFICACION", "IDENTIFICACION", "EMPRESA", "ARL", "RIESGO",
                 "EPS", "CCF", "AFP", "FECHA INGRESO", "ASESOR", "VALOR A PAGAR", "IBC", "ESTADO", "FECHA RETIRO"
             ];

             // Crear las filas del CSV
             const rows = usersToExport.map(userDoc => {
                 const user = userDoc.data();
                 const empresaNombre = empresasMap.get(user.empresaId) || '';
                 const asesorNombre = asesoresMap.get(user.asesorId) || '';
                 const arlNombre = arlMap.get(user.arlId) || ''; // Usar mapa para ARL
                 const epsNombre = epsMap.get(user.epsId) || ''; // Usar mapa para EPS
                 const ccfNombre = ccfMap.get(user.ccfId) || ''; // Usar mapa para CCF
                 const afpNombre = afpMap.get(user.afpId) || ''; // Usar mapa para AFP
                 const estado = user.estado || 'activo';
                 const fechaRetiro = user.fechaRetiro ? formatDate(user.fechaRetiro) : '';


                 return [
                     user.nombre || '',
                     user.tipoIdentificacion || '',
                     user.identificacion || '',
                     empresaNombre, // Usar el nombre de la empresa
                     arlNombre, // Usar el nombre de la ARL
                     user.riesgo || '',
                     epsNombre, // Usar el nombre de la EPS
                     ccfNombre, // Usar el nombre de la CCF
                     afpNombre, // Usar el nombre de la AFP
                     formatDate(user.fecha), // Formatear fecha de ingreso
                     asesorNombre, // Usar el nombre del asesor
                     user.valorAPagar !== undefined && user.valorAPagar !== null ? user.valorAPagar : '', // Exportar valor numérico
                     user.ibc !== undefined && user.ibc !== null ? user.ibc : '', // Exportar valor numérico de IBC
                     estado,
                     fechaRetiro // Incluir fecha de retiro
                 ].map(field => {
                      // Convertir todo a string antes de manejar comillas
                      let fieldString = String(field || '');
                      // Escapar comillas dobles con dobles comillas dobles y envolver en comillas
                      return `"${fieldString.replace(/"/g, '""')}"`;
                 }).join(','); // Envolver campos en comillas y escapar comillas dobles
             });

             // Unir encabezados y filas
             const csvContent = [headers.join(','), ...rows].join('\n');

             // Crear un Blob y un enlace para descargar
             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);

             link.setAttribute('href', url);
             link.setAttribute('download', 'usuarios_facba.csv'); // Nombre del archivo
             link.style.visibility = 'hidden'; // Ocultar el enlace
             document.body.appendChild(link); // Añadir al DOM temporalmente
             link.click(); // Simular clic para descargar
             document.body.removeChild(link); // Eliminar del DOM
             URL.revokeObjectURL(url); // Liberar el URL del Blob

             showStatusMessage('Usuarios exportados con éxito a usuarios_facba.csv', 'success');
        }


        // --- Funcionalidad de Importar Usuarios desde Excel ---

        // Mostrar el modal de importación
        function showImportUsersModal() {
             importUsersModal.classList.add('show');
             excelFileInput.value = null; // Limpiar el input de archivo
             showImportStatusMessage('Selecciona un archivo Excel (.xlsx o .xls).');
        }

        // Ocultar el modal de importación
        function hideImportUsersModal() {
             importUsersModal.classList.remove('show');
        }

        // Listeners para cerrar el modal de importación
        closeImportModalButton.addEventListener('click', hideImportUsersModal);
        cancelImportButton.addEventListener('click', hideImportUsersModal); // Corregido: usar hideImportUsersModal

        importUsersModal.addEventListener('click', (e) => {
            if (e.target === importUsersModal) {
                hideImportUsersModal();
            }
        });

        // Listener para el botón "Procesar Importación"
        processImportButton.addEventListener('click', async () => {
            const file = excelFileInput.files[0];
            if (!file) {
                showImportStatusMessage('Por favor, selecciona un archivo primero.', 'error');
                return;
            }

            showImportStatusMessage('Procesando archivo...', 'info');
            processImportButton.disabled = true; // Deshabilitar botón durante el proceso

            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Asumimos que los datos están en la primera hoja
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convertir la hoja a un array de objetos (usando la primera fila como encabezados)
                    // header: 1 para usar la primera fila como encabezados
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });


                    if (jsonData.length <= 1) { // Check if there's more than just the header row
                        showImportStatusMessage('El archivo Excel está vacío o no contiene datos en el formato esperado.', 'error');
                        processImportButton.disabled = false;
                        return;
                    }

                    // Extraer encabezados de la primera fila
                    const headersRow = jsonData[0];
                    const dataRows = jsonData.slice(1); // Obtener solo las filas de datos

                     console.log("Encabezados leídos del Excel:", headersRow); // Log headers
                     console.log("Número de filas de datos leídas:", dataRows.length); // Log count


                    // Mapear los nombres de columna del Excel a los nombres de campo de Firestore
                    const columnMapping = {
                        "NOMBRE": "nombre",
                        "TIPO DE IDENTIFICACION": "tipoIdentificacion",
                        "IDENTIFICACION": "identificacion",
                        "EMPRESA": "empresa", // Nombre de la Empresa (para buscar/crear ID)
                        "ARL": "arl", // Nombre de la ARL (para buscar/crear ID)
                        "RIESGO": "riesgo", // Texto directo
                        "EPS": "eps", // Nombre de la EPS (para buscar/crear ID)
                        "CCF": "ccf", // Nombre de la CCF (para buscar/crear ID)
                        "AFP": "afp", // Nombre de la AFP (para buscar/crear ID)
                        "FECHA INGRESO": "fecha", // Fecha
                        "ASESOR": "asesor", // Nombre del Asesor (para buscar/crear ID)
                        "VALOR A PAGAR": "valorAPagar", // Número
                        "IBC": "ibc", // Mapeo para IBC
                         "ESTADO": "estado", // Opcional: Si el estado viene en el Excel
                         "FECHA RETIRO": "fechaRetiro" // Opcional: Si la fecha de retiro viene en el Excel
                    };

                    const requiredColumns = [
                        "NOMBRE", "TIPO DE IDENTIFICACION", "IDENTIFICACION", "EMPRESA",
                        "FECHA INGRESO", "ASESOR", "VALOR A PAGAR" // Columnas mínimas requeridas (IBC no es requerido aquí por defecto)
                    ];

                    // Crear un mapeo dinámico de índice de columna a campo de Firestore
                    const dynamicColumnMapping = {};
                    const excelHeadersUpper = headersRow.map(header => String(header).trim().toUpperCase());

                    // Check for required headers
                    for (const requiredHeader of requiredColumns) {
                         if (!excelHeadersUpper.includes(requiredHeader)) {
                             showImportStatusMessage(`Error: Faltan la columna requerida "${requiredHeader}" en el archivo.`, 'error');
                             processImportButton.disabled = false;
                             return; // Stop processing if required headers are missing
                         }
                    }

                     // Create dynamic mapping for all recognized headers
                     excelHeadersUpper.forEach((header, index) => {
                          if (columnMapping[header]) {
                               dynamicColumnMapping[index] = columnMapping[header];
                          }
                     });

                     console.log("Mapeo dinámico de columnas:", dynamicColumnMapping);


                    // --- PASO 1: Identificar y crear nuevas Entidades (Empresas, Asesores, ARL, EPS, CCF, AFP) ---
                    showImportStatusMessage('Identificando nuevas Entidades (Empresas, Asesores, ARL, EPS, CCF, AFP)...', 'info');
                    const newEmpresasToCreate = new Set();
                    const newAsesoresToCreate = new Set();
                    const newArlToCreate = new Set(); // Nuevo Set para ARL
                    const newEpsToCreate = new Set(); // Nuevo Set para EPS
                    const newCcfToCreate = new Set(); // Nuevo Set para CCF
                    const newAfpToCreate = new Set(); // Nuevo Set para AFP


                    // Recargar mapas para tener la información más reciente antes de identificar faltantes
                    await loadLookupMaps();

                    for (const row of dataRows) {
                        const empresaName = String(row[excelHeadersUpper.indexOf("EMPRESA")] || '').trim();
                        const asesorName = String(row[excelHeadersUpper.indexOf("ASESOR")] || '').trim();
                        const arlName = String(row[excelHeadersUpper.indexOf("ARL")] || '').trim(); // Leer nombre de ARL
                        const epsName = String(row[excelHeadersUpper.indexOf("EPS")] || '').trim(); // Leer nombre de EPS
                        const ccfName = String(row[excelHeadersUpper.indexOf("CCF")] || '').trim(); // Leer nombre de CCF
                        const afpName = String(row[excelHeadersUpper.indexOf("AFP")] || '').trim(); // Leer nombre de AFP


                        if (empresaName && !Array.from(empresasMap.values()).some(name => name.toLowerCase() === empresaName.toLowerCase())) {
                            newEmpresasToCreate.add(empresaName);
                        }
                        if (asesorName && !Array.from(asesoresMap.values()).some(name => name.toLowerCase() === asesorName.toLowerCase())) {
                            newAsesoresToCreate.add(asesorName);
                        }
                         // Check for empty string or "N/A" before adding to set
                         if (arlName && arlName.toUpperCase() !== 'N/A' && !Array.from(arlMap.values()).some(name => name.toLowerCase() === arlName.toLowerCase())) {
                             newArlToCreate.add(arlName);
                         }
                         if (epsName && epsName.toUpperCase() !== 'N/A' && !Array.from(epsMap.values()).some(name => name.toLowerCase() === epsName.toLowerCase())) {
                             newEpsToCreate.add(epsName);
                         }
                         if (ccfName && ccfName.toUpperCase() !== 'N/A' && !Array.from(ccfMap.values()).some(name => name.toLowerCase() === ccfName.toLowerCase())) {
                             newCcfToCreate.add(ccfName);
                         }
                         if (afpName && afpName.toUpperCase() !== 'N/A' && !Array.from(afpMap.values()).some(name => name.toLowerCase() === afpName.toLowerCase())) {
                             newAfpToCreate.add(afpName);
                         }
                    }

                    console.log("Nuevas Empresas a crear:", Array.from(newEmpresasToCreate));
                    console.log("Nuevos Asesores a crear:", Array.from(newAsesoresToCreate));
                    console.log("Nuevas ARL a crear:", Array.from(newArlToCreate)); // Log nuevas ARL
                    console.log("Nuevas EPS a crear:", Array.from(newEpsToCreate)); // Log nuevas EPS
                    console.log("Nuevas CCF a crear:", Array.from(newCcfToCreate)); // Log nuevas CCF
                    console.log("Nuevas AFP a crear:", Array.from(newAfpToCreate)); // Log nuevas AFP


                    const entitiesBatch = db.batch();
                    let entitiesCreatedCount = 0;

                    newEmpresasToCreate.forEach(name => {
                        const newEmpresaRef = empresasCollection.doc();
                        entitiesBatch.set(newEmpresaRef, {
                            nombre: name,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                         entitiesCreatedCount++;
                    });

                    newAsesoresToCreate.forEach(name => {
                        const newAsesorRef = asesoresCollection.doc();
                        entitiesBatch.set(newAsesorRef, {
                            nombre: name,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                         entitiesCreatedCount++;
                    });

                     newArlToCreate.forEach(name => { // Añadir nuevas ARL al batch
                         const newArlRef = arlCollection.doc();
                         entitiesBatch.set(newArlRef, {
                             nombre: name,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                          entitiesCreatedCount++;
                     });

                     newEpsToCreate.forEach(name => { // Añadir nuevas EPS al batch
                         const newEpsRef = epsCollection.doc();
                         entitiesBatch.set(newEpsRef, {
                             nombre: name,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                          entitiesCreatedCount++;
                     });

                     newCcfToCreate.forEach(name => { // Añadir nuevas CCF al batch
                         const newCcfRef = ccfCollection.doc();
                         entitiesBatch.set(newCcfRef, {
                             nombre: name,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                          entitiesCreatedCount++;
                     });

                     newAfpToCreate.forEach(name => { // Añadir nuevas AFP al batch
                         const newAfpRef = afpCollection.doc();
                         entitiesBatch.set(newAfpRef, {
                             nombre: name,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                          entitiesCreatedCount++;
                     });


                    if (entitiesCreatedCount > 0) {
                         showImportStatusMessage(`Creando ${entitiesCreatedCount} nuevas entidades...`, 'info');
                         try {
                             await entitiesBatch.commit();
                             console.log("Nuevas entidades creadas con éxito.");
                             // Recargar mapas después de crear nuevas entidades
                             await loadLookupMaps();
                              showImportStatusMessage('Nuevas entidades creadas. Preparando importación de usuarios...', 'info');
                         } catch (entityBatchError) {
                             console.error("Error al crear nuevas entidades:", entityBatchError);
                             showImportStatusMessage('Error al crear nuevas entidades. Importación cancelada.', 'error');
                             processImportButton.disabled = false;
                             excelFileInput.value = null;
                             return; // Stop the process
                         }
                    } else {
                         showImportStatusMessage('No se encontraron nuevas entidades para crear. Preparando importación de usuarios...', 'info');
                    }


                    // --- PASO 2: Importar Usuarios (ahora con todos los IDs de Entidades disponibles) ---
                    const userBatch = db.batch(); // Usar un nuevo batch para los usuarios
                    let importedCount = 0;
                    let errorCount = 0;
                    const importErrors = [];

                    showImportStatusMessage(`Iniciando importación de ${dataRows.length} filas de usuarios...`, 'info');

                    for (let i = 0; i < dataRows.length; i++) {
                        const row = dataRows[i];
                        const userData = {};
                        let isValidRow = true;
                        let rowErrors = [];
                        const rowNumber = i + 2; // Excel row number (1-indexed header + 1)

                         console.log(`Procesando Fila ${rowNumber}:`, row); // Log the raw row data


                        // Mapear y validar datos por columna usando el mapeo dinámico
                        for (const colIndex in row) {
                            const firestoreField = dynamicColumnMapping[colIndex];

                            if (firestoreField) {
                                 let value = row[colIndex];
                                 // Handle potential null/undefined values from empty cells gracefully
                                 value = value === undefined || value === null ? '' : value;


                                 // Validations and transformations specific to each field
                                 if (firestoreField === 'identificacion') {
                                      // Ensure identification is a valid string or number
                                      userData[firestoreField] = String(value).trim();
                                      if (!userData[firestoreField]) {
                                           isValidRow = false;
                                           rowErrors.push("Identificación vacía");
                                      }
                                 } else if (firestoreField === 'empresa') {
                                       // Map company name to ID (now guaranteed to exist in maps)
                                      const empresaName = String(value).trim();
                                      const empresaEntry = Array.from(empresasMap.entries()).find(([id, name]) => name.toLowerCase() === empresaName.toLowerCase());
                                      if (empresaEntry) {
                                           userData['empresaId'] = empresaEntry[0]; // Store the ID
                                      } else {
                                           // This shouldn't happen if step 1 was successful, but as a fallback
                                           isValidRow = false;
                                           rowErrors.push(`Error interno: Empresa "${empresaName}" no encontrada después de la creación.`);
                                      }
                                 } else if (firestoreField === 'asesor') {
                                      // Map advisor name to ID (now guaranteed to exist in maps)
                                      const asesorName = String(value).trim();
                                       const asesorEntry = Array.from(asesoresMap.entries()).find(([id, name]) => name.toLowerCase() === asesorName.toLowerCase());
                                        if (asesorEntry) {
                                             userData['asesorId'] = asesorEntry[0]; // Store the ID
                                        } else {
                                             // This shouldn't happen if step 1 was successful, but as a fallback
                                             isValidRow = false;
                                             rowErrors.push(`Error interno: Asesor "${asesorName}" no encontrado después de la creación.`);
                                        }
                                 } else if (firestoreField === 'arl') { // Map ARL name to ID
                                       const arlName = String(value).trim();
                                       // Check for empty string or "N/A"
                                       if (arlName && arlName.toUpperCase() !== 'N/A') {
                                            const arlEntry = Array.from(arlMap.entries()).find(([id, name]) => name.toLowerCase() === arlName.toLowerCase());
                                            if (arlEntry) {
                                                 userData['arlId'] = arlEntry[0]; // Store the ID
                                            } else {
                                                 // This shouldn't happen if step 1 was successful, but as a fallback
                                                 isValidRow = false;
                                                 rowErrors.push(`Error interno: ARL "${arlName}" not found after creation.`);
                                            }
                                       } else {
                                            userData['arlId'] = null; // Store null if ARL name is empty or "N/A"
                                       }
                                  } else if (firestoreField === 'eps') { // Map EPS name to ID
                                       const epsName = String(value).trim();
                                        // Check for empty string or "N/A"
                                       if (epsName && epsName.toUpperCase() !== 'N/A') {
                                            const epsEntry = Array.from(epsMap.entries()).find(([id, name]) => name.toLowerCase() === epsName.toLowerCase());
                                            if (epsEntry) {
                                                 userData['epsId'] = epsEntry[0]; // Store the ID
                                            } else {
                                                 // This shouldn't happen if step 1 was successful, but as a fallback
                                                 isValidRow = false;
                                                 rowErrors.push(`Error interno: EPS "${epsName}" not found after creation.`);
                                            }
                                       } else {
                                            userData['epsId'] = null; // Store null if EPS name is empty or "N/A"
                                       }
                                  } else if (firestoreField === 'ccf') { // Map CCF name to ID
                                       const ccfName = String(value).trim();
                                        // Check for empty string or "N/A"
                                        if (ccfName && ccfName.toUpperCase() !== 'N/A') {
                                             const ccfEntry = Array.from(ccfMap.entries()).find(([id, name]) => name.toLowerCase() === ccfName.toLowerCase());
                                             if (ccfEntry) {
                                                  userData['ccfId'] = ccfEntry[0]; // Store the ID
                                             } else {
                                                  // This shouldn't happen if step 1 was successful, but as a fallback
                                                  isValidRow = false;
                                                  rowErrors.push(`Error interno: CCF "${ccfName}" not found after creation.`);
                                             }
                                        } else {
                                             userData['ccfId'] = null; // Store null if CCF name is empty or "N/A"
                                        }
                                  } else if (firestoreField === 'afp') { // Map AFP name to ID
                                       const afpName = String(value).trim();
                                        // Check for empty string or "N/A"
                                        if (afpName && afpName.toUpperCase() !== 'N/A') {
                                             const afpEntry = Array.from(afpMap.entries()).find(([id, name]) => name.toLowerCase() === afpName.toLowerCase());
                                             if (afpEntry) {
                                                  userData['afpId'] = afpEntry[0]; // Store the ID
                                             } else {
                                                  // This shouldn't happen if step 1 was successful, but as a fallback
                                                  isValidRow = false;
                                                  rowErrors.push(`Error interno: AFP "${afpName}" not found after creation.`);
                                            }
                                        } else {
                                             userData['afpId'] = null; // Store null if AFP name is empty or "N/A"
                                        }
                                  }
                                  else if (firestoreField === 'fecha' || firestoreField === 'fechaRetiro') {
                                      // Parse dates. XLSX can return numbers (serial) or strings.
                                      let dateValue = null;
                                      if (typeof value === 'number') {
                                           // Assume it's an Excel serial number and convert to date
                                           // Need to adjust for the difference between Excel epoch (1899-12-30) and JS epoch (1970-01-01)
                                           // and Excel's leap year bug prior to 1900 (handle date > 60)
                                           const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                           // For serial dates > 60 (after 1900-03-01), subtract 1 to account for Excel's incorrect 1900 leap year
                                           const adjustedValue = value > 60 ? value - 1 : value;
                                           dateValue = new Date(excelEpoch.getTime() + adjustedValue * 24 * 60 * 60 * 1000);

                                      } else if (typeof value === 'string' && value.trim() !== '' && value.trim().toUpperCase() !== 'N/A') { // Ignore "N/A" for dates
                                           // Try to parse date string (YYYY-MM-DD, MM/DD/YYYY, etc.)
                                           try {
                                                // PreferYYYY-MM-DD if possible
                                                if (/^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
                                                     dateValue = new Date(value.trim() + 'T00:00:00Z'); // Parse as UTC to avoid timezone issues
                                                } else {
                                                    dateValue = new Date(value.trim()); // Try general parsing
                                                }

                                                // Check if the parsed date is valid
                                                if (isNaN(dateValue.getTime())) {
                                                    dateValue = null; // Invalid date string
                                                } else {
                                                    // Store as Date objects and Firestore will handle Timestamps.
                                                }
                                           } catch (e) {
                                                dateValue = null; // Parsing failed
                                           }
                                      }

                                      if (dateValue) {
                                          userData[firestoreField] = dateValue; // Store as Date object
                                      } else if (firestoreField === 'fecha') { // Fecha de ingreso is required
                                           isValidRow = false;
                                           rowErrors.push(`Fecha de Ingreso inválida, vacía o "N/A": "${value}"`); // Updated error message
                                      }
                                      // Fecha de retiro is optional, don't mark error if empty/invalid/N/A
                                 } else if (firestoreField === 'valorAPagar' || firestoreField === 'ibc') { // Handle IBC as number
                                      // Parse value to pay or IBC to number
                                      const numericValue = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); // Clean non-numbers except . and -
                                      userData[firestoreField] = isNaN(numericValue) ? 0 : numericValue; // Store as number, 0 if invalid
                                 } else if (firestoreField === 'estado') {
                                      // Validate status (optional, if present in Excel)
                                      const estadoValue = String(value).trim().toLowerCase();
                                      if (estadoValue === 'activo' || estadoValue === 'retirado') {
                                           userData[firestoreField] = estadoValue;
                                      } else {
                                           userData[firestoreField] = 'activo'; // Default status if invalid
                                       }
                                 }
                                 else {
                                      // Other text fields (RIESGO, NOMBRE, TIPO DE IDENTIFICACION)
                                      userData[firestoreField] = String(value || '').trim();
                                 }
                            }
                        }

                        // Perform additional validations for required fields not covered above
                        // Check if required fields are present and valid AFTER mapping
                        if (!userData.nombre || !userData.tipoIdentificacion || !userData.identificacion || !userData.hasOwnProperty('empresaId') || !userData.hasOwnProperty('asesorId') || !(userData.fecha instanceof Date && !isNaN(userData.fecha.getTime())) || userData.valorAPagar === undefined || userData.valorAPagar === null) { // Validar fecha como Date object
                            if (!userData.nombre) rowErrors.push("Nombre vacío");
                            if (!userData.tipoIdentificacion) rowErrors.push("Tipo de Identificación vacío");
                            if (!userData.identificacion) rowErrors.push("Identificación vacía");
                            if (!userData.hasOwnProperty('empresaId') || userData.empresaId === null) rowErrors.push("Empresa no válida o vacía"); // Check for null ID
                            if (!userData.hasOwnProperty('asesorId') || userData.asesorId === null) rowErrors.push("Asesor no válido o vacío"); // Check for null ID
                             if (!(userData.fecha instanceof Date && !isNaN(userData.fecha.getTime()))) rowErrors.push("Fecha de Ingreso inválida o vacía"); // Validar fecha como Date object
                             if (userData.valorAPagar === undefined || userData.valorAPagar === null) rowErrors.push("Valor a Pagar inválido o vacío");
                             isValidRow = false; // Mark row as invalid if any required field is missing/invalid
                        }


                        // Add mandatory fields that might not be in Excel or might be empty
                         if (!userData.hasOwnProperty('estado')) {
                             userData.estado = 'activo'; // Default status if not in Excel
                         }
                         // Ensure arlId, epsId, ccfId, afpId are null if not set during mapping
                         if (!userData.hasOwnProperty('arlId')) userData.arlId = null;
                         if (!userData.hasOwnProperty('epsId')) userData.epsId = null;
                         if (!userData.hasOwnProperty('ccfId')) userData.ccfId = null;
                         if (!userData.hasOwnProperty('afpId')) userData.afpId = null;
                         // Ensure ibc is 0 if not set during mapping or invalid
                         if (!userData.hasOwnProperty('ibc') || userData.ibc === undefined || userData.ibc === null || isNaN(userData.ibc)) {
                             userData.ibc = 0;
                         }


                         // fechaRetiro is handled when parsing the date or deleted if not retired
                         if (userData.hasOwnProperty('fechaRetiro') && !(userData.fechaRetiro instanceof Date && !isNaN(userData.fechaRetiro.getTime()))) { // Validar fecha como Date object
                             // If fechaRetiro was in Excel but invalid or empty, delete it
                             userData.fechaRetiro = firebase.firestore.FieldValue.delete();
                         } else if (userData.hasOwnProperty('fechaRetiro') && userData.estado !== 'retirado') {
                             // If fechaRetiro is valid but status is not retired, delete it
                             userData.fechaRetiro = firebase.firestore.FieldValue.delete();
                         } else if (!userData.hasOwnProperty('fechaRetiro') && userData.estado === 'retirado') {
                             // If status is retired but no fechaRetiro was provided, add current date
                             userData.fechaRetiro = new Date(); // Will be converted to Timestamp
                         }


                        // If the row is valid, prepare it for the batch
                        if (isValidRow) {
                            // Convert Date objects to Firestore Timestamps
                             if (userData.fecha instanceof Date) {
                                 userData.fecha = firebase.firestore.Timestamp.fromDate(userData.fecha);
                             }
                             if (userData.fechaRetiro instanceof Date) {
                                  userData.fechaRetiro = firebase.firestore.Timestamp.fromDate(userData.fechaRetiro);
                             }


                            // Add mandatory fields that might not be in Excel or might be empty
                             if (!userData.hasOwnProperty('estado')) {
                                 userData.estado = 'activo'; // Default status if not in Excel
                             }


                            // Add metadata fields
                            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            userData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

                             console.log(`Data prepared for Firestore (Row ${rowNumber}):`, userData); // Log data before saving

                            // Create a new document reference and add the operation to the batch
                            const newUserRef = usersCollection.doc();
                            userBatch.set(newUserRef, userData);
                            importedCount++;
                        } else {
                            errorCount++;
                            importErrors.push(`Fila ${rowNumber}: ${rowErrors.join(', ')}`);
                             console.error(`Validation errors in Row ${rowNumber}:`, rowErrors); // Log row errors
                        }
                    }

                    // Execute the user batch
                    if (importedCount > 0) {
                        showImportStatusMessage(`Guardando ${importedCount} usuarios...`, 'info');
                        try {
                            await userBatch.commit();
                            let finalMessage = `Importación completada. ${importedCount} usuarios agregados con éxito.`;
                            if (errorCount > 0) {
                                finalMessage += ` ${errorCount} filas con errores.`;
                                console.error("Import Errors Summary:", importErrors);
                                // You could show errors in a text area or additional modal if there are many
                                alert("Errores de importación:\n" + importErrors.join('\n')); // Simple alert for now
                            }
                            showImportStatusMessage(finalMessage, errorCount === 0 ? 'success' : 'info');

                            // Optional: Reload the table after import (onSnapshot should handle it)
                             // loadUsersTable();

                        } catch (batchError) {
                            console.error("Error saving user batch to Firestore:", batchError);
                            showImportStatusMessage('Error al guardar datos de usuarios en la base de datos: ' + batchError.message, 'error');
                        }
                    } else if (errorCount > 0) {
                         showImportStatusMessage(`No se agregaron usuarios. ${errorCount} filas con errores.`, 'error');
                         console.error("Import Errors Summary:", importErrors);
                         alert("Errores de importación:\n" + importErrors.join('\n'));
                    }
                    else {
                        showImportStatusMessage('No se encontraron datos válidos para importar.', 'info');
                    }


                } catch (parseError) {
                    console.error("Error reading or parsing the Excel file:", parseError);
                    showImportStatusMessage('Error al leer o procesar el archivo: ' + parseError.message, 'error');
                } finally {
                    processImportButton.disabled = false; // Enable button again
                    excelFileInput.value = null; // Clear the file input
                }
            };

            reader.onerror = (error) => {
                console.error("Error reading the file:", error);
                showImportStatusMessage('Error al leer el archivo.', 'error');
                processImportButton.disabled = false;
                 excelFileInput.value = null; // Clear the file input
            };

            reader.readAsArrayBuffer(file); // Read the file as ArrayBuffer
        });


        // --- Funcionalidad de Agregar Pago ---

        // Mostrar modal de agregar pago
        async function showAddPaymentModal(userId) {
             paymentUserIdInput.value = userId;
             // Cargar datos del usuario para obtener el valor a pagar
             const userDoc = allUserDocs.find(doc => doc.id === userId);
             if (userDoc) {
                  const userData = userDoc.data();
                  paymentValueInput.value = userData.valorAPagar || 0; // Rellenar valor a pagar
                  // Establecer fecha actual por defecto
                  paymentDateInput.valueAsDate = new Date();
             } else {
                  paymentValueInput.value = 0;
                  paymentDateInput.value = '';
                  console.error("Usuario no encontrado para agregar pago:", userId);
                  showStatusMessage('Error: No se pudieron cargar los datos del usuario para el pago.', 'error');
                  return; // No abrir modal si no se carga el usuario
             }

             // Cargar historial de pagos reciente (ej. últimos 5)
             await loadPaymentHistory(userId, paymentHistoryList, 5);
             viewAllPaymentsButton.style.display = 'block'; // Mostrar botón de ver todo

             addPaymentModal.classList.add('show');
        }

        // Ocultar modal de agregar pago
        function hideAddPaymentModal() {
             addPaymentModal.classList.remove('show');
             addPaymentForm.reset(); // Resetear formulario
             paymentHistoryList.innerHTML = ''; // Limpiar historial al cerrar
             viewAllPaymentsButton.style.display = 'none'; // Ocultar botón de ver todo
        }

        // Listeners para cerrar modal de agregar pago
        closeAddPaymentModalButton.addEventListener('click', hideAddPaymentModal);
        cancelAddPaymentButton.addEventListener('click', hideAddPaymentModal);
        addPaymentModal.addEventListener('click', (e) => {
             if (e.target === addPaymentModal) {
                 hideAddPaymentModal();
             }
        });

        // Listener para guardar nuevo pago
        addPaymentForm.addEventListener('submit', async (e) => {
             e.preventDefault();

             const userId = paymentUserIdInput.value;
             const paymentDateString = paymentDateInput.value;
             const paymentValue = parseFloat(paymentValueInput.value);
             const paymentNovelty = paymentNoveltySelect.value;

             if (!userId || !paymentDateString || isNaN(paymentValue) || paymentValue <= 0 || !paymentNovelty) {
                 showStatusMessage('Por favor, completa todos los campos del pago correctamente.', 'error');
                 return;
             }

             // Convertir string de fecha a Timestamp (UTC)
             const paymentDate = new Date(paymentDateString + 'T00:00:00Z');
             const paymentTimestamp = firebase.firestore.Timestamp.fromDate(paymentDate);


             const newPayment = {
                 userId: userId,
                 fecha: paymentTimestamp, // Guardar como Timestamp
                 valor: paymentValue,
                 novedad: paymentNovelty,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
             };

             showStatusMessage('Guardando pago...', 'info');

             try {
                 console.log("Attempting to save payment:", newPayment); // Log data before saving
                 await pagosCollection.add(newPayment);
                 showStatusMessage('Pago guardado con éxito!', 'success');
                 addPaymentForm.reset(); // Resetear formulario después de guardar
                 paymentValueInput.value = currentUserData.valorAPagar || 0; // Restablecer valor a pagar por defecto
                 paymentDateInput.valueAsDate = new Date(); // Restablecer fecha actual

                 // Recargar historial de pagos en el modal
                 await loadPaymentHistory(userId, paymentHistoryList, 5);

             } catch (error) {
                 console.error("Error al guardar pago:", error);
                 showStatusMessage('Error al guardar pago: ' + error.message, 'error'); // Show specific error message
             }
        });

        // Función para cargar y mostrar historial de pagos
        async function loadPaymentHistory(userId, listElement, limit = null) {
             console.log(`loadPaymentHistory called for userId: ${userId}, limit: ${limit}`); // Debugging start
             listElement.innerHTML = '<li>Cargando historial...</li>'; // Show loading message immediately
             try {
                 let query = pagosCollection.where('userId', '==', userId).orderBy('fecha', 'desc');
                 if (limit) {
                     query = query.limit(limit);
                 }
                 console.log("loadPaymentHistory: Executing query for userId:", userId); // Log the query execution
                 const snapshot = await query.get();

                 console.log(`loadPaymentHistory: Fetched ${snapshot.docs.length} payment documents for userId ${userId}.`); // Debugging count

                 listElement.innerHTML = ''; // Clear loading message

                 if (snapshot.empty) {
                     listElement.innerHTML = '<li>No hay historial de pagos para este usuario.</li>';
                     console.log("loadPaymentHistory: No payment history found for userId", userId); // Debugging empty
                     return;
                 }

                 snapshot.forEach(doc => {
                     const payment = doc.data();
                     console.log("loadPaymentHistory: Processing payment doc:", doc.id, payment); // Debugging each doc
                     const listItem = document.createElement('li');
                     listItem.dataset.id = doc.id; // Guardar el ID del pago
                     listItem.dataset.userId = userId; // Guardar el ID del usuario

                     // Mostrar fecha formateada, valor y novedad
                     listItem.innerHTML = `
                         <span>Fecha: ${formatDate(payment.fecha)}</span>
                         <span>Valor: ${formatCurrency(payment.valor)}</span>
                         <span>Novedad: ${payment.novedad || 'N/A'}</span>
                          <div class="history-item-actions">
                             <button class="action-button edit-payment-button" data-id="${doc.id}" data-user-id="${userId}" title="Editar Pago"><i class="fas fa-edit"></i></button>
                             <button class="action-button delete-payment-button" data-id="${doc.id}" data-user-id="${userId}" title="Eliminar Pago"><i class="fas fa-trash-alt"></i></button>
                         </div>
                     `;
                     listElement.appendChild(listItem);
                 });
                 console.log("loadPaymentHistory: History list populated."); // Debugging end successful
             } catch (error) {
                 console.error(`Error al cargar historial de pagos para userId ${userId}:`, error);
                 listElement.innerHTML = '<li>Error al cargar historial de pagos.</li>';
                 showStatusMessage('Error al cargar historial de pagos: ' + error.message, 'error'); // Show specific error message
             }
        }

         // Listener para los botones de acción en las listas de historial de pagos (usando delegación)
         // Esto cubre tanto la lista reciente como la lista completa
         document.querySelectorAll('#payment-history-list, #full-payment-history-list').forEach(list => {
              list.addEventListener('click', async (e) => {
                   const target = e.target;
                   const paymentId = target.dataset.id || target.closest('button')?.dataset.id;
                   const userId = target.dataset.userId || target.closest('li')?.dataset.userId; // Get userId from listItem

                   if (!paymentId || !userId) return;

                   if (target.classList.contains('edit-payment-button')) {
                        // Acción: Editar Pago
                        console.log("Editar Pago clickeado:", paymentId);
                        await loadPaymentDataForEdit(paymentId, userId);
                        showEditPaymentModal();

                   } else if (target.classList.contains('delete-payment-button')) {
                        // Acción: Eliminar Pago
                        console.log("Eliminar Pago clickeado:", paymentId);
                        if (confirm('¿Estás seguro de que deseas eliminar este pago?')) {
                             deletePayment(paymentId, userId);
                        }
                   }
              });
         });


        // Listener para el botón "Ver Historial Completo" de pagos
        viewAllPaymentsButton.addEventListener('click', () => {
             const userId = paymentUserIdInput.value;
             if (userId) {
                 hideAddPaymentModal(); // Ocultar el modal de agregar pago
                 showPaymentHistoryModal(userId); // Mostrar el modal de historial completo
             }
        });

         // Mostrar modal de historial de pagos completo
         async function showPaymentHistoryModal(userId) {
              paymentHistoryModalTitle.textContent = `Historial de Pagos de ${currentUserData.nombre || 'Usuario'}`;
              await loadPaymentHistory(userId, fullPaymentHistoryList); // Cargar todos los pagos
              paymentHistoryModal.classList.add('show');
         }

         // Ocultar modal de historial de pagos completo
         function hidePaymentHistoryModal() {
              paymentHistoryModal.classList.remove('show');
              fullPaymentHistoryList.innerHTML = ''; // Limpiar lista al cerrar
         }

         // Listeners para cerrar modal de historial de pagos completo
         closePaymentHistoryModalButton.addEventListener('click', hidePaymentHistoryModal);
         closePaymentHistoryModalButtonInModal.addEventListener('click', hidePaymentHistoryModal);
         paymentHistoryModal.addEventListener('click', (e) => {
              if (e.target === paymentHistoryModal) {
                  hidePaymentHistoryModal();
              }
         });

         // --- Funcionalidad de Editar Pago ---

         // Mostrar modal de editar pago
         function showEditPaymentModal() {
             editPaymentModal.classList.add('show');
         }

         // Ocultar modal de editar pago
         function hideEditPaymentModal() {
             editPaymentModal.classList.remove('show');
             editPaymentForm.reset(); // Resetear formulario
         }

         // Listeners para cerrar modal de editar pago
         closeEditPaymentModalButton.addEventListener('click', hideEditPaymentModal);
         cancelEditPaymentButton.addEventListener('click', hideEditPaymentModal);
         editPaymentModal.addEventListener('click', (e) => {
             if (e.target === editPaymentModal) {
                 hideEditPaymentModal();
             }
         });

         // Cargar datos de un pago en el modal de edición
         async function loadPaymentDataForEdit(paymentId, userId) {
              try {
                   const paymentDoc = await pagosCollection.doc(paymentId).get();
                   if (paymentDoc.exists) {
                        const paymentData = paymentDoc.data();
                        console.log("Datos del pago cargados para edición:", paymentData);

                        editPaymentIdInput.value = paymentId;
                        editPaymentUserIdInput.value = userId; // Store userId
                        editPaymentDateInput.value = formatDate(paymentData.fecha);
                        editPaymentValueInput.value = paymentData.valor || 0;
                        editPaymentNoveltySelect.value = paymentData.novedad || '';

                   } else {
                        console.error("Pago no encontrado para edición:", paymentId);
                        showStatusMessage('Error: Pago no encontrado para editar.', 'error');
                        hideEditPaymentModal();
                   }
              } catch (error) {
                   console.error("Error al cargar datos del pago para edición:", error);
                   showStatusMessage('Error al cargar datos del pago para edición.', 'error');
                   hideEditPaymentModal();
              }
         }

         // Listener para guardar cambios del formulario de edición de pago
         editPaymentForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const paymentId = editPaymentIdInput.value;
              const userId = editPaymentUserIdInput.value; // Get userId
              const paymentDateString = editPaymentDateInput.value;
              const paymentValue = parseFloat(editPaymentValueInput.value);
              const paymentNovelty = editPaymentNoveltySelect.value;

              if (!paymentId || !userId || !paymentDateString || isNaN(paymentValue) || paymentValue <= 0 || !paymentNovelty) {
                  showStatusMessage('Por favor, completa todos los campos del pago correctamente.', 'error');
                  return;
              }

              const paymentDate = new Date(paymentDateString + 'T00:00:00Z');
              const paymentTimestamp = firebase.firestore.Timestamp.fromDate(paymentDate);


              const updatedData = {
                  fecha: paymentTimestamp,
                  valor: paymentValue,
                  novedad: paymentNovelty,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };

              showStatusMessage('Guardando cambios del pago...', 'info');

              try {
                  await pagosCollection.doc(paymentId).update(updatedData);
                  showStatusMessage('Cambios del pago guardados con éxito!', 'success');
                  hideEditPaymentModal();

                  // Recargar el historial de pagos en el modal visible
                  if (addPaymentModal.classList.contains('show')) {
                       await loadPaymentHistory(userId, paymentHistoryList, 5);
                  } else if (paymentHistoryModal.classList.contains('show')) {
                       await loadPaymentHistory(userId, fullPaymentHistoryList);
                  }

              } catch (error) {
                  console.error("Error al guardar cambios del pago:", error);
                  showStatusMessage('Error al guardar cambios del pago: ' + error.message, 'error');
              }
         });

         // Función para eliminar un pago
         async function deletePayment(paymentId, userId) {
              showStatusMessage('Eliminando pago...', 'info');
              try {
                  await pagosCollection.doc(paymentId).delete();
                  showStatusMessage('Pago eliminado con éxito!', 'success');

                  // Recargar el historial de pagos en el modal visible
                  if (addPaymentModal.classList.contains('show')) {
                       await loadPaymentHistory(userId, paymentHistoryList, 5);
                  } else if (paymentHistoryModal.classList.contains('show')) {
                       await loadPaymentHistory(userId, fullPaymentHistoryList);
                  }

              } catch (error) {
                  console.error("Error al eliminar pago:", error);
                  showStatusMessage('Error al eliminar pago: ' + error.message, 'error');
              }
         }


        // --- Funcionalidad de Facturación ---

        // Mostrar modal de facturación
        async function showBillingModal(userId) {
             billingUserIdInput.value = userId;
             // Limpiar y ocultar sección de factura generada
             generatedInvoiceDetails.innerHTML = '';
             generatedInvoiceSection.style.display = 'none';
             saveInvoiceButton.style.display = 'none'; // Ocultar botón de guardar
             generateGeneratedPdfButton.style.display = 'none'; // Ocultar botón de PDF generado (el de la factura actual)

             // Cargar historial de facturas reciente (ej. últimos 3)
             await loadInvoiceHistory(userId, invoiceHistoryList, 3);
             viewAllInvoicesButton.style.display = 'block'; // Mostrar botón de ver todo

             billingModal.classList.add('show');
        }

        // Ocultar modal de facturación
        function hideBillingModal() {
             billingModal.classList.remove('show');
             billingForm.reset(); // Resetear formulario
             generatedInvoiceDetails.innerHTML = ''; // Limpiar detalles de factura
             generatedInvoiceSection.style.display = 'none'; // Ocultar sección de factura generada
             saveInvoiceButton.style.display = 'none'; // Ocultar botón de guardar
             generateGeneratedPdfButton.style.display = 'none'; // Ocultar botón de PDF generado
             invoiceHistoryList.innerHTML = ''; // Limpiar historial al cerrar
             viewAllInvoicesButton.style.display = 'none'; // Ocultar botón de ver todo
        }

        // Listeners para cerrar modal de facturación
        closeBillingModalButton.addEventListener('click', hideBillingModal);
        billingModal.addEventListener('click', (e) => {
             if (e.target === billingModal) {
                 hideBillingModal();
             }
        });

        // Listener para generar factura
        generateInvoiceButton.addEventListener('click', async () => {
             const userId = billingUserIdInput.value;
             const startDateString = billingStartDateInput.value;
             const endDateString = billingEndDateInput.value;

             if (!userId || !startDateString || !endDateString) {
                 showStatusMessage('Por favor, selecciona las fechas de inicio y fin.', 'error');
                 return;
             }

             // CORRECCIÓN: Manejo de fechas para evitar desfase de un día
             // Parsear las fechas como fechas locales para asegurar que el día seleccionado se mantenga
             const startDateParts = startDateString.split('-');
             const startDate = new Date(parseInt(startDateParts[0]), parseInt(startDateParts[1]) - 1, parseInt(startDateParts[2])); // Year, Month (0-indexed), Day

             const endDateParts = endDateString.split('-');
             const endDate = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]) - 1, parseInt(endDateParts[2])); // Year, Month (0-indexed), Day

             // Ajustar la hora de fin para incluir todo el día
             endDate.setHours(23, 59, 59, 999);


             if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) {
                 showStatusMessage('Las fechas seleccionadas no son válidas.', 'error');
                 return;
             }

             showStatusMessage('Generando factura...', 'info');

             try {
                 // Obtener datos actualizados del usuario
                 const userDoc = await usersCollection.doc(userId).get();
                 if (!userDoc.exists) {
                     showStatusMessage('Error: Datos del usuario no encontrados para facturar.', 'error');
                     return;
                 }
                 const userData = userDoc.data();
                 currentUserData = userData; // Actualizar datos del usuario actual
                 currentUserData.id = userDoc.id;


                 // Generar código único de factura (Ejemplo: timestamp + 4 dígitos aleatorios)
                 const timestampPart = Date.now();
                 const randomPart = Math.floor(1000 + Math.random() * 9000); // Número aleatorio entre 1000 y 9999
                 const invoiceCode = `${timestampPart}-${randomPart}`;

                 // Obtener nombres de entidades para la factura
                 const empresaNombre = empresasMap.get(userData.empresaId) || 'Desconocida';
                 const asesorNombre = asesoresMap.get(userData.asesorId) || 'Desconocido';
                 const arlNombre = arlMap.get(userData.arlId) || 'Desconocida';
                 const epsNombre = epsMap.get(userData.epsId) || 'Desconocida';
                 const ccfNombre = ccfMap.get(userData.ccfId) || 'Desconocida';
                 const afpNombre = afpMap.get(userData.afpId) || 'Desconocida';


                 // --- Lógica de cálculo de factura (Simplificada) ---
                 // Aquí asumimos que el valor a pagar es por el período seleccionado.
                 // Si la lógica de facturación es más compleja (ej. por días, por servicios),
                 // necesitarías implementar esa lógica aquí, posiblemente consultando otros datos.
                 const valorFacturado = userData.valorAPagar || 0; // Usamos el valor a pagar del usuario como base

                 // Formatear fechas para mostrar en la factura (usando las fechas locales creadas)
                 const formattedStartDate = formatDate(startDate); // formatDate funciona bien con Date objects
                 const formattedEndDate = formatDate(endDate);


                 // Construir los detalles de la factura para mostrar
                 let invoiceDetailsText = `
                     FACBA - Factura
                     -------------------------------------
                     Código de Factura: ${invoiceCode}
                     Fecha de Generación: ${formatDateTime(firebase.firestore.Timestamp.fromDate(new Date()))}
                     Período Facturado: ${formattedStartDate} al ${formattedEndDate}

                     -------------------------------------
                     Datos del Usuario:
                     Nombre: ${userData.nombre || 'Sin Nombre'}
                     Identificación: ${userData.identificacion || 'N/A'} (${userData.tipoIdentificacion || 'N/A'})
                     Estado: ${userData.estado || 'N/A'}

                     -------------------------------------
                     Datos de Entidades Asociadas:
                     Empresa: ${empresaNombre}
                     Asesor: ${asesorNombre}
                     ARL: ${arlNombre} ${userData.riesgo ? `(Riesgo: ${userData.riesgo})` : ''}
                     EPS: ${epsNombre}
                     CCF: ${ccfNombre}
                     AFP: ${afpNombre}

                     -------------------------------------
                     Detalle del Servicio:
                     Servicio de Afiliación y Gestión
                     Valor Base (según usuario): ${formatCurrency(userData.valorAPagar || 0)}
                     IBC (según usuario): ${formatCurrency(userData.ibc || 0)}

                     -------------------------------------
                     TOTAL A PAGAR: ${formatCurrency(valorFacturado)}
                     -------------------------------------
                 `.trim(); // Usar trim() para eliminar espacios extra al inicio/fin


                 // Mostrar los detalles de la factura generada
                 generatedInvoiceDetails.textContent = invoiceDetailsText;
                 generatedInvoiceSection.style.display = 'block'; // Mostrar la sección
                 saveInvoiceButton.style.display = 'inline-block'; // Mostrar botón de guardar
                 generateGeneratedPdfButton.style.display = 'inline-block'; // Mostrar botón de PDF generado (el de la factura actual)

                 showStatusMessage('Factura generada. Revísala y guarda.', 'success');

             } catch (error) {
                 console.error("Error al generar factura:", error);
                 showStatusMessage('Error al generar factura: ' + error.message, 'error'); // Show specific error message
                 generatedInvoiceDetails.innerHTML = 'Error al generar factura.';
                 generatedInvoiceSection.style.display = 'block';
                 saveInvoiceButton.style.display = 'none';
                 generateGeneratedPdfButton.style.display = 'none'; // Ocultar botón de PDF generado en caso de error
             }
        });

        // Listener para guardar factura
        saveInvoiceButton.addEventListener('click', async () => {
             const userId = billingUserIdInput.value;
             const startDateString = billingStartDateInput.value;
             const endDateString = billingEndDateInput.value;
             const invoiceDetails = generatedInvoiceDetails.textContent; // Obtener el texto mostrado

             if (!userId || !startDateString || !endDateString || !invoiceDetails || invoiceDetails.includes('Error al generar factura')) {
                 showStatusMessage('No hay una factura válida para guardar.', 'error');
                 return;
             }

             // Extraer el código de factura del texto generado (buscar la línea "Código de Factura:")
             const invoiceCodeMatch = invoiceDetails.match(/Código de Factura: (.+)/);
             const invoiceCode = invoiceCodeMatch ? invoiceCodeMatch[1].trim() : 'SIN_CODIGO'; // Usar el código encontrado o un placeholder


             // CORRECCIÓN: Guardar fechas como Timestamps a partir de las fechas locales creadas
             const startDateParts = startDateString.split('-');
             const startDate = new Date(parseInt(startDateParts[0]), parseInt(startDateParts[1]) - 1, parseInt(startDateParts[2])); // Year, Month (0-indexed), Day

             const endDateParts = endDateString.split('-');
             const endDate = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]) - 1, parseInt(endDateParts[2])); // Year, Month (0-indexed), Day
             endDate.setHours(23, 59, 59, 999); // Ajustar hora de fin


             const newInvoice = {
                 userId: userId,
                 codigo: invoiceCode, // Guardar el código único
                 fechaInicio: firebase.firestore.Timestamp.fromDate(startDate), // Guardar fechas como Timestamp
                 fechaFin: firebase.firestore.Timestamp.fromDate(endDate), // Guardar fechas como Timestamp
                 detalles: invoiceDetails, // Guardar los detalles completos como texto
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
             };

             showStatusMessage('Guardando factura...', 'info');

             try {
                 console.log("Attempting to save invoice:", newInvoice); // Log data before saving
                 await facturasCollection.add(newInvoice);
                 showStatusMessage('Factura guardada con éxito!', 'success');
                 // Opcional: Limpiar la sección de factura generada después de guardar
                 generatedInvoiceDetails.innerHTML = '';
                 generatedInvoiceSection.style.display = 'none';
                 saveInvoiceButton.style.display = 'none';
                 generateGeneratedPdfButton.style.display = 'none'; // Ocultar botón de PDF generado
                 billingForm.reset(); // Resetear formulario de fechas

                 // Recargar historial de facturas en el modal
                 await loadInvoiceHistory(userId, invoiceHistoryList, 3);


             } catch (error) {
                 console.error("Error al guardar factura:", error);
                 showStatusMessage('Error al guardar factura: ' + error.message, 'error'); // Show specific error message
             }
        });

        // Listener para ver historial de facturas completo
        viewAllInvoicesButton.addEventListener('click', () => {
             const userId = billingUserIdInput.value;
             if (userId) {
                 hideBillingModal(); // Ocultar el modal de agregar pago
                 showInvoiceHistoryModal(userId); // Mostrar el modal de historial completo
             }
        });

         // Mostrar modal de historial de facturas completo
         async function showInvoiceHistoryModal(userId) {
              invoiceHistoryModalTitle.textContent = `Historial de Facturas de ${currentUserData.nombre || 'Usuario'}`;
              await loadInvoiceHistory(userId, fullInvoiceHistoryList); // Cargar todas las facturas
              invoiceHistoryModal.classList.add('show');
         }

         // Ocultar modal de historial de facturas completo
         function hideInvoiceHistoryModal() {
              invoiceHistoryModal.classList.remove('show');
              fullInvoiceHistoryList.innerHTML = ''; // Limpiar lista al cerrar
         }

         // Listeners para cerrar modal de historial de facturas completo
         closeInvoiceHistoryModalButton.addEventListener('click', hideInvoiceHistoryModal);
         closeInvoiceHistoryModalButtonInModal.addEventListener('click', hideInvoiceHistoryModal);
         invoiceHistoryModal.addEventListener('click', (e) => {
              if (e.target === invoiceHistoryModal) {
                  hideInvoiceHistoryModal();
              }
         });


        // Función para cargar y mostrar historial de facturas
        async function loadInvoiceHistory(userId, listElement, limit = null) {
             console.log(`loadInvoiceHistory called for userId: ${userId}, limit: ${limit}`); // Debugging start
             listElement.innerHTML = '<li>Cargando historial...</li>'; // Show loading message immediately
             try {
                 let query = facturasCollection.where('userId', '==', userId).orderBy('createdAt', 'desc');
                 if (limit) {
                     query = query.limit(limit);
                 }
                 console.log("loadInvoiceHistory: Executing query for userId:", userId); // Log the query execution
                 const snapshot = await query.get();

                 console.log(`loadInvoiceHistory: Fetched ${snapshot.docs.length} invoice documents for userId ${userId}.`); // Debugging count

                 listElement.innerHTML = ''; // Clear loading message

                 if (snapshot.empty) {
                     listElement.innerHTML = '<li>No hay historial de facturas para este usuario.</li>';
                     console.log("loadInvoiceHistory: No invoice history found for userId", userId); // Debugging empty
                     return;
                 }

                 snapshot.forEach(doc => {
                     const invoice = doc.data();
                      console.log("loadInvoiceHistory: Processing invoice doc:", doc.id, invoice); // Debugging each doc
                     const listItem = document.createElement('li');
                     listItem.dataset.id = doc.id; // Guardar el ID de la factura
                     listItem.dataset.userId = userId; // Guardar el ID del usuario

                     // Mostrar resumen de la factura y botones de acción
                     listItem.innerHTML = `
                         <div class="invoice-summary">
                             <strong>Factura #${invoice.codigo || 'N/A'}</strong><br>
                             Período: ${formatDate(invoice.fechaInicio)} al ${formatDate(invoice.fechaFin)}<br>
                             Fecha Guardada: ${formatDateTime(invoice.createdAt)}
                         </div>
                         <div class="invoice-actions">
                             <button class="action-button view-invoice-details-button" data-id="${doc.id}" data-user-id="${userId}" title="Ver Detalles">Ver Detalles</button>
                             <button class="action-button generate-invoice-pdf-button" data-id="${doc.id}" data-user-id="${userId}" title="Generar PDF"><i class="fas fa-file-pdf"></i> PDF</button>
                             <button class="action-button edit-invoice-button" data-id="${doc.id}" data-user-id="${userId}" title="Editar Factura"><i class="fas fa-edit"></i></button>
                              <button class="action-button delete-invoice-button" data-id="${doc.id}" data-user-id="${userId}" title="Eliminar Factura"><i class="fas fa-trash-alt"></i></button>
                             </div>
                         <i class="fas fa-cog gear-icon" data-id="${doc.id}" data-user-id="${userId}" title="Mostrar Acciones"></i>
                     `;
                     listElement.appendChild(listItem);
                 });
                 console.log("loadInvoiceHistory: History list populated."); // Debugging end successful

             } catch (error) {
                 console.error(`Error al cargar historial de facturas para userId ${userId}:`, error);
                 listElement.innerHTML = '<li>Error al cargar historial de facturas.</li>';
                 showStatusMessage('Error al cargar historial de facturas: ' + error.message, 'error'); // Show specific error message
             }
        }

         // Listener para botones de acción en el historial de facturas (usando delegación)
         // Esto cubre tanto la lista reciente como la lista completa
         document.querySelectorAll('#invoice-history-list, #full-invoice-history-list').forEach(list => {
              list.addEventListener('click', async (e) => {
                   const target = e.target;
                   const invoiceId = target.dataset.id || target.closest('button')?.dataset.id || target.closest('.gear-icon')?.dataset.id; // Get ID from button or gear icon
                   const userId = target.dataset.userId || target.closest('li')?.dataset.userId || target.closest('.gear-icon')?.dataset.userId; // Get userId from list item or gear icon

                   if (!invoiceId || !userId) return;

                   const listItem = target.closest('li');
                   const invoiceActionsContainer = listItem ? listItem.querySelector('.invoice-actions') : null;
                   const gearIcon = listItem ? listItem.querySelector('.gear-icon') : null;


                   if (target.classList.contains('gear-icon')) {
                        // Acción de mostrar/ocultar botones al hacer clic en la tuerca
                        console.log("Gear icon clicked for invoice:", invoiceId);
                        // Ocultar todos los contenedores de acciones de factura abiertos
                        document.querySelectorAll('#invoice-history-list li .invoice-actions.show, #full-invoice-history-list li .invoice-actions.show').forEach(container => {
                             container.classList.remove('show');
                             // Mostrar la tuerca correspondiente
                             const parentItem = container.closest('li');
                             if (parentItem) {
                                  parentItem.querySelector('.gear-icon').style.display = 'inline-block';
                             }
                        });

                        // Mostrar el contenedor de acciones para este item de factura
                        if (invoiceActionsContainer && gearIcon) {
                             invoiceActionsContainer.classList.add('show');
                             gearIcon.style.display = 'none'; // Ocultar la tuerca
                        }

                   } else if (target.closest('.action-button')) {
                        // Es un botón de acción dentro del historial de facturas
                        const actionButton = target.closest('.action-button');

                        // Ocultar los botones de acción después de la acción
                        if (invoiceActionsContainer && gearIcon) {
                             invoiceActionsContainer.classList.remove('show');
                             gearIcon.style.display = 'inline-block'; // Mostrar la tuerca de nuevo
                        }


                        if (actionButton.classList.contains('view-invoice-details-button')) {
                             // Acción: Ver Detalles de Factura
                             console.log("Ver Detalles de Factura clickeado:", invoiceId);
                             await viewInvoiceDetails(invoiceId); // Reusing the existing view function

                        } else if (actionButton.classList.contains('generate-invoice-pdf-button')) {
                             // Acción: Generar PDF de Factura
                             console.log("Generar PDF de Factura clickeado:", invoiceId);
                             await generateInvoicePdf(invoiceId);

                        } else if (actionButton.classList.contains('edit-invoice-button')) {
                            // NUEVO: Acción Editar Factura
                            console.log("Editar Factura clickeado:", invoiceId);
                            await loadInvoiceDataForEdit(invoiceId, userId);
                            showEditInvoiceModal();

                        } else if (actionButton.classList.contains('delete-invoice-button')) {
                            // NUEVO: Acción Eliminar Factura
                            console.log("Eliminar Factura clickeado:", invoiceId);
                            if (confirm('¿Estás seguro de que deseas eliminar esta factura?')) {
                                deleteInvoice(invoiceId, userId);
                            }
                        }
                   }
              });
         });


         // Función para ver detalles de una factura específica (podría abrir un modal o mostrar en un área)
         async function viewInvoiceDetails(invoiceId) {
             showStatusMessage('Cargando detalles de factura...', 'info');
             try {
                 const invoiceDoc = await facturasCollection.doc(invoiceId).get();
                 if (invoiceDoc.exists) {
                     const invoiceData = invoiceDoc.data();
                     console.log("Detalles de factura cargados:", invoiceData);
                     // Mostrar los detalles en un alert simple por ahora
                     // En una aplicación real, usarías un modal dedicado o una sección
                     alert("Detalles de Factura:\n\n" + invoiceData.detalles);
                     showStatusMessage('Detalles de factura cargados.', 'success');
                 } else {
                     showStatusMessage('Factura no encontrada.', 'error');
                 }
             } catch (error) {
                 console.error("Error al cargar detalles de factura:", error);
                 showStatusMessage('Error al cargar detalles de factura: ' + error.message, 'error');
             }
         }

         // Función para generar PDF de una factura específica (desde el historial)
         async function generateInvoicePdf(invoiceId) {
             showStatusMessage('Generando PDF...', 'info');
             try {
                 const invoiceDoc = await facturasCollection.doc(invoiceId).get();
                 if (!invoiceDoc.exists) {
                     showStatusMessage('Factura no encontrada para generar PDF.', 'error');
                     return;
                 }
                 const invoiceData = invoiceDoc.data();
                 console.log("Datos de factura para PDF:", invoiceData); // Debugging PDF data

                 // Usar jsPDF para crear el PDF
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();

                 // --- INICIO: Generación de PDF Moderno ---
                 const primaryColor = '#4f46e5'; // Indigo 600
                 const secondaryColor = '#eef2ff'; // Indigo 100
                 const textColor = '#1f2937'; // Gray 800
                 const accentColor = '#10b981'; // Green 500

                 const margin = 15;
                 let y = margin;
                 const pageWidth = doc.internal.pageSize.getWidth();

                 // Header
                 doc.setFillColor(primaryColor);
                 doc.rect(0, 0, pageWidth, 20, 'F'); // Colored header band
                 doc.setFontSize(18);
                 doc.setTextColor(255); // White text
                 doc.text("Factura FACBA", margin, 13);

                 y = 30; // Start content below header

                 // Invoice Info
                 doc.setFontSize(12);
                 doc.setTextColor(textColor);
                 doc.setFont(undefined, 'bold');
                 doc.text(`Código de Factura:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${invoiceData.codigo || 'N/A'}`, margin + 45, y);
                 y += 7;

                 doc.setFont(undefined, 'bold');
                 doc.text(`Fecha de Generación:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${formatDateTime(invoiceData.createdAt)}`, margin + 45, y);
                 y += 7;

                 doc.setFont(undefined, 'bold');
                 doc.text(`Período Facturado:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${formatDate(invoiceData.fechaInicio)} al ${formatDate(invoiceData.fechaFin)}`, margin + 45, y);
                 y += 15;

                 // User Data Section
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Datos del Usuario", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor); // Line under section title
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 doc.setFontSize(12);
                 doc.setFont(undefined, 'normal');
                 // Extract user data from the details text (less reliable, consider fetching user data directly if needed)
                 const nombreMatch = invoiceData.detalles.match(/Nombre: (.+)/);
                 const identificacionMatch = invoiceData.detalles.match(/Identificación: (.+)/);
                 const estadoMatch = invoiceData.detalles.match(/Estado: (.+)/);

                 doc.text(`Nombre: ${nombreMatch ? nombreMatch[1].trim() : 'Sin Nombre'}`, margin, y);
                 y += 7;
                 doc.text(`Identificación: ${identificacionMatch ? identificacionMatch[1].trim() : 'N/A'}`, margin, y);
                 y += 7;
                 doc.text(`Estado: ${estadoMatch ? estadoMatch[1].trim() : 'N/A'}`, margin, y);
                 y += 15;

                 // Associated Entities Section
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Datos de Entidades Asociadas", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor);
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 doc.setFontSize(12);
                 doc.setFont(undefined, 'normal');
                 // Extract entity data from the details text
                 const empresaMatch = invoiceData.detalles.match(/Empresa: (.+)/);
                 const asesorMatch = invoiceData.detalles.match(/Asesor: (.+)/);
                 const arlMatch = invoiceData.detalles.match(/ARL: (.+)/);
                 const epsMatch = invoiceData.detalles.match(/EPS: (.+)/);
                 const ccfMatch = invoiceData.detalles.match(/CCF: (.+)/);
                 const afpMatch = invoiceData.detalles.match(/AFP: (.+)/);


                 doc.text(`Empresa: ${empresaMatch ? empresaMatch[1].trim() : 'Desconocida'}`, margin, y);
                 y += 7;
                 doc.text(`Asesor: ${asesorMatch ? asesorMatch[1].trim() : 'Desconocido'}`, margin, y);
                 y += 7;
                 doc.text(`ARL: ${arlMatch ? arlMatch[1].trim() : 'Desconocida'}`, margin, y); // Use extracted ARL info
                 y += 7;
                 doc.text(`EPS: ${epsMatch ? epsMatch[1].trim() : 'Desconocida'}`, margin, y);
                 y += 7;
                 doc.text(`CCF: ${ccfMatch ? ccfMatch[1].trim() : 'Desconocida'}`, margin, y);
                 y += 7;
                 doc.text(`AFP: ${afpMatch ? afpMatch[1].trim() : 'Desconocida'}`, margin, y);
                 y += 15;

                 // Service Details Section (Using autoTable for a cleaner look)
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Detalle del Servicio", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor);
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 // Extract service details from the text
                 const valorBaseMatch = invoiceData.detalles.match(/Valor Base \(según usuario\): (.+)/);
                 const ibcMatch = invoiceData.detalles.match(/IBC \(según usuario\): (.+)/);

                 const tableData = [
                     ['Servicio de Afiliación y Gestión', valorBaseMatch ? valorBaseMatch[1].trim() : 'N/A', ibcMatch ? ibcMatch[1].trim() : 'N/A']
                 ];

                 // Add table using autoTable plugin
                 doc.autoTable({
                     startY: y,
                     head: [['Descripción', 'Valor Base', 'IBC']],
                     body: tableData,
                     theme: 'striped', // Use a striped theme
                     headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' },
                     bodyStyles: { textColor: textColor },
                     margin: { left: margin, right: margin },
                     didDrawPage: function(data) {
                         // Footer (optional)
                         let pageHeight = doc.internal.pageSize.getHeight();
                         doc.setFontSize(10);
                         doc.setTextColor(150);
                         doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth / 2, pageHeight - 10, { align: 'center' });
                     }
                 });

                 y = doc.autoTable.previous.finalY + 15; // Update y position after the table

                 // Total Section
                 doc.setFontSize(16);
                 doc.setFont(undefined, 'bold');
                 doc.setTextColor(accentColor); // Green color for total
                 const totalMatch = invoiceData.detalles.match(/TOTAL A PAGAR: (.+)/);
                 const totalText = totalMatch ? `TOTAL A PAGAR: ${totalMatch[1].trim()}` : 'TOTAL A PAGAR: N/A';

                 const totalTextWidth = doc.getTextWidth(totalText);
                 const totalX = pageWidth - margin - totalTextWidth;

                 doc.text(totalText, totalX, y);
                 y += 10;
                 doc.setDrawColor(accentColor);
                 doc.setLineWidth(0.5);
                 doc.line(totalX, y, pageWidth - margin, y); // Line under total

                 // Footer (Company Info - Example)
                 y = doc.internal.pageSize.getHeight() - 20; // Position near bottom
                 doc.setFontSize(10);
                 doc.setTextColor(textColor);
                 doc.setFont(undefined, 'normal');
                 doc.text("FACBA - Tu Aliado en Gestión de seguridad social", margin, y); // Updated text
                 doc.text("Contacto: grupoconsultorcyc@outlook.com | Cel: +57 3203706164 - 3196207405", margin, y + 5); // Updated text


                 // --- FIN: Generación de PDF Moderno ---


                 // Guardar el PDF
                 doc.save(`factura_${invoiceData.codigo || invoiceId}.pdf`);

                 showStatusMessage('PDF generado con éxito!', 'success');

             } catch (error) {
                 console.error("Error al generar PDF:", error);
                 showStatusMessage('Error al generar PDF: ' + error.message, 'error');
             }
         }

         // NUEVA Función para generar PDF de la factura GENERADA (la que se ve en el modal de facturación)
         generateGeneratedPdfButton.addEventListener('click', async () => {
             showStatusMessage('Generando PDF de la factura actual...', 'info');
             const invoiceDetailsText = generatedInvoiceDetails.textContent;
             const userId = billingUserIdInput.value; // Need userId to get user data for PDF

             if (!invoiceDetailsText || invoiceDetailsText.includes('Error al generar factura') || !userId) {
                 showStatusMessage('No hay una factura actual válida o datos de usuario para generar PDF.', 'error');
                 return;
             }

             try {
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();

                 // Obtener datos actualizados del usuario para el PDF moderno
                 const userDoc = await usersCollection.doc(userId).get();
                 if (!userDoc.exists) {
                     showStatusMessage('Error: Datos del usuario no encontrados para generar PDF.', 'error');
                     return;
                 }
                 const userData = userDoc.data();

                 // Extraer información del texto generado para el PDF moderno
                 const invoiceCodeMatch = invoiceDetailsText.match(/Código de Factura: (.+)/);
                 const invoiceCode = invoiceCodeMatch ? invoiceCodeMatch[1].trim() : 'SIN_CODIGO';
                 const fechaGeneracionMatch = invoiceDetailsText.match(/Fecha de Generación: (.+)/);
                 const fechaGeneracion = fechaGeneracionMatch ? fechaGeneracionMatch[1].trim() : 'N/A';
                 const periodoFacturadoMatch = invoiceDetailsText.match(/Período Facturado: (.+)/);
                 const periodoFacturado = periodoFacturadoMatch ? periodoFacturadoMatch[1].trim() : 'N/A';

                 const empresaNombre = empresasMap.get(userData.empresaId) || 'Desconocida';
                 const asesorNombre = asesoresMap.get(userData.asesorId) || 'Desconocido';
                 const arlNombreMatch = invoiceDetailsText.match(/ARL: (.+)/);
                 const arlInfo = arlNombreMatch ? arlNombreMatch[1].trim() : 'Desconocida'; // Get full ARL line
                 const epsNombre = epsMap.get(userData.epsId) || 'Desconocida';
                 const ccfNombre = ccfMap.get(userData.ccfId) || 'Desconocida';
                 const afpNombre = afpMap.get(userData.afpId) || 'Desconocida';

                 const valorBaseMatch = invoiceDetailsText.match(/Valor Base \(según usuario\): (.+)/);
                 const ibcMatch = invoiceDetailsText.match(/IBC \(según usuario\): (.+)/);
                 const totalMatch = invoiceDetailsText.match(/TOTAL A PAGAR: (.+)/);


                 // --- INICIO: Generación de PDF Moderno (Similar a la función de historial) ---
                 const primaryColor = '#4f46e5'; // Indigo 600
                 const secondaryColor = '#eef2ff'; // Indigo 100
                 const textColor = '#1f2937'; // Gray 800
                 const accentColor = '#10b981'; // Green 500

                 const margin = 15;
                 let y = margin;
                 const pageWidth = doc.internal.pageSize.getWidth();

                 // Header
                 doc.setFillColor(primaryColor);
                 doc.rect(0, 0, pageWidth, 20, 'F'); // Colored header band
                 doc.setFontSize(18);
                 doc.setTextColor(255); // White text
                 doc.text("Factura FACBA", margin, 13);

                 y = 30; // Start content below header

                 // Invoice Info
                 doc.setFontSize(12);
                 doc.setTextColor(textColor);
                 doc.setFont(undefined, 'bold');
                 doc.text(`Código de Factura:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${invoiceCode}`, margin + 45, y);
                 y += 7;

                 doc.setFont(undefined, 'bold');
                 doc.text(`Fecha de Generación:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${fechaGeneracion}`, margin + 45, y);
                 y += 7;

                 doc.setFont(undefined, 'bold');
                 doc.text(`Período Facturado:`, margin, y);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${periodoFacturado}`, margin + 45, y);
                 y += 15;

                 // User Data Section
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Datos del Usuario", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor); // Line under section title
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 doc.setFontSize(12);
                 doc.setFont(undefined, 'normal');
                 doc.text(`Nombre: ${userData.nombre || 'Sin Nombre'}`, margin, y);
                 y += 7;
                 doc.text(`Identificación: ${userData.identificacion || 'N/A'} (${userData.tipoIdentificacion || 'N/A'})`, margin, y);
                 y += 7;
                 doc.text(`Estado: ${userData.estado || 'N/A'}`, margin, y);
                 y += 15;

                 // Associated Entities Section
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Datos de Entidades Asociadas", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor);
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 doc.setFontSize(12);
                 doc.setFont(undefined, 'normal');
                 doc.text(`Empresa: ${empresaNombre}`, margin, y);
                 y += 7;
                 doc.text(`Asesor: ${asesorNombre}`, margin, y);
                 y += 7;
                 doc.text(`ARL: ${arlInfo}`, margin, y); // Use extracted ARL info
                 y += 7;
                 doc.text(`EPS: ${epsNombre}`, margin, y);
                 y += 7;
                 doc.text(`CCF: ${ccfNombre}`, margin, y);
                 y += 7;
                 doc.text(`AFP: ${afpNombre}`, margin, y);
                 y += 15;

                 // Service Details Section (Using autoTable for a cleaner look)
                 doc.setFontSize(14);
                 doc.setFont(undefined, 'bold');
                 doc.text("Detalle del Servicio", margin, y);
                 y += 8;
                 doc.setDrawColor(primaryColor);
                 doc.line(margin, y, pageWidth - margin, y);
                 y += 5;

                 const tableData = [
                     ['Servicio de Afiliación y Gestión', valorBaseMatch ? valorBaseMatch[1].trim() : 'N/A', ibcMatch ? ibcMatch[1].trim() : 'N/A']
                 ];

                 doc.autoTable({
                     startY: y,
                     head: [['Descripción', 'Valor Base', 'IBC']],
                     body: tableData,
                     theme: 'striped',
                     headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' },
                     bodyStyles: { textColor: textColor },
                     margin: { left: margin, right: margin },
                     didDrawPage: function(data) {
                         // Footer (optional)
                         let pageHeight = doc.internal.pageSize.getHeight();
                         doc.setFontSize(10);
                         doc.setTextColor(150);
                         doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth / 2, pageHeight - 10, { align: 'center' });
                     }
                 });

                 y = doc.autoTable.previous.finalY + 15;

                 // Total Section
                 doc.setFontSize(16);
                 doc.setFont(undefined, 'bold');
                 doc.setTextColor(accentColor); // Green color for total
                 const totalText = totalMatch ? `TOTAL A PAGAR: ${totalMatch[1].trim()}` : 'TOTAL A PAGAR: N/A';

                 const totalTextWidth = doc.getTextWidth(totalText);
                 const totalX = pageWidth - margin - totalTextWidth;

                 doc.text(totalText, totalX, y);
                 y += 10;
                 doc.setDrawColor(accentColor);
                 doc.setLineWidth(0.5);
                 doc.line(totalX, y, pageWidth - margin, y); // Line under total

                 // Footer (Company Info - Example)
                 y = doc.internal.pageSize.getHeight() - 20; // Position near bottom
                 doc.setFontSize(10);
                 doc.setTextColor(textColor);
                 doc.setFont(undefined, 'normal');
                 doc.text("FACBA - Tu Aliado en Gestión de seguridad social", margin, y); // Updated text
                 doc.text("Contacto: grupoconsultorcyc@outlook.com | Cel: +57 3203706164 - 3196207405", margin, y + 5); // Updated text

                 // --- FIN: Generación de PDF Moderno ---


                 const filenameCode = invoiceCode || 'generada';
                 doc.save(`factura_${filenameCode}.pdf`);

                 showStatusMessage('PDF generado con éxito!', 'success');

             } catch (error) {
                 console.error("Error al generar PDF de la factura actual:", error);
                 showStatusMessage('Error al generar PDF de la factura actual: ' + error.message, 'error');
             }
         });


         // --- Funcionalidad de Editar Factura ---

         // Mostrar modal de editar factura
         function showEditInvoiceModal() {
             editInvoiceModal.classList.add('show');
         }

         // Ocultar modal de editar factura
         function hideEditInvoiceModal() {
             editInvoiceModal.classList.remove('show');
             editInvoiceForm.reset(); // Resetear formulario
         }

         // Listeners para cerrar modal de editar factura
         closeEditInvoiceModalButton.addEventListener('click', hideEditInvoiceModal);
         cancelEditInvoiceButton.addEventListener('click', hideEditInvoiceModal);
         editInvoiceModal.addEventListener('click', (e) => {
             if (e.target === editInvoiceModal) {
                 hideEditInvoiceModal();
             }
         });

         // Cargar datos de una factura en el modal de edición
         async function loadInvoiceDataForEdit(invoiceId, userId) {
              try {
                   const invoiceDoc = await facturasCollection.doc(invoiceId).get();
                   if (invoiceDoc.exists) {
                        const invoiceData = invoiceDoc.data();
                        console.log("Datos de la factura cargados para edición:", invoiceData);

                        editInvoiceIdInput.value = invoiceId;
                        editInvoiceUserIdInput.value = userId; // Store userId
                        editInvoiceCodeInput.value = invoiceData.codigo || '';
                        editInvoiceStartDateInput.value = formatDate(invoiceData.fechaInicio);
                        editInvoiceEndDateInput.value = formatDate(invoiceData.fechaFin);
                        editInvoiceDetailsTextarea.value = invoiceData.detalles || '';

                   } else {
                        console.error("Factura no encontrada para edición:", invoiceId);
                        showStatusMessage('Error: Factura no encontrada para editar.', 'error');
                        hideEditInvoiceModal();
                   }
              } catch (error) {
                   console.error("Error al cargar datos de la factura para edición:", error);
                   showStatusMessage('Error al cargar datos de la factura para edición.', 'error');
                   hideEditInvoiceModal();
              }
         }

         // Listener para guardar cambios del formulario de edición de factura
         editInvoiceForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const invoiceId = editInvoiceIdInput.value;
              const userId = editInvoiceUserIdInput.value; // Get userId
              const invoiceCode = editInvoiceCodeInput.value.trim();
              const startDateString = editInvoiceStartDateInput.value;
              const endDateString = editInvoiceEndDateInput.value;
              const invoiceDetails = editInvoiceDetailsTextarea.value;

              if (!invoiceId || !userId || !invoiceCode || !startDateString || !endDateString || !invoiceDetails) {
                  showStatusMessage('Por favor, completa todos los campos de la factura correctamente.', 'error');
                  return;
              }

              // CORRECCIÓN: Manejo de fechas para guardar en Firestore desde edición
              const startDateParts = startDateString.split('-');
              const startDate = new Date(parseInt(startDateParts[0]), parseInt(startDateParts[1]) - 1, parseInt(startDateParts[2])); // Year, Month (0-indexed), Day

              const endDateParts = endDateString.split('-');
              const endDate = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]) - 1, parseInt(endDateParts[2])); // Year, Month (0-indexed), Day
              endDate.setHours(23, 59, 59, 999); // Ajustar hora de fin


              if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) {
                 showStatusMessage('Las fechas seleccionadas no son válidas.', 'error');
                 return;
             }


              const updatedData = {
                  codigo: invoiceCode,
                  fechaInicio: firebase.firestore.Timestamp.fromDate(startDate), // Guardar como Timestamp
                  fechaFin: firebase.firestore.Timestamp.fromDate(endDate), // Guardar como Timestamp
                  detalles: invoiceDetails,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };

              showStatusMessage('Guardando cambios de la factura...', 'info');

              try {
                  await facturasCollection.doc(invoiceId).update(updatedData);
                  showStatusMessage('Cambios de la factura guardados con éxito!', 'success');
                  hideEditInvoiceModal();

                  // Recargar el historial de facturas en el modal visible
                  if (billingModal.classList.contains('show')) {
                       await loadInvoiceHistory(userId, invoiceHistoryList, 3);
                  } else if (invoiceHistoryModal.classList.contains('show')) {
                       await loadInvoiceHistory(userId, fullInvoiceHistoryList);
                  }

              } catch (error) {
                  console.error("Error al guardar cambios de la factura:", error);
                  showStatusMessage('Error al guardar cambios de la factura: ' + error.message, 'error');
              }
         });


         // Función para eliminar una factura
         async function deleteInvoice(invoiceId, userId) {
              showStatusMessage('Eliminando factura...', 'info');
              try {
                  await facturasCollection.doc(invoiceId).delete();
                  showStatusMessage('Factura eliminada con éxito!', 'success');

                  // Recargar el historial de facturas en el modal visible
                  if (billingModal.classList.contains('show')) {
                       await loadInvoiceHistory(userId, invoiceHistoryList, 3);
                  } else if (invoiceHistoryModal.classList.contains('show')) {
                       await loadInvoiceHistory(userId, fullInvoiceHistoryList);
                  }

              } catch (error) {
                  console.error("Error al eliminar factura:", error);
                  showStatusMessage('Error al eliminar factura: ' + error.message, 'error');
              }
         }


        // --- NUEVA FUNCIONALIDAD: Abrir ventana de Chat ---
        chatButton.addEventListener('click', () => {
            const chatUrl = 'https://soavanzar.github.io/FACBA/chat.html';
            const windowName = 'FACBAChatWindow'; // Nombre único para la ventana del chat

            // Abre la ventana. Si ya existe una ventana con ese nombre, la reutiliza.
            window.open(chatUrl, windowName);
        });
        // --- FIN NUEVA FUNCIONALIDAD ---


        // --- Inicialización ---
        // Cargar la tabla de usuarios al cargar la página
        loadUsersTable();


    </script>

</body>
</html>
