<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Base de Datos - FACBA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <style>
        /* Estilos CSS personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f2f2f7; /* Fondo gris muy claro */
            color: #1c1c1e; /* Color de texto oscuro por defecto */
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative; /* Necesario para posicionar el botón de configuración */
        }

        .container {
            background-color: #ffffff; /* Fondo blanco para el contenedor */
            padding: 30px;
            border-radius: 12px; /* Bordes redondeados */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* Sombra suave */
            max-width: 1200px; /* Ancho máximo para la tabla */
            margin: 20px auto; /* Centra el contenedor y añade margen */
            position: relative; /* Necesario para el contexto del botón de atrás */
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #d1d5db; /* Gris claro */
            color: #1f2937; /* Gris oscuro */
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background-color: #9ca3af; /* Gris más oscuro */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Estilo para el botón de configuración */
        .settings-button {
            position: absolute; /* Posicionamiento absoluto */
            top: 20px; /* Ajusta según sea necesario */
            right: 30px; /* Ajusta según sea necesario */
            font-size: 2.5rem; /* Tamaño del icono (ajustado para ser más grande) */
            color: #4b5563; /* Color gris oscuro */
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 10; /* Asegura que esté por encima del contenido */
        }

        .settings-button:hover {
            color: #1f2937; /* Gris más oscuro al pasar el ratón */
            transform: rotate(15deg); /* Pequeña rotación al pasar el ratón */
        }


        .filter-buttons {
            margin-bottom: 15px; /* Espacio entre los botones de filtro y la barra de búsqueda */
            display: flex; /* Usa flexbox para alinear los botones */
            gap: 10px; /* Espacio entre botones */
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas pequeñas */
        }

        .filter-button {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #d1d5db; /* Borde sutil */
            background-color: #f9fafb; /* Fondo muy claro */
            color: #374151; /* Texto gris oscuro */
        }

        .filter-button:hover {
             background-color: #e5e7eb; /* Fondo gris al pasar el ratón */
        }

        .filter-button.active {
            background-color: #4f46e5; /* Color azul/morado para el botón activo */
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2); /* Sombra para el botón activo */
        }


        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Estilos de tabla tipo Excel */
        .user-table {
            width: 100%;
            border-collapse: collapse; /* Elimina el espacio entre bordes */
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Sombra suave para la tabla */
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px; /* Espaciado interno */
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Borde inferior para filas */
        }

        .user-table th {
            background-color: #eef2ff; /* Fondo azul/morado muy claro para encabezados */
            color: #1f2937; /* Texto oscuro */
            font-weight: 600;
            text-transform: uppercase; /* Texto en mayúsculas */
            font-size: 0.9rem;
        }

        .user-table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* Fondo ligeramente diferente para filas pares (efecto cebra) */
        }

        .user-table tbody tr:hover {
            background-color: #e5e7eb; /* Fondo gris claro al pasar el ratón */
            transition: background-color 0.2s ease-in-out;
        }

        .user-table td {
            font-size: 0.95rem;
            color: #374151; /* Texto gris oscuro */
        }

        /* Estilos para las celdas de acciones */
        .action-buttons {
            display: flex;
            gap: 8px; /* Espacio entre botones */
            justify-content: center; /* Centra los botones en la celda */
        }

        .action-button {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
            border: none; /* Sin borde por defecto */
        }

        .action-button i {
             margin-right: 4px; /* Espacio entre icono y texto */
        }

        .edit-button {
            background-color: #60a5fa; /* Azul */
            color: white;
        }
        .edit-button:hover {
            background-color: #3b82f6; /* Azul más oscuro */
        }

        .delete-button {
            background-color: #f87171; /* Rojo */
            color: white;
        }
        .delete-button:hover {
            background-color: #ef4444; /* Rojo más oscuro */
        }

        .status-button {
            background-color: #a78bfa; /* Morado */
            color: white;
        }
        .status-button:hover {
            background-color: #8b5cf6; /* Morado más oscuro */
        }

        /* Estilos para los modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente más oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px; /* Ancho máximo del modal */
            position: relative;
            max-height: 90vh; /* Altura máxima para scroll */
            overflow-y: auto; /* Habilita scroll si el contenido es largo */
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #9ca3af; /* Gris */
            transition: color 0.2s ease-in-out;
        }

        .modal-close-button:hover {
            color: #6b7280; /* Gris más oscuro */
        }

        .modal-content h2 {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
            color: #1f2937;
        }

        .modal-form-group {
            margin-bottom: 18px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .modal-form-group input[type="text"],
        .modal-form-group input[type="number"],
        .modal-form-group input[type="date"],
        .modal-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box;
        }

         .modal-form-group input:focus,
         .modal-form-group select:focus {
             outline: none;
             border-color: #4f46e5;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
         }


        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
        }

        .save-changes-button {
            background-color: #10b981; /* Verde */
            color: white;
        }
        .save-changes-button:hover {
            background-color: #059669; /* Verde más oscuro */
        }

        .cancel-button {
            background-color: #9ca3af; /* Gris */
            color: white;
        }
        .cancel-button:hover {
            background-color: #6b7280; /* Gris más oscuro */
        }

        /* Estilos para mensajes de estado */
        #status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-in-out;
        }

        #status-message.success {
            background-color: #d4edda; /* Verde claro */
            color: #155724; /* Verde oscuro */
            border: 1px solid #c3e6cb;
            opacity: 1;
            transform: translateY(0);
        }

        #status-message.error {
            background-color: #f8d7da; /* Rojo claro */
            color: #721c24; /* Rojo oscuro */
            border: 1px solid #f5c6cb;
            opacity: 1;
            transform: translateY(0);
        }

        #status-message.info {
            background-color: #cce5ff; /* Azul claro */
            color: #004085; /* Azul oscuro */
            border: 1px solid #b8daff;
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Estilos Responsivos para la Tabla --- */

        /* Aplicar estilos solo en pantallas pequeñas (menos de 768px, breakpoint 'md' de Tailwind) */
        @media (max-width: 767px) {
            .user-table thead {
                display: none; /* Ocultar encabezados de tabla */
            }

            .user-table, .user-table tbody, .user-table tr, .user-table td {
                display: block; /* Hacer que los elementos de la tabla se comporten como bloques */
                width: 100%; /* Ocupar todo el ancho */
            }

            .user-table tr {
                margin-bottom: 15px; /* Espacio entre filas apiladas */
                border: 1px solid #e5e7eb; /* Borde alrededor de cada "tarjeta" de fila */
                border-radius: 8px; /* Bordes redondeados */
                background-color: #ffffff; /* Fondo blanco para cada fila */
                box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Sombra suave */
            }

            .user-table td {
                text-align: right; /* Alinear contenido de celda a la derecha */
                padding-left: 50%; /* Dejar espacio a la izquierda para la etiqueta */
                position: relative; /* Para posicionar la etiqueta */
                 border-bottom: 1px dashed #e5e7eb; /* Borde inferior punteado */
            }

             .user-table td:last-child {
                 border-bottom: none; /* No borde inferior en la última celda */
             }


            .user-table td::before {
                content: attr(data-label); /* Mostrar el contenido del atributo data-label */
                position: absolute;
                left: 15px; /* Posición a la izquierda */
                width: calc(50% - 30px); /* Ancho de la etiqueta */
                padding-right: 10px; /* Espacio entre etiqueta y contenido */
                white-space: nowrap; /* Evitar que la etiqueta se rompa en varias líneas */
                font-weight: 600; /* Peso de fuente semibold para la etiqueta */
                color: #4b5563; /* Color gris oscuro para la etiqueta */
                text-align: left; /* Alinear etiqueta a la izquierda */
                overflow: hidden; /* Ocultar texto si es demasiado largo */
                text-overflow: ellipsis; /* Mostrar puntos suspensivos si se trunca */
            }

            /* Ajuste específico para la celda de acciones */
            .user-table td:last-child {
                 text-align: center; /* Centrar los botones de acción */
                 padding-left: 15px; /* Ajustar padding para que no haya espacio extra a la izquierda */
            }

             .user-table td:last-child::before {
                 content: ''; /* No mostrar etiqueta para la celda de acciones */
             }
        }

         /* Asegurar que los modales se vean bien en pantallas pequeñas */
         @media (max-width: 600px) {
             .modal-content {
                 padding: 20px; /* Reducir padding en pantallas muy pequeñas */
             }

             .modal-content h2 {
                 font-size: 1.5rem; /* Reducir tamaño del título del modal */
             }

             .modal-buttons {
                 flex-direction: column; /* Apilar botones en pantallas muy pequeñas */
                 gap: 8px; /* Reducir espacio entre botones apilados */
             }

             .modal-buttons button {
                 width: 100%; /* Hacer que los botones apilados ocupen todo el ancho */
             }
         }

         /* Estilos para el modal de configuración/menú */
         #settings-modal .modal-content {
             max-width: 350px; /* Ancho más pequeño para el modal de menú */
         }

         #settings-modal .menu-option-button {
             display: block; /* Cada opción como un bloque */
             width: 100%; /* Ocupa todo el ancho */
             padding: 12px 15px; /* Espaciado interno */
             margin-bottom: 10px; /* Espacio entre opciones */
             background-color: #eef2ff; /* Fondo azul/morado muy claro */
             color: #1f2937; /* Texto oscuro */
             font-weight: 500; /* Peso de fuente medio */
             border: none;
             border-radius: 6px;
             text-align: left; /* Alinear texto a la izquierda */
             cursor: pointer;
             transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
         }

         #settings-modal .menu-option-button:hover {
             background-color: #dadaff; /* Fondo un poco más oscuro al pasar el ratón */
             transform: translateX(5px); /* Mover ligeramente a la derecha */
         }

         #settings-modal .menu-option-button:last-child {
             margin-bottom: 0; /* Sin margen inferior en el último botón */
         }

         #settings-modal .modal-buttons {
             margin-top: 20px; /* Espacio encima de los botones de acción del modal */
         }

         /* Estilos para el modal genérico de agregar entidad */
         #add-entity-modal .modal-content {
             max-width: 400px; /* Ancho adecuado para el formulario simple */
         }

         /* Estilos para el nuevo modal de gestión de entidades */
         #manage-entity-modal .modal-content {
             max-width: 500px; /* Ancho adecuado para la lista */
         }

         #manage-entity-modal .entity-list {
             list-style: none;
             padding: 0;
             margin: 0;
         }

         #manage-entity-modal .entity-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 10px 0;
             border-bottom: 1px solid #e5e7eb;
         }

         #manage-entity-modal .entity-item:last-child {
             border-bottom: none;
         }

         #manage-entity-modal .entity-name {
             flex-grow: 1; /* Permite que el nombre ocupe el espacio disponible */
             margin-right: 10px; /* Espacio entre el nombre y el botón */
             font-size: 1rem;
             color: #374151;
         }

         #manage-entity-modal .delete-entity-button {
             background-color: #f87171; /* Rojo */
             color: white;
             padding: 5px 10px;
             border-radius: 4px;
             font-size: 0.8rem;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             border: none;
         }

         #manage-entity-modal .delete-entity-button:hover {
             background-color: #ef4444; /* Rojo más oscuro */
         }

         #manage-entity-modal .add-new-button-container {
             margin-top: 20px;
             text-align: center;
         }

         #manage-entity-modal .add-new-button {
             background-color: #10b981; /* Verde */
             color: white;
             padding: 10px 15px;
             border-radius: 8px;
             font-weight: 600;
             cursor: pointer;
             transition: background-color 0.2s ease-in-out;
             border: none;
         }

         #manage-entity-modal .add-new-button:hover {
             background-color: #059669; /* Verde más oscuro */
         }

         /* Estilos para el modal de Importar Usuarios */
         #import-users-modal .modal-content {
             max-width: 450px; /* Ancho adecuado */
         }

         #import-users-modal input[type="file"] {
             display: block; /* Asegura que ocupe su propia línea */
             width: 100%;
             padding: 10px;
             border: 1px solid #d1d5db;
             border-radius: 6px;
             font-size: 1rem;
             box-sizing: border-box;
             margin-bottom: 15px; /* Espacio debajo del input */
         }

         #import-users-modal .import-instructions {
             font-size: 0.9rem;
             color: #4b5563;
             margin-bottom: 20px;
             padding: 10px;
             background-color: #f9fafb;
             border-left: 4px solid #4f46e5;
             border-radius: 4px;
         }

         #import-users-modal .import-instructions strong {
             color: #1f2937;
         }


    </style>
</head>
<body>

    <div class="container">
        <a href="https://soavanzar.github.io/FACBA/inicio_base_de_datos.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Ir Atrás
        </a>

        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Gestionar Usuarios</h1>

        <i class="fas fa-cog settings-button" id="settings-button" title="Configuración"></i>


        <div class="filter-buttons">
            <button class="filter-button active" data-filter="todos">Todos</button>
            <button class="filter-button" data-filter="activo">Activos</button>
            <button class="filter-button" data-filter="retirado">Retirados</button>
            <button class="filter-button" data-filter="empresa">Filtrar por Empresa</button>
            <button class="filter-button" data-filter="asesor">Filtrar por Asesor</button>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Buscar por nombre, identificación, empresa...">
        </div>

        <div class="table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Identificación</th>
                        <th>Empresa</th>
                        <th>Estado</th>
                        <th>Fecha Ingreso</th>
                        <th>Fecha Registro</th>
                        <th>Asesor</th>
                        <th>Valor a Pagar</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    </tbody>
            </table>
        </div>

        <div id="status-message"></div>
    </div>

    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-edit-modal">&times;</span>
            <h2>Editar Usuario</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id"> <div class="modal-form-group">
                    <label for="edit-nombre">Nombre:</label>
                    <input type="text" id="edit-nombre" name="nombre" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-tipo-identificacion">Tipo de Identificación:</label>
                    <select id="edit-tipo-identificacion" name="tipoIdentificacion" required>
                        <option value="">Selecciona</option>
                        <option value="CC">Cédula de Ciudadanía</option>
                        <option value="TI">Tarjeta de Identidad</option>
                        <option value="CE">Cédula de Extranjería</option>
                        <option value="PA">Pasaporte</option>
                        </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-identificacion">Identificación:</label>
                    <input type="number" id="edit-identificacion" name="identificacion" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-empresa">Empresa:</label>
                     <select id="edit-empresa" name="empresaId" required>
                         <option value="">Selecciona una empresa</option>
                         </select>
                </div>

                <div class="modal-form-group">
                    <label for="edit-arl">ARL:</label>
                    <input type="text" id="edit-arl" name="arl">
                </div>

                <div class="modal-form-group">
                    <label for="edit-riesgo">Riesgo:</label>
                    <input type="text" id="edit-riesgo" name="riesgo">
                </div>

                <div class="modal-form-group">
                    <label for="edit-eps">EPS:</label>
                    <input type="text" id="edit-eps" name="eps">
                </div>

                <div class="modal-form-group">
                    <label for="edit-ccf">CCF:</label>
                    <input type="text" id="edit-ccf" name="ccf">
                </div>

                <div class="modal-form-group">
                    <label for="edit-afp">AFP:</label>
                    <input type="text" id="edit-afp" name="afp">
                </div>

                <div class="modal-form-group">
                    <label for="edit-fecha-ingreso">Fecha de Ingreso:</label>
                    <input type="date" id="edit-fecha-ingreso" name="fecha" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-fecha-registro">Fecha de Registro Inicial:</label>
                    <input type="date" id="edit-fecha-registro" name="ingreso" required>
                </div>

                <div class="modal-form-group">
                    <label for="edit-asesor">Asesor:</label>
                     <select id="edit-asesor" name="asesorId" required>
                         <option value="">Selecciona un asesor</option>
                         </select>
                </div>

                 <div class="modal-form-group">
                    <label for="edit-valor-a-pagar">Valor a Pagar (COP):</label>
                    <input type="number" id="edit-valor-a-pagar" name="valorAPagar" step="0.01">
                </div>

                 <div class="modal-form-group">
                    <label for="edit-estado">Estado:</label>
                    <select id="edit-estado" name="estado" required>
                        <option value="activo">Activo</option>
                        <option value="retirado">Retirado</option>
                        </select>
                </div>

                 <div class="modal-form-group" id="edit-fecha-retiro-group" style="display: none;">
                    <label for="edit-fecha-retiro">Fecha de Retiro:</label>
                    <input type="date" id="edit-fecha-retiro" name="fechaRetiro">
                </div>


                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-edit">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-filter-modal">&times;</span>
            <h2 id="filter-modal-title">Filtrar</h2>
            <div class="modal-form-group" id="filter-empresa-group" style="display: none;">
                <label for="filter-empresa-select">Seleccionar Empresa:</label>
                <select id="filter-empresa-select">
                    <option value="">Todas las Empresas</option>
                    </select>
            </div>
            <div class="modal-form-group" id="filter-asesor-group" style="display: none;">
                <label for="filter-asesor-select">Seleccionar Asesor:</label>
                <select id="filter-asesor-select">
                    <option value="">Todos los Asesores</option>
                    </select>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-button" id="cancel-filter">Cancelar</button>
                <button type="button" class="save-changes-button" id="apply-filter">Aplicar Filtro</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
             <span class="modal-close-button" id="close-settings-modal">&times;</span>
             <h2>Opciones de Configuración</h2>
             <button class="menu-option-button" data-entity-type="eps">Gestionar EPS</button>
             <button class="menu-option-button" data-entity-type="ccf">Gestionar CCF</button>
             <button class="menu-option-button" data-entity-type="afp">Gestionar AFP</button>
             <button class="menu-option-button" data-entity-type="asesor">Gestionar Asesores</button>
             <button class="menu-option-button" data-entity-type="empresa">Gestionar Empresas</button>
             <button class="menu-option-button" id="export-users-button">Exportar Usuarios a Excel</button>
             <button class="menu-option-button" id="import-users-button">Importar Usuarios desde Excel</button>

             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-settings-modal-button">Cerrar</button>
             </div>
        </div>
    </div>

    <div id="add-entity-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button" id="close-add-entity-modal">&times;</span>
            <h2 id="add-entity-modal-title">Agregar Nueva Entidad</h2>
            <form id="add-entity-form">
                <input type="hidden" id="add-entity-type"> <div class="modal-form-group">
                    <label for="entity-name" class="block text-gray-700 text-sm font-semibold mb-2">Nombre:</label>
                    <input type="text" id="entity-name" name="name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-primary_blue">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-button" id="cancel-add-entity">Cancelar</button>
                    <button type="submit" class="save-changes-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-entity-modal" class="modal-overlay">
         <div class="modal-content">
             <span class="modal-close-button" id="close-manage-entity-modal">&times;</span>
             <h2 id="manage-entity-modal-title">Gestionar Entidades</h2>
             <input type="hidden" id="manage-entity-type"> <ul class="entity-list" id="entity-list">
                 </ul>

             <div class="add-new-button-container">
                 <button class="add-new-button" id="open-add-from-manage-button">Agregar Nuevo</button>
             </div>

             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="close-manage-entity-modal-button">Cerrar</button>
             </div>
         </div>
    </div>

    <div id="import-users-modal" class="modal-overlay">
         <div class="modal-content">
             <span class="modal-close-button" id="close-import-modal">&times;</span>
             <h2>Importar Usuarios desde Excel</h2>
             <div class="import-instructions">
                 Por favor, asegúrate de que tu archivo Excel (.xlsx) tenga **exactamente** las siguientes columnas en la primera fila (el orden no importa):<br>
                 <strong>NOMBRE, TIPO DE IDENTIFICACION, IDENTIFICACION, EMPRESA, ARL, RIESGO, EPS, CCF, AFP, FECHA INGRESO, ASESOR, VALOR A PAGAR</strong> <br>
                 Asegúrate de que las celdas para **ARL, RIESGO, EPS, CCF, AFP** no estén vacías si quieres importar esos datos.
             </div>
             <input type="file" id="excel-file-input" accept=".xlsx, .xls">
             <div class="modal-buttons">
                 <button type="button" class="cancel-button" id="cancel-import">Cancelar</button>
                 <button type="button" class="save-changes-button" id="process-import-button">Procesar Importación</button>
             </div>
             <div id="import-status-message" class="mt-4 text-center text-sm text-gray-600"></div>
         </div>
    </div>


    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCimRCv6S5u0FhsfWrW_3A0dQJy0uAKVro",
            authDomain: "facba-69d41.firebaseapp.com",
            projectId: "facba-69d41",
            storageBucket: "facba-69d41.firebasestorage.app",
            messagingSenderId: "264089433073",
            appId: "1:264089433073:web:968551648758972eb74a50",
            measurementId: "G-NL7Y6NDH99"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore(); // Inicializar Firestore

        // Referencias a las colecciones en Firestore
        const usersCollection = db.collection('usuarios');
        const empresasCollection = db.collection('empresas');
        const asesoresCollection = db.collection('asesores');
        // Referencias a nuevas colecciones para EPS, CCF, AFP
        const epsCollection = db.collection('eps');
        const ccfCollection = db.collection('ccf');
        const afpCollection = db.collection('afp');


        // Obtener elementos del DOM
        const userTableBody = document.getElementById('user-table-body');
        const searchInput = document.getElementById('search-input');
        const statusMessage = document.getElementById('status-message');
        const filterButtonsContainer = document.querySelector('.filter-buttons'); // Contenedor de botones de filtro
        const filterButtons = document.querySelectorAll('.filter-button'); // Botones de filtro
        const settingsButton = document.getElementById('settings-button'); // Botón de configuración


        // Modal de Edición DOM elements
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditModalButton = document.getElementById('close-edit-modal');
        const cancelEditButton = document.getElementById('cancel-edit');
        const editUserForm = document.getElementById('edit-user-form');

        // Campos del formulario de edición
        const editUserIdInput = document.getElementById('edit-user-id');
        const editNombreInput = document.getElementById('edit-nombre');
        const editTipoIdentificacionSelect = document.getElementById('edit-tipo-identificacion');
        const editIdentificacionInput = document.getElementById('edit-identificacion');
        const editEmpresaSelect = document.getElementById('edit-empresa');
        const editArlInput = document.getElementById('edit-arl');
        const editRiesgoInput = document.getElementById('edit-riesgo');
        const editEpsInput = document.getElementById('edit-eps');
        const editCcfInput = document.getElementById('edit-ccf');
        const editAfpInput = document.getElementById('edit-afp');
        const editFechaIngresoInput = document.getElementById('edit-fecha-ingreso');
        const editFechaRegistroInput = document.getElementById('edit-fecha-registro');
        const editAsesorSelect = document.getElementById('edit-asesor');
        const editValorAPagarInput = document.getElementById('edit-valor-a-pagar');
        const editEstadoSelect = document.getElementById('edit-estado');
        const editFechaRetiroGroup = document.getElementById('edit-fecha-retiro-group');
        const editFechaRetiroInput = document.getElementById('edit-fecha-retiro');

        // Modal de Filtro DOM elements
        const filterModal = document.getElementById('filter-modal');
        const closeFilterModalButton = document.getElementById('close-filter-modal');
        const cancelFilterButton = document.getElementById('cancel-filter');
        const applyFilterButton = document.getElementById('apply-filter');
        const filterModalTitle = document.getElementById('filter-modal-title');
        const filterEmpresaGroup = document.getElementById('filter-empresa-group');
        const filterEmpresaSelect = document.getElementById('filter-empresa-select');
        const filterAsesorGroup = document.getElementById('filter-asesor-group');
        const filterAsesorSelect = document.getElementById('filter-asesor-select');

        // Modal de Configuración/Menú DOM elements
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const closeSettingsModalButtonInModal = document.getElementById('close-settings-modal-button'); // Botón "Cerrar" dentro del modal

        // Botones de opción dentro del modal de configuración
        const menuOptionButtons = document.querySelectorAll('#settings-modal .menu-option-button');
        const exportUsersButton = document.getElementById('export-users-button'); // Botón Exportar
        const importUsersButton = document.getElementById('import-users-button'); // Botón Importar


        // Modal Genérico para Agregar Entidades DOM elements
        const addEntityModal = document.getElementById('add-entity-modal');
        const closeAddEntityModalButton = document.getElementById('close-add-entity-modal');
        const cancelAddEntityButton = document.getElementById('cancel-add-entity');
        const addEntityModalTitle = document.getElementById('add-entity-modal-title');
        const addEntityForm = document.getElementById('add-entity-form');
        const addEntityTypeInput = document.getElementById('add-entity-type');
        const entityNameInput = document.getElementById('entity-name');

        // Nuevo Modal Genérico para Gestionar Entidades DOM elements
        const manageEntityModal = document.getElementById('manage-entity-modal');
        const closeManageEntityModalButton = document.getElementById('close-manage-entity-modal');
        const closeManageEntityModalButtonInModal = document.getElementById('close-manage-entity-modal-button');
        const manageEntityModalTitle = document.getElementById('manage-entity-modal-title');
        const manageEntityTypeInput = document.getElementById('manage-entity-type');
        const entityList = document.getElementById('entity-list');
        const openAddFromManageButton = document.getElementById('open-add-from-manage-button');

        // Nuevo Modal para Importar Usuarios DOM elements
        const importUsersModal = document.getElementById('import-users-modal');
        const closeImportModalButton = document.getElementById('close-import-modal');
        const cancelImportButton = document.getElementById('cancel-import');
        const excelFileInput = document.getElementById('excel-file-input');
        const processImportButton = document.getElementById('process-import-button');
        const importStatusMessage = document.getElementById('import-status-message');


        // Mapas para almacenar nombres de empresas y asesores (para mostrar en la tabla)
        let empresasMap = new Map();
        let asesoresMap = new Map();

        // Variable para almacenar todos los documentos de usuario fetched por onSnapshot
        let allUserDocs = [];

        // Variables para almacenar los filtros actuales
        let currentStatusFilter = 'todos'; // 'todos', 'activo', 'retirado'
        let currentEmpresaFilterId = ''; // ID de empresa seleccionado para filtrar
        let currentAsesorFilterId = ''; // ID de asesor seleccionado para filtrar


        // --- Funciones de Utilidad ---

        // Función para mostrar mensajes de estado (en la parte inferior de la tabla)
        function showStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = ''; // Reset classes
            statusMessage.classList.add(type);
            // Fade in
            statusMessage.style.opacity = '1';
            statusMessage.style.transform = 'translateY(0)';

            // Fade out after 5 seconds
            setTimeout(() => {
                statusMessage.style.opacity = '0';
                statusMessage.style.transform = 'translateY(10px)';
                 // Clear text after transition
                setTimeout(() => {
                     statusMessage.textContent = '';
                }, 400); // Match the transition duration
            }, 5000);
        }

         // Función para mostrar mensajes de estado en el modal de importación
         function showImportStatusMessage(message, type = 'info') {
             importStatusMessage.textContent = message;
             importStatusMessage.className = 'mt-4 text-center text-sm'; // Reset classes and apply base styles
             if (type === 'success') {
                 importStatusMessage.classList.add('text-green-600');
             } else if (type === 'error') {
                 importStatusMessage.classList.add('text-red-600');
             } else {
                 importStatusMessage.classList.add('text-gray-600');
             }
         }


        // Función para formatear fechas (Firestore Timestamp aYYYY-MM-DD)
        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) { // Check if it's a Firestore Timestamp
                 date = timestamp.toDate();
            } else if (typeof timestamp === 'string') { // Handle string dates
                 date = new Date(timestamp);
            } else { // Handle other potential date formats
                 date = new Date(timestamp);
            }

            if (isNaN(date.getTime())) {
                return ''; // Return empty string if date is invalid
            }

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // Función para formatear números como moneda (COP)
        function formatCurrency(number) {
             let numericValue = number;
             if (typeof number === 'string') {
                 const cleanedString = number.replace(/COP/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                 numericValue = parseFloat(cleanedString);
             }

             if (numericValue === undefined || numericValue === null || isNaN(numericValue)) {
                 return '';
             }

             return new Intl.NumberFormat('es-CO', {
                 style: 'currency',
                 currency: 'COP',
                 minimumFractionDigits: 0,
                 maximumFractionDigits: 2,
             }).format(numericValue);
        }


        // --- Carga de Datos Inicial y Filtrado ---

        // Cargar mapas de empresas y asesores (y potencialmente otros para EPS, CCF, AFP si se usan IDs)
        async function loadLookupMaps() {
            try {
                const empresasSnapshot = await empresasCollection.get();
                empresasMap = new Map();
                empresasSnapshot.forEach(doc => {
                    empresasMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });

                const asesoresSnapshot = await asesoresCollection.get();
                asesoresMap = new Map();
                asesoresSnapshot.forEach(doc => {
                    asesoresMap.set(doc.id, doc.data().nombre || 'Nombre Desconocido');
                });
                 console.log("Mapas de Empresas y Asesores cargados."); // Debugging
                 // TODO: Si EPS, CCF, AFP se convierten en colecciones con IDs, cargar sus mapas aquí también
            } catch (error) {
                console.error("Error al cargar mapas:", error);
                showStatusMessage('Error al cargar datos de referencia (empresas, asesores).', 'error');
            }
        }

        // Poblar selectores de empresa y asesor en los modales (edición y filtro)
        async function populateSelects(empresaSelectElement, asesorSelectElement) {
             try {
                 // Empresas
                 const empresasSnapshot = await empresasCollection.get();
                 empresaSelectElement.innerHTML = '<option value="">Selecciona una empresa</option>'; // Limpiar y añadir opción por defecto
                 empresasSnapshot.forEach(doc => {
                     const option = document.createElement('option');
                     option.value = doc.id;
                     option.textContent = doc.data().nombre || 'Nombre Desconocido';
                     empresaSelectElement.appendChild(option);
                 });

                 // Asesores
                 const asesoresSnapshot = await asesoresCollection.get();
                 asesorSelectElement.innerHTML = '<option value="">Selecciona un asesor</option>'; // Limpiar y añadir opción por defecto
                 asesoresSnapshot.forEach(doc => {
                     const option = document.createElement('option');
                     option.value = doc.id;
                     option.textContent = doc.data().nombre || 'Nombre Desconocido';
                     asesorSelectElement.appendChild(option);
                 });
                  console.log("Selectores poblados."); // Debugging
             } catch (error) {
                 console.error("Error al poblar selectores:", error);
                 showStatusMessage('Error al cargar opciones de empresa/asesor.', 'error');
             }
        }


        // Renderizar una fila de usuario en la tabla
        function renderUserRow(userDoc) {
            const user = userDoc.data();
            const row = document.createElement('tr');
            row.dataset.id = userDoc.id; // Guardar el ID del documento en la fila

            // Determinar el estado y la fecha de retiro para mostrar
            const estado = user.estado || 'activo'; // Estado por defecto si no está definido
            const fechaRetiro = user.fechaRetiro ? formatDate(user.fechaRetiro) : '';

            // Añadir data-label para la responsividad de la tabla
            row.innerHTML = `
                <td data-label="Nombre">${user.nombre || 'Sin Nombre'}</td>
                <td data-label="Identificación">${user.identificacion || 'Sin Identificación'}</td>
                <td data-label="Empresa">${empresasMap.get(user.empresaId) || 'Desconocida'}</td>
                <td data-label="Estado">${estado}</td>
                <td data-label="Fecha Ingreso">${formatDate(user.fecha)}</td>
                <td data-label="Fecha Registro">${formatDate(user.ingreso)}</td>
                <td data-label="Asesor">${asesoresMap.get(user.asesorId) || 'Desconocido'}</td>
                <td data-label="Valor a Pagar">${formatCurrency(user.valorAPagar)}</td>
                <td class="action-buttons" data-label="Acciones">
                    <button class="action-button edit-button" data-id="${userDoc.id}" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="action-button delete-button" data-id="${userDoc.id}" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    <button class="action-button status-button" data-id="${userDoc.id}" data-current-status="${estado}" title="${estado === 'activo' ? 'Marcar como Retirado' : 'Marcar como Activo'}">
                         <i class="fas ${estado === 'activo' ? 'fa-user-slash' : 'fa-user'}"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Función para renderizar la tabla con los usuarios filtrados
        function renderFilteredUsers() {
            userTableBody.innerHTML = ''; // Limpiar tabla actual
            const filterText = searchInput.value.toLowerCase();

            let filteredDocs = allUserDocs.filter(userDoc => {
                const user = userDoc.data();
                const empresaNombre = empresasMap.get(user.empresaId) || 'Desconocida';
                const asesorNombre = asesoresMap.get(user.asesorId) || 'Desconocido';
                const estado = user.estado || 'activo'; // Estado por defecto

                // Aplicar filtro de estado
                const matchesStatusFilter = currentStatusFilter === 'todos' || estado === currentStatusFilter;

                // Aplicar filtro de empresa
                const matchesEmpresaFilter = currentEmpresaFilterId === '' || user.empresaId === currentEmpresaFilterId;

                // Aplicar filtro de asesor
                const matchesAsesorFilter = currentAsesorFilterId === '' || user.asesorId === currentAsesorFilterId;

                // Aplicar filtro de búsqueda (en nombre, identificación, empresa, estado, asesor, ARL, EPS, CCF, AFP, Riesgo)
                const matchesSearch = filterText === '' ||
                    (user.nombre && user.nombre.toLowerCase().includes(filterText)) ||
                    (user.identificacion && String(user.identificacion).toLowerCase().includes(filterText)) ||
                    (empresaNombre.toLowerCase().includes(filterText)) ||
                    (estado.toLowerCase().includes(filterText)) ||
                    (asesorNombre.toLowerCase().includes(filterText)) ||
                    (user.arl && user.arl.toLowerCase().includes(filterText)) || // Add ARL to search
                    (user.eps && user.eps.toLowerCase().includes(filterText)) || // Add EPS to search
                    (user.ccf && user.ccf.toLowerCase().includes(filterText)) || // Add CCF to search
                    (user.afp && user.afp.toLowerCase().includes(filterText)) || // Add AFP to search
                     (user.riesgo && user.riesgo.toLowerCase().includes(filterText)); // Add Riesgo to search


                // Retornar true si coincide con TODOS los filtros
                return matchesStatusFilter && matchesEmpresaFilter && matchesAsesorFilter && matchesSearch;
            });

            // Renderizar las filas filtradas
            if (filteredDocs.length > 0) {
                filteredDocs.forEach(doc => {
                    const row = renderUserRow(doc);
                    userTableBody.appendChild(row);
                });
            } else {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="9" class="text-center text-gray-500">No hay usuarios que coincidan con los filtros.</td>`;
                userTableBody.appendChild(noDataRow);
            }

             console.log(`Tabla de usuarios renderizada. ${filteredDocs.length} usuarios mostrados.`); // Debugging
        }


        // Cargar usuarios inicialmente y configurar el listener de onSnapshot
        async function loadUsersTable() {
             // Cargar mapas antes de la primera carga de la tabla si aún no están cargados
             if (empresasMap.size === 0 || asesoresMap.size === 0) {
                 await loadLookupMaps();
             }

             // Usar onSnapshot para escuchar cambios en tiempo real
             usersCollection.orderBy('nombre').onSnapshot(snapshot => {
                 // Almacenar todos los documentos en la variable global
                 allUserDocs = snapshot.docs;
                 console.log(`onSnapshot triggered. ${allUserDocs.length} total users fetched.`); // Debugging

                 // Renderizar la tabla con los filtros actuales
                 renderFilteredUsers();

             }, error => {
                 console.error("Error al cargar usuarios con onSnapshot:", error);
                 showStatusMessage('Error al cargar usuarios.', 'error');
             });
        }


        // --- Funcionalidad de Búsqueda ---
        searchInput.addEventListener('input', () => {
            // Al cambiar el input de búsqueda, re-renderizar la tabla con el nuevo filtro
            renderFilteredUsers();
        });


        // --- Funcionalidad de Filtro por Estado, Empresa, Asesor ---
        filterButtonsContainer.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.filter-button');
            if (!targetButton) return; // No es un botón de filtro

            const filterType = targetButton.dataset.filter;

            // Remover clase 'active' de todos los botones de estado (Todos, Activos, Retirados)
            document.querySelectorAll('.filter-button[data-filter="todos"], .filter-button[data-filter="activo"], .filter-button[data-filter="retirado"]').forEach(button => button.classList.remove('active'));
             // Remover clase 'active' de los botones de filtro de modal
             document.querySelectorAll('.filter-button[data-filter="empresa"], .filter-button[data-filter="asesor"]').forEach(button => button.classList.remove('active'));


            if (filterType === 'todos' || filterType === 'activo' || filterType === 'retirado') {
                // Filtro por estado
                targetButton.classList.add('active');
                currentStatusFilter = filterType;
                currentEmpresaFilterId = ''; // Resetear filtro de empresa
                currentAsesorFilterId = ''; // Resetear filtro de asesor
                console.log("Filtro de estado cambiado a:", currentStatusFilter);
                renderFilteredUsers(); // Re-renderizar la tabla con el nuevo filtro

            } else if (filterType === 'empresa') {
                // Filtro por empresa (mostrar modal)
                 targetButton.classList.add('active');
                 filterModalTitle.textContent = 'Filtrar por Empresa';
                 filterEmpresaGroup.style.display = 'block';
                 filterAsesorGroup.style.display = 'none';
                 await populateSelects(filterEmpresaSelect, filterAsesorSelect); // Poblar selectores
                 filterEmpresaSelect.value = currentEmpresaFilterId; // Seleccionar filtro actual si existe
                 showFilterModal();
            } else if (filterType === 'asesor') {
                 // Filtro por asesor (mostrar modal)
                 targetButton.classList.add('active');
                 filterModalTitle.textContent = 'Filtrar por Asesor';
                 filterAsesorGroup.style.display = 'block';
                 filterEmpresaGroup.style.display = 'none';
                 await populateSelects(filterEmpresaSelect, filterAsesorSelect); // Poblar selectores
                 filterAsesorSelect.value = currentAsesorFilterId; // Seleccionar filtro actual si existe
                 showFilterModal();
            }

        });

        // --- Manejo del Modal de Filtro ---
        function showFilterModal() {
            filterModal.classList.add('show');
        }

        function hideFilterModal() {
            filterModal.classList.remove('show');
            // Resetear la visualización de los grupos al cerrar el modal
            filterEmpresaGroup.style.display = 'none';
            filterAsesorGroup.style.display = 'none';
             // Asegurarse de que el botón de filtro de modal activo se desactive si se cierra sin aplicar
             document.querySelectorAll('.filter-button[data-filter="empresa"], .filter-button[data-filter="asesor"]').forEach(button => button.classList.remove('active'));
        }

        closeFilterModalButton.addEventListener('click', hideFilterModal);
        cancelFilterButton.addEventListener('click', hideFilterModal);

        filterModal.addEventListener('click', (e) => {
            if (e.target === filterModal) {
                hideFilterModal();
            }
        });

        applyFilterButton.addEventListener('click', () => {
             // Aplicar el filtro seleccionado del modal
             if (filterEmpresaGroup.style.display !== 'none') {
                  currentEmpresaFilterId = filterEmpresaSelect.value;
                  currentAsesorFilterId = ''; // Resetear el otro filtro
                  // Asegurarse de que el filtro de estado sea 'todos' cuando se aplica filtro de empresa/asesor
                  currentStatusFilter = 'todos';
                  document.querySelector('.filter-button[data-filter="todos"]').classList.add('active');
                  document.querySelectorAll('.filter-button[data-filter="activo"], .filter-button[data-filter="retirado"]').forEach(button => button.classList.remove('active'));


                  console.log("Filtro de Empresa aplicado:", currentEmpresaFilterId);
             } else if (filterAsesorGroup.style.display !== 'none') {
                  currentAsesorFilterId = filterAsesorSelect.value;
                  currentEmpresaFilterId = ''; // Resetear el otro filtro
                  // Asegurarse de que el filtro de estado sea 'todos' cuando se aplica filtro de empresa/asesor
                   currentStatusFilter = 'todos';
                   document.querySelector('.filter-button[data-filter="todos"]').classList.add('active');
                   document.querySelectorAll('.filter-button[data-filter="activo"], .filter-button[data-filter="retirado"]').forEach(button => button.classList.remove('active'));


                  console.log("Filtro de Asesor aplicado:", currentAsesorFilterId);
             }

             hideFilterModal();
             renderFilteredUsers(); // Re-renderizar la tabla con los nuevos filtros
        });


        // --- Funcionalidad de Edición, Eliminación y Cambio de Estado de Usuarios ---

        // Listener para los botones de acción en la tabla (usando delegación de eventos)
        userTableBody.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.action-button');
            if (!targetButton) return; // No es un botón de acción

            const userId = targetButton.dataset.id;

            if (targetButton.classList.contains('edit-button')) {
                // Acción de Editar
                console.log("Botón Editar clickeado para usuario:", userId);
                await populateSelects(editEmpresaSelect, editAsesorSelect); // Asegurarse de que los selectores estén poblados
                await loadUserDataForEdit(userId);
                showEditModal();

            } else if (targetButton.classList.contains('delete-button')) {
                // Acción de Eliminar
                console.log("Botón Eliminar clickeado para usuario:", userId);
                if (confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción es irreversible.')) {
                    deleteUser(userId);
                }

            } else if (targetButton.classList.contains('status-button')) {
                // Acción de Cambiar Estado
                console.log("Botón Cambiar Estado clickeado para usuario:", userId);
                const currentStatus = targetButton.dataset.currentStatus;
                const newStatus = currentStatus === 'activo' ? 'retirado' : 'activo';
                changeUserStatus(userId, newStatus);
            }
        });

        // Cargar datos de un usuario en el modal de edición
        async function loadUserDataForEdit(userId) {
            try {
                const userDoc = await usersCollection.doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log("Datos del usuario cargados para edición:", userData);

                    // Llenar el formulario del modal
                    editUserIdInput.value = userId;
                    editNombreInput.value = userData.nombre || '';
                    editTipoIdentificacionSelect.value = userData.tipoIdentificacion || '';
                    editIdentificacionInput.value = userData.identificacion || '';
                    editEmpresaSelect.value = userData.empresaId || ''; // Seleccionar por ID
                    editArlInput.value = userData.arl || '';
                    editRiesgoInput.value = userData.riesgo || '';
                    editEpsInput.value = userData.eps || '';
                    editCcfInput.value = userData.ccf || '';
                    editAfpInput.value = userData.afp || '';
                    editFechaIngresoInput.value = formatDate(userData.fecha);
                    editFechaRegistroInput.value = formatDate(userData.ingreso);
                    editAsesorSelect.value = userData.asesorId || ''; // Seleccionar por ID
                    let valorAPagarNumeric = userData.valorAPagar;
                     if (typeof userData.valorAPagar === 'string') {
                         const cleanedString = userData.valorAPagar.replace(/COP/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                         valorAPagarNumeric = parseFloat(cleanedString);
                     }
                    editValorAPagarInput.value = valorAPagarNumeric || ''; // Poner el valor numérico o vacío

                    editEstadoSelect.value = userData.estado || 'activo'; // Estado por defecto

                    // Mostrar/ocultar campo fechaRetiro basado en el estado
                    if (editEstadoSelect.value === 'retirado') {
                        editFechaRetiroGroup.style.display = 'block';
                        editFechaRetiroInput.value = formatDate(userData.fechaRetiro);
                    } else {
                        editFechaRetiroGroup.style.display = 'none';
                        editFechaRetiroInput.value = ''; // Limpiar si no está retirado
                    }

                } else {
                    console.error("Usuario no encontrado para edición:", userId);
                    showStatusMessage('Error: Usuario no encontrado para editar.', 'error');
                    hideEditModal();
                }
            } catch (error) {
                console.error("Error al cargar datos para edición:", error);
                showStatusMessage('Error al cargar datos del usuario para edición.', 'error');
                hideEditModal();
            }
        }

        // Listener para el cambio en el selector de estado en el modal de edición
        editEstadoSelect.addEventListener('change', (e) => {
            if (e.target.value === 'retirado') {
                editFechaRetiroGroup.style.display = 'block';
                // Opcional: establecer la fecha actual por defecto si se cambia a retirado
                if (!editFechaRetiroInput.value) {
                     editFechaRetiroInput.valueAsDate = new Date();
                }
            } else {
                editFechaRetiroGroup.style.display = 'none';
                editFechaRetiroInput.value = ''; // Limpiar el campo si no está retirado
            }
        });


        // Mostrar el modal de edición
        function showEditModal() {
            editUserModal.classList.add('show');
        }

        // Ocultar el modal de edición
        function hideEditModal() {
            editUserModal.classList.remove('show');
            editUserForm.reset(); // Resetear formulario al cerrar
             editFechaRetiroGroup.style.display = 'none'; // Ocultar campo fecha retiro al cerrar
        }

        // Listener para cerrar modal de edición con la X
        closeEditModalButton.addEventListener('click', hideEditModal);

        // Listener para cerrar modal de edición con el botón Cancelar
        cancelEditButton.addEventListener('click', hideEditModal);

        // Listener para cerrar modal de edición haciendo clic fuera del contenido
        editUserModal.addEventListener('click', (e) => {
            if (e.target === editUserModal) {
                hideEditModal();
            }
        });

        // Listener para guardar cambios del formulario de edición
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevenir envío por defecto

            const userId = editUserIdInput.value;
            const updatedData = {
                nombre: editNombreInput.value,
                tipoIdentificacion: editTipoIdentificacionSelect.value,
                identificacion: editIdentificacionInput.value,
                empresaId: editEmpresaSelect.value, // Guardar solo el ID
                arl: editArlInput.value,
                riesgo: editRiesgoInput.value,
                eps: editEpsInput.value,
                ccf: editCcfInput.value,
                afp: editAfpInput.value,
                fecha: editFechaIngresoInput.value, // Guardar como stringYYYY-MM-DD
                ingreso: editFechaRegistroInput.value, // Guardar como stringYYYY-MM-DD
                asesorId: editAsesorSelect.value, // Guardar solo el ID
                valorAPagar: parseFloat(editValorAPagarInput.value) || 0, // Convertir a número antes de guardar
                estado: editEstadoSelect.value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Añadir fechaRetiro solo si el estado es 'retirado' y el campo tiene valor
            if (updatedData.estado === 'retirado' && editFechaRetiroInput.value) {
                updatedData.fechaRetiro = editFechaRetiroInput.value; // Guardar como stringYYYY-MM-DD
            } else {
                 // Si el estado no es retirado o el campo está vacío, eliminar el campo fechaRetiro
                 updatedData.fechaRetiro = firebase.firestore.FieldValue.delete();
            }


            showStatusMessage('Guardando cambios...', 'info');

            try {
                await usersCollection.doc(userId).update(updatedData);
                showStatusMessage('Cambios guardados con éxito!', 'success');
                hideEditModal(); // Cerrar modal después de guardar
            } catch (error) {
                console.error("Error al guardar cambios:", error);
                showStatusMessage('Error al guardar cambios: ' + error.message, 'error');
            }
        });


        // Eliminar un usuario
        async function deleteUser(userId) {
            showStatusMessage('Eliminando usuario...', 'info');
            try {
                await usersCollection.doc(userId).delete();
                showStatusMessage('Usuario eliminado con éxito!', 'success');
            } catch (error) {
                console.error("Error al eliminar usuario:", error);
                showStatusMessage('Error al eliminar usuario: ' + error.message, 'error');
            }
        }

        // Cambiar el estado de un usuario
        async function changeUserStatus(userId, newStatus) {
             showStatusMessage(`Cambiando estado a "${newStatus}"...`, 'info');
             const updateData = {
                 estado: newStatus,
                 updatedAt: firebase.firestore.FieldValue.serverTimestamp()
             };

             // Añadir/eliminar fechaRetiro según el nuevo estado
             if (newStatus === 'retirado') {
                  // Si se cambia a retirado, añadir la fecha actual si no existe una
                  // En este caso, al cambiar desde la tabla, siempre pondremos la fecha actual
                  updateData.fechaRetiro = formatDate(new Date()); // Usar fecha actual en formatoYYYY-MM-DD
             } else {
                  // Si se cambia a activo, eliminar el campo fechaRetiro
                  updateData.fechaRetiro = firebase.firestore.FieldValue.delete();
             }


             try {
                 await usersCollection.doc(userId).update(updateData);
                 showStatusMessage(`Estado actualizado a "${newStatus}" con éxito!`, 'success');
             } catch (error) {
                 console.error("Error al cambiar estado:", error);
                 showStatusMessage('Error al cambiar estado: ' + error.message, 'error');
             }
        }

        // --- Manejo del Modal de Configuración/Menú ---

        // Mostrar el modal de configuración
        function showSettingsModal() {
            settingsModal.classList.add('show');
        }

        // Ocultar el modal de configuración
        function hideSettingsModal() {
            settingsModal.classList.remove('show');
        }

        // Listener para abrir el modal de configuración al hacer clic en el icono de engranaje
        settingsButton.addEventListener('click', showSettingsModal);

        // Listeners para cerrar el modal de configuración
        closeSettingsModalButton.addEventListener('click', hideSettingsModal);
        closeSettingsModalButtonInModal.addEventListener('click', hideSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                hideSettingsModal();
            }
        });

        // --- Manejo del Modal Genérico para Agregar Entidades ---

        // Mostrar el modal genérico de agregar entidad
        function showAddEntityModal(title, entityType) {
            addEntityModalTitle.textContent = title;
            addEntityTypeInput.value = entityType; // Guardar el tipo de entidad
            entityNameInput.value = ''; // Limpiar el campo de nombre
            addEntityModal.classList.add('show');
        }

        // Ocultar el modal genérico de agregar entidad
        function hideAddEntityModal() {
            addEntityModal.classList.remove('show');
            addEntityForm.reset(); // Resetear el formulario
        }

        // Listeners para cerrar el modal genérico de agregar entidad
        closeAddEntityModalButton.addEventListener('click', hideAddEntityModal);
        cancelAddEntityButton.addEventListener('click', hideAddEntityModal);
        addEntityModal.addEventListener('click', (e) => {
            if (e.target === addEntityModal) {
                hideAddEntityModal();
            }
        });

        // Listener para el envío del formulario del modal genérico de agregar entidad
        addEntityForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevenir envío por defecto

            const entityType = addEntityTypeInput.value;
            const entityName = entityNameInput.value.trim();

            if (!entityName) {
                alert("Por favor, ingresa el nombre.");
                return;
            }

            let collectionRef;
            let successMessage = '';
            let entityData = {
                 nombre: entityName,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Determinar la colección y el mensaje de éxito basado en el tipo de entidad
            switch (entityType) {
                case 'eps':
                    collectionRef = epsCollection;
                    successMessage = 'Nueva EPS agregada con éxito!';
                    break;
                case 'ccf':
                    collectionRef = ccfCollection;
                    successMessage = 'Nueva CCF agregada con éxito!';
                    break;
                case 'afp':
                    collectionRef = afpCollection;
                    successMessage = 'Nueva AFP agregada con éxito!';
                    break;
                case 'asesor':
                    collectionRef = asesoresCollection;
                    successMessage = 'Nuevo Asesor agregado con éxito!';
                    break;
                case 'empresa':
                    collectionRef = empresasCollection;
                    successMessage = 'Nueva Empresa agregada con éxito!';
                    break;
                default:
                    showStatusMessage('Error: Tipo de entidad desconocido.', 'error');
                    return;
            }

            showStatusMessage(`Agregando ${entityName}...`, 'info');

            try {
                await collectionRef.add(entityData);
                showStatusMessage(successMessage, 'success');
                hideAddEntityModal(); // Cerrar modal después de guardar

                // Después de agregar una nueva entidad (especialmente empresa o asesor),
                // recargar los mapas y poblar los selectores en los otros modales.
                if (entityType === 'empresa' || entityType === 'asesor') {
                     await loadLookupMaps(); // Recargar los mapas globales
                     // Repoblar los selectores en el modal de edición y filtro
                     await populateSelects(editEmpresaSelect, editAsesorSelect);
                     await populateSelects(filterEmpresaSelect, filterAsesorSelect);
                }

                // Si el modal de gestión de esta entidad está abierto, recargarlo
                if (manageEntityModal.classList.contains('show') && manageEntityTypeInput.value === entityType) {
                     loadEntitiesForManagement(entityType);
                }


            } catch (error) {
                console.error(`Error al agregar ${entityType}:`, error);
                showStatusMessage(`Error al agregar ${entityType}: ` + error.message, 'error');
            }
        });

        // --- Manejo del Nuevo Modal Genérico para Gestionar Entidades ---

        // Mostrar el modal de gestión de entidades
        function showManageEntityModal(title, entityType) {
             manageEntityModalTitle.textContent = title;
             manageEntityTypeInput.value = entityType; // Guardar el tipo de entidad
             entityList.innerHTML = ''; // Limpiar la lista actual
             manageEntityModal.classList.add('show');
             loadEntitiesForManagement(entityType); // Cargar las entidades al abrir el modal
        }

        // Ocultar el modal de gestión de entidades
        function hideManageEntityModal() {
             manageEntityModal.classList.remove('show');
             entityList.innerHTML = ''; // Limpiar la lista al cerrar
        }

        // Listeners para cerrar el modal de gestión
        closeManageEntityModalButton.addEventListener('click', hideManageEntityModal);
        closeManageEntityModalButtonInModal.addEventListener('click', hideManageEntityModal);
        manageEntityModal.addEventListener('click', (e) => {
             if (e.target === manageEntityModal) {
                 hideManageEntityModal();
             }
        });

        // Listener para abrir el modal de agregar desde el modal de gestión
        openAddFromManageButton.addEventListener('click', () => {
             const entityType = manageEntityTypeInput.value;
             let modalTitle = '';
             switch (entityType) {
                 case 'eps': modalTitle = 'Agregar Nueva EPS'; break;
                 case 'ccf': modalTitle = 'Agregar Nueva CCF'; break;
                 case 'afp': modalTitle = 'Agregar Nueva AFP'; break;
                 case 'asesor': modalTitle = 'Agregar Nuevo Asesor'; break;
                 case 'empresa': modalTitle = 'Agregar Nueva Empresa'; break;
                 default: modalTitle = 'Agregar Nueva Entidad';
             }
             hideManageEntityModal(); // Ocultar el modal de gestión
             showAddEntityModal(modalTitle, entityType); // Mostrar el modal de agregar
        });


        // Función para cargar y mostrar entidades en el modal de gestión
        async function loadEntitiesForManagement(entityType) {
            entityList.innerHTML = '<li>Cargando...</li>'; // Mensaje de carga
            let collectionRef;
            let entityTypeName = '';

            switch (entityType) {
                case 'eps': collectionRef = epsCollection; entityTypeName = 'EPS'; break;
                case 'ccf': collectionRef = ccfCollection; entityTypeName = 'CCF'; break;
                case 'afp': collectionRef = afpCollection; entityTypeName = 'AFP'; break;
                case 'asesor': collectionRef = asesoresCollection; entityTypeName = 'Asesor'; break;
                case 'empresa': collectionRef = empresasCollection; entityTypeName = 'Empresa'; break;
                default:
                    entityList.innerHTML = '<li>Error: Tipo de entidad desconocido.</li>';
                    return;
            }

            manageEntityModalTitle.textContent = `Gestionar ${entityTypeName}s`; // Actualizar título del modal

            try {
                const snapshot = await collectionRef.orderBy('nombre').get();
                entityList.innerHTML = ''; // Limpiar lista

                if (snapshot.empty) {
                    entityList.innerHTML = `<li>No hay ${entityTypeName}s registrados.</li>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const entity = doc.data();
                    const listItem = document.createElement('li');
                    listItem.classList.add('entity-item');
                    listItem.dataset.id = doc.id;
                    listItem.dataset.type = entityType;

                    listItem.innerHTML = `
                        <span class="entity-name">${entity.nombre || 'Sin Nombre'}</span>
                        <button class="delete-entity-button" data-id="${doc.id}" data-type="${entityType}">Eliminar</button>
                    `;
                    entityList.appendChild(listItem);
                });

            } catch (error) {
                console.error(`Error al cargar ${entityTypeName}s:`, error);
                entityList.innerHTML = `<li>Error al cargar ${entityTypeName}s.</li>`;
                showStatusMessage(`Error al cargar ${entityTypeName}s.`, 'error');
            }
        }

        // Listener para los botones de eliminar en el modal de gestión (usando delegación)
        entityList.addEventListener('click', async (e) => {
            const targetButton = e.target.closest('.delete-entity-button');
            if (!targetButton) return; // No es un botón de eliminar

            const entityId = targetButton.dataset.id;
            const entityType = targetButton.dataset.type;
            const entityName = targetButton.parentElement.querySelector('.entity-name').textContent; // Obtener el nombre para la confirmación

            if (confirm(`¿Estás seguro de que deseas eliminar "${entityName}"? Esta acción es irreversible.`)) {
                deleteEntity(entityType, entityId, entityName);
            }
        });

        // Función para eliminar una entidad
        async function deleteEntity(entityType, entityId, entityName) {
             // Determine the entity type name for the status message
             let entityTypeName = '';
             switch (entityType) {
                 case 'eps': entityTypeName = 'EPS'; break;
                 case 'ccf': entityTypeName = 'CCF'; break;
                 case 'afp': entityTypeName = 'AFP'; break;
                 case 'asesor': entityTypeName = 'Asesor'; break;
                 case 'empresa': entityTypeName = 'Empresa'; break;
                 default: entityTypeName = 'Entidad';
             }

             showStatusMessage(`Eliminando ${entityTypeName}...`, 'info');

             let collectionRef;

             switch (entityType) {
                 case 'eps': collectionRef = epsCollection; break;
                 case 'ccf': collectionRef = ccfCollection; break;
                 case 'afp': collectionRef = afpCollection; break;
                 case 'asesor': collectionRef = asesoresCollection; break;
                 case 'empresa': collectionRef = empresasCollection; break;
                 default:
                     showStatusMessage('Error: Tipo de entidad desconocido para eliminar.', 'error');
                     return;
             }

             try {
                 await collectionRef.doc(entityId).delete();
                 showStatusMessage(`${entityTypeName} "${entityName}" eliminado con éxito!`, 'success');

                 // Recargar la lista en el modal de gestión
                 loadEntitiesForManagement(entityType);

                 // Si se elimina una empresa o asesor, recargar los mapas y selectores
                 if (entityType === 'empresa' || entityType === 'asesor') {
                      await loadLookupMaps(); // Recargar los mapas globales
                      // Repoblar los selectores en el modal de edición y filtro
                      await populateSelects(editEmpresaSelect, editAsesorSelect);
                      await populateSelects(filterEmpresaSelect, filterAsesorSelect);
                      // Re-renderizar la tabla de usuarios por si algún usuario estaba asociado a la entidad eliminada
                      renderFilteredUsers();
                 }


             } catch (error) {
                 console.error(`Error al eliminar ${entityTypeName}:`, error);
                 showStatusMessage(`Error al eliminar ${entityTypeName} "${entityName}": ` + error.message, 'error');
                 // Considerar si se debe manejar el caso de que la entidad esté referenciada por usuarios
                 // En una aplicación real, probablemente querrías evitar la eliminación si hay referencias
             }
        }


        // Listener para los botones de opción en el modal de configuración (actualizados para abrir el modal de gestión o importar/exportar)
        menuOptionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const entityType = e.target.dataset.entityType;

                if (entityType) { // Si tiene data-entity-type, es un botón de gestionar entidad
                    let entityTypeName = '';
                    switch (entityType) {
                        case 'eps': entityTypeName = 'EPS'; break;
                        case 'ccf': entityTypeName = 'CCF'; break;
                        case 'afp': entityTypeName = 'AFP'; break;
                        case 'asesor': entityTypeName = 'Asesor'; break;
                        case 'empresa': entityTypeName = 'Empresa'; break;
                        default: entityTypeName = 'Entidad';
                    }
                    const modalTitle = `Gestionar ${entityTypeName}s`;
                    hideSettingsModal();
                    showManageEntityModal(modalTitle, entityType);
                }
            });
        });

        // Listener para el botón Exportar Usuarios
        exportUsersButton.addEventListener('click', () => {
            hideSettingsModal(); // Ocultar el modal de configuración
            exportUsersToCsv(); // Llamar a la función de exportación
        });

        // Listener para el botón Importar Usuarios
        importUsersButton.addEventListener('click', () => {
            hideSettingsModal(); // Ocultar el modal de configuración
            showImportUsersModal(); // Mostrar el modal de importación
        });


        // --- Funcionalidad de Exportar Usuarios a CSV ---
        function exportUsersToCsv() {
             showStatusMessage('Preparando exportación...', 'info');

             // Obtener los datos actualmente filtrados y mostrados en la tabla
             // Una forma simple es iterar sobre las filas renderizadas,
             // pero es más robusto usar los `filteredDocs` que se usan para renderizar.
             // Sin embargo, `filteredDocs` no es global. Vamos a usar `allUserDocs`
             // y aplicar los filtros actuales para garantizar que se exporte lo que se ve.

             const filterText = searchInput.value.toLowerCase();
             const usersToExport = allUserDocs.filter(userDoc => {
                 const user = userDoc.data();
                 const empresaNombre = empresasMap.get(user.empresaId) || 'Desconocida';
                 const asesorNombre = asesoresMap.get(user.asesorId) || 'Desconocido';
                 const estado = user.estado || 'activo';

                 const matchesStatusFilter = currentStatusFilter === 'todos' || estado === currentStatusFilter;
                 const matchesEmpresaFilter = currentEmpresaFilterId === '' || user.empresaId === currentEmpresaFilterId;
                 const matchesAsesorFilter = currentAsesorFilterId === '' || user.asesorId === currentAsesorFilterId;
                 const matchesSearch = filterText === '' ||
                     (user.nombre && user.nombre.toLowerCase().includes(filterText)) ||
                     (user.identificacion && String(user.identificacion).toLowerCase().includes(filterText)) ||
                     (empresaNombre.toLowerCase().includes(filterText)) ||
                     (estado.toLowerCase().includes(filterText)) ||
                     (asesorNombre.toLowerCase().includes(filterText)) ||
                     (user.arl && user.arl.toLowerCase().includes(filterText)) || // Add ARL to search
                     (user.eps && user.eps.toLowerCase().includes(filterText)) || // Add EPS to search
                     (user.ccf && user.ccf.toLowerCase().includes(filterText)) || // Add CCF to search
                     (user.afp && user.afp.toLowerCase().includes(filterText)) || // Add AFP to search
                      (user.riesgo && user.riesgo.toLowerCase().includes(filterText)); // Add Riesgo to search


                 return matchesStatusFilter && matchesEmpresaFilter && matchesAsesorFilter && matchesSearch;
             });


             if (usersToExport.length === 0) {
                 showStatusMessage('No hay usuarios para exportar con los filtros actuales.', 'info');
                 return;
             }

             // Definir los encabezados del CSV
             const headers = [
                 "NOMBRE", "TIPO DE IDENTIFICACION", "IDENTIFICACION", "EMPRESA", "ARL", "RIESGO",
                 "EPS", "CCF", "AFP", "FECHA INGRESO", "ASESOR", "VALOR A PAGAR", "ESTADO", "FECHA RETIRO"
             ];

             // Crear las filas del CSV
             const rows = usersToExport.map(userDoc => {
                 const user = userDoc.data();
                 const empresaNombre = empresasMap.get(user.empresaId) || '';
                 const asesorNombre = asesoresMap.get(user.asesorId) || '';
                 const estado = user.estado || 'activo';
                 const fechaRetiro = user.fechaRetiro ? formatDate(user.fechaRetiro) : '';


                 return [
                     user.nombre || '',
                     user.tipoIdentificacion || '',
                     user.identificacion || '',
                     empresaNombre, // Usar el nombre de la empresa
                     user.arl || '',
                     user.riesgo || '',
                     user.eps || '',
                     user.ccf || '',
                     user.afp || '',
                     formatDate(user.fecha), // Formatear fecha de ingreso
                     asesorNombre, // Usar el nombre del asesor
                     user.valorAPagar !== undefined && user.valorAPagar !== null ? user.valorAPagar : '', // Exportar valor numérico
                     estado,
                     fechaRetiro // Incluir fecha de retiro
                 ].map(field => {
                      // Convertir todo a string antes de manejar comillas
                      let fieldString = String(field || '');
                      // Escapar comillas dobles con dobles comillas dobles y envolver en comillas
                      return `"${fieldString.replace(/"/g, '""')}"`;
                 }).join(','); // Envolver campos en comillas y escapar comillas dobles
             });

             // Unir encabezados y filas
             const csvContent = [headers.join(','), ...rows].join('\n');

             // Crear un Blob y un enlace para descargar
             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);

             link.setAttribute('href', url);
             link.setAttribute('download', 'usuarios_facba.csv'); // Nombre del archivo
             link.style.visibility = 'hidden'; // Ocultar el enlace
             document.body.appendChild(link); // Añadir al DOM temporalmente
             link.click(); // Simular clic para descargar
             document.body.removeChild(link); // Eliminar del DOM
             URL.revokeObjectURL(url); // Liberar el URL del Blob

             showStatusMessage('Usuarios exportados con éxito a usuarios_facba.csv', 'success');
        }


        // --- Funcionalidad de Importar Usuarios desde Excel ---

        // Mostrar el modal de importación
        function showImportUsersModal() {
             importUsersModal.classList.add('show');
             excelFileInput.value = null; // Limpiar el input de archivo
             showImportStatusMessage('Selecciona un archivo Excel (.xlsx o .xls).');
        }

        // Ocultar el modal de importación
        function hideImportUsersModal() {
             importUsersModal.classList.remove('show');
        }

        // Listeners para cerrar el modal de importación
        closeImportModalButton.addEventListener('click', hideImportUsersModal);
        cancelImportButton.addEventListener('click', hideImportUsersModal);
        importUsersModal.addEventListener('click', (e) => {
            if (e.target === importUsersModal) {
                hideImportUsersModal();
            }
        });

        // Listener para el botón "Procesar Importación"
        processImportButton.addEventListener('click', async () => {
            const file = excelFileInput.files[0];
            if (!file) {
                showImportStatusMessage('Por favor, selecciona un archivo primero.', 'error');
                return;
            }

            showImportStatusMessage('Procesando archivo...', 'info');
            processImportButton.disabled = true; // Deshabilitar botón durante el proceso

            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Asumimos que los datos están en la primera hoja
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convertir la hoja a un array de objetos (usando la primera fila como encabezados)
                    // header: 1 para usar la primera fila como encabezados
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });


                    if (jsonData.length <= 1) { // Check if there's more than just the header row
                        showImportStatusMessage('El archivo Excel está vacío o no contiene datos en el formato esperado.', 'error');
                        processImportButton.disabled = false;
                        return;
                    }

                    // Extraer encabezados de la primera fila
                    const headersRow = jsonData[0];
                    const dataRows = jsonData.slice(1); // Obtener solo las filas de datos

                     console.log("Encabezados leídos del Excel:", headersRow); // Log headers
                     console.log("Número de filas de datos leídas:", dataRows.length); // Log count


                    // Mapear los nombres de columna del Excel a los nombres de campo de Firestore
                    const columnMapping = {
                        "NOMBRE": "nombre",
                        "TIPO DE IDENTIFICACION": "tipoIdentificacion",
                        "IDENTIFICACION": "identificacion",
                        "EMPRESA": "empresa", // Nota: Necesitaremos mapear el nombre de la empresa a su ID
                        "ARL": "arl",
                        "RIESGO": "riesgo",
                        "EPS": "eps",
                        "CCF": "ccf",
                        "AFP": "afp",
                        "FECHA INGRESO": "fecha", // Nota: Necesitaremos parsear la fecha
                        "ASESOR": "asesor", // Nota: Necesitaremos mapear el nombre del asesor a su ID
                        "VALOR A PAGAR": "valorAPagar", // Nota: Necesitaremos parsear a número
                         "ESTADO": "estado", // Opcional: Si el estado viene en el Excel
                         "FECHA RETIRO": "fechaRetiro" // Opcional: Si la fecha de retiro viene en el Excel
                    };

                    const requiredColumns = [
                        "NOMBRE", "TIPO DE IDENTIFICACION", "IDENTIFICACION", "EMPRESA",
                        "FECHA INGRESO", "ASESOR", "VALOR A PAGAR" // Columnas mínimas requeridas
                    ];

                    // Crear un mapeo dinámico de índice de columna a campo de Firestore
                    const dynamicColumnMapping = {};
                    const excelHeadersUpper = headersRow.map(header => String(header).trim().toUpperCase());

                    requiredColumns.forEach(requiredHeader => {
                         if (!excelHeadersUpper.includes(requiredHeader)) {
                             showImportStatusMessage(`Error: Faltan la columna requerida "${requiredHeader}" en el archivo.`, 'error');
                             processImportButton.disabled = false;
                             return; // Stop processing if required headers are missing
                         }
                    });
                     if(processImportButton.disabled) return; // Stop if missing required headers

                     // Create dynamic mapping for all recognized headers
                     excelHeadersUpper.forEach((header, index) => {
                          if (columnMapping[header]) {
                               dynamicColumnMapping[index] = columnMapping[header];
                          }
                     });

                     console.log("Mapeo dinámico de columnas:", dynamicColumnMapping);


                    // Cargar mapas de empresas y asesores para mapear nombres a IDs
                    await loadLookupMaps(); // Asegurarse de que los mapas estén actualizados

                    const batch = db.batch(); // Usar batch para escritura eficiente
                    let importedCount = 0;
                    let errorCount = 0;
                    const importErrors = [];

                    showImportStatusMessage(`Iniciando importación de ${dataRows.length} filas de datos...`);

                    for (let i = 0; i < dataRows.length; i++) {
                        const row = dataRows[i];
                        const userData = {};
                        let isValidRow = true;
                        let rowErrors = [];
                        const rowNumber = i + 2; // Excel row number (1-indexed header + 1)

                         console.log(`Procesando Fila ${rowNumber}:`, row); // Log the raw row data


                        // Mapear y validar datos por columna usando el mapeo dinámico
                        for (const colIndex in row) {
                            const firestoreField = dynamicColumnMapping[colIndex];

                            if (firestoreField) {
                                 let value = row[colIndex];
                                 // Handle potential null/undefined values from empty cells gracefully
                                 value = value === undefined || value === null ? '' : value;


                                 // Validaciones y transformaciones específicas por campo
                                 if (firestoreField === 'identificacion') {
                                      // Asegurar que la identificación sea un string o número válido
                                      userData[firestoreField] = String(value).trim();
                                      if (!userData[firestoreField]) {
                                           isValidRow = false;
                                           rowErrors.push("Identificación vacía");
                                      }
                                 } else if (firestoreField === 'empresa') {
                                      // Mapear nombre de empresa a ID
                                      const empresaName = String(value).trim();
                                      const empresaEntry = Array.from(empresasMap.entries()).find(([id, name]) => name.toLowerCase() === empresaName.toLowerCase());
                                      if (empresaEntry) {
                                           userData['empresaId'] = empresaEntry[0]; // Guardar el ID
                                      } else {
                                           // Si la empresa no existe, marcar error
                                           isValidRow = false;
                                           rowErrors.push(`Empresa "${empresaName}" no encontrada`);
                                      }
                                 } else if (firestoreField === 'asesor') {
                                      // Mapear nombre de asesor a ID
                                      const asesorName = String(value).trim();
                                       const asesorEntry = Array.from(asesoresMap.entries()).find(([id, name]) => name.toLowerCase() === asesorName.toLowerCase());
                                       if (asesorEntry) {
                                            userData['asesorId'] = asesorEntry[0]; // Guardar el ID
                                       } else {
                                            // Si el asesor no existe, marcar error
                                            isValidRow = false;
                                            rowErrors.push(`Asesor "${asesorName}" no encontrado`);
                                        }
                                 } else if (firestoreField === 'fecha' || firestoreField === 'fechaRetiro') {
                                      // Parsear fechas. XLSX puede devolver números (serial) o strings.
                                      let dateValue = null;
                                      if (typeof value === 'number') {
                                           // Asumir que es un número serial de Excel y convertir a fecha
                                           // Need to adjust for the difference between Excel epoch (1899-12-30) and JS epoch (1970-01-01)
                                           // and Excel's leap year bug prior to 1900 (handle date > 60)
                                           const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                           // For serial dates > 60 (after 1900-03-01), subtract 1 to account for Excel's incorrect 1900 leap year
                                           const adjustedValue = value > 60 ? value - 1 : value;
                                           dateValue = new Date(excelEpoch.getTime() + adjustedValue * 24 * 60 * 60 * 1000);

                                      } else if (typeof value === 'string' && value.trim() !== '') {
                                           // Intentar parsear string de fecha (YYYY-MM-DD, MM/DD/YYYY, etc.)
                                           try {
                                                // Prefer YYYY-MM-DD if possible
                                                if (/^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
                                                     dateValue = new Date(value.trim() + 'T00:00:00Z'); // Parse as UTC to avoid timezone issues
                                                } else {
                                                    dateValue = new Date(value.trim()); // Try general parsing
                                                }

                                                // Check if the parsed date is valid
                                                if (isNaN(dateValue.getTime())) {
                                                    dateValue = null; // Invalid date string
                                                } else {
                                                    // Format to YYYY-MM-DD string to match existing data format if needed,
                                                    // or store as a Firestore Timestamp directly.
                                                    // Let's store as Date objects and Firestore will handle Timestamps.
                                                }
                                           } catch (e) {
                                                dateValue = null; // Parsing failed
                                           }
                                      }

                                      if (dateValue) {
                                          userData[firestoreField] = dateValue; // Guardar como objeto Date
                                      } else if (firestoreField === 'fecha') { // Fecha de ingreso es requerida
                                           isValidRow = false;
                                           rowErrors.push(`Fecha de Ingreso inválida o vacía: "${value}"`);
                                      }
                                      // Fecha de retiro es opcional, no marcar error si está vacía/inválida
                                 } else if (firestoreField === 'valorAPagar') {
                                      // Parsear valor a pagar a número
                                      const numericValue = parseFloat(String(value).replace(/[^0-9.-]+/g,"")); // Limpiar no-números excepto . y -
                                      userData[firestoreField] = isNaN(numericValue) ? 0 : numericValue; // Guardar como número, 0 si no es válido
                                 } else if (firestoreField === 'estado') {
                                      // Validar estado (opcional, si viene en el Excel)
                                      const estadoValue = String(value).trim().toLowerCase();
                                      if (estadoValue === 'activo' || estadoValue === 'retirado') {
                                           userData[firestoreField] = estadoValue;
                                      } else {
                                           userData[firestoreField] = 'activo'; // Estado por defecto si no es válido
                                      }
                                 }
                                 else {
                                      // Otros campos de texto (ARL, RIESGO, EPS, CCF, AFP, NOMBRE, TIPO DE IDENTIFICACION)
                                      userData[firestoreField] = String(value || '').trim();
                                 }
                            }
                        }

                        // Realizar validaciones adicionales para campos requeridos no cubiertos arriba
                        if (!userData.nombre || !userData.tipoIdentificacion || !userData.identificacion || !userData.hasOwnProperty('empresaId') || !userData.hasOwnProperty('asesorId') || !(userData.fecha instanceof Date && !isNaN(userData.fecha)) || userData.valorAPagar === undefined || userData.valorAPagar === null) {
                            if (!userData.nombre) rowErrors.push("Nombre vacío");
                            if (!userData.tipoIdentificacion) rowErrors.push("Tipo de Identificación vacío");
                            if (!userData.identificacion) rowErrors.push("Identificación vacía"); // Duplicated check, but good for clarity
                            if (!userData.hasOwnProperty('empresaId')) rowErrors.push("Empresa no válida o vacía");
                            if (!userData.hasOwnProperty('asesorId')) rowErrors.push("Asesor no válido o vacío");
                             if (!(userData.fecha instanceof Date && !isNaN(userData.fecha))) rowErrors.push("Fecha de Ingreso inválida o vacía");
                             if (userData.valorAPagar === undefined || userData.valorAPagar === null) rowErrors.push("Valor a Pagar inválido o vacío");
                             isValidRow = false; // Mark row as invalid if any required field is missing/invalid
                        }


                        // Añadir campos obligatorios que podrían no estar en el Excel o estar vacíos
                         if (!userData.hasOwnProperty('estado')) {
                             userData.estado = 'activo'; // Estado por defecto si no viene en Excel
                         }
                         // fechaRetiro se maneja al parsear la fecha o se elimina si no es retirado


                        // Si la fila es válida, prepararla para el batch
                        if (isValidRow) {
                            // Convertir Date objects to Firestore Timestamps
                             if (userData.fecha instanceof Date) {
                                 userData.fecha = firebase.firestore.Timestamp.fromDate(userData.fecha);
                             }
                             if (userData.fechaRetiro instanceof Date) {
                                  userData.fechaRetiro = firebase.firestore.Timestamp.fromDate(userData.fechaRetiro);
                             } else if (userData.fechaRetiro !== undefined && userData.fechaRetiro !== null && userData.estado !== 'retirado') {
                                  // If date exists but status is not retired, delete it
                                   userData.fechaRetiro = firebase.firestore.FieldValue.delete();
                             } else if (userData.fechaRetiro === '') {
                                 // If date was empty in excel, delete it
                                  userData.fechaRetiro = firebase.firestore.FieldValue.delete();
                             }


                            // Añadir campos de metadatos
                            userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            userData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

                             console.log(`Datos preparados para Firestore (Fila ${rowNumber}):`, userData); // Log data before saving

                            // Crear una nueva referencia de documento y añadir la operación al batch
                            const newUserRef = usersCollection.doc();
                            batch.set(newUserRef, userData);
                            importedCount++;
                        } else {
                            errorCount++;
                            importErrors.push(`Fila ${rowNumber}: ${rowErrors.join(', ')}`);
                             console.error(`Errores de validación en Fila ${rowNumber}:`, rowErrors); // Log row errors
                        }
                    }

                    // Ejecutar el batch
                    if (importedCount > 0) {
                        showImportStatusMessage(`Guardando ${importedCount} usuarios...`, 'info');
                        try {
                            await batch.commit();
                            let finalMessage = `Importación completada. ${importedCount} usuarios agregados con éxito.`;
                            if (errorCount > 0) {
                                finalMessage += ` ${errorCount} filas con errores.`;
                                console.error("Resumen de Errores de importación:", importErrors);
                                // Podrías mostrar los errores en un área de texto o modal adicional si son muchos
                                alert("Errores de importación:\n" + importErrors.join('\n')); // Alerta simple por ahora
                            }
                            showImportStatusMessage(finalMessage, errorCount === 0 ? 'success' : 'info');

                            // Opcional: Recargar la tabla después de la importación (onSnapshot debería manejarlo)
                             // loadUsersTable();

                        } catch (batchError) {
                            console.error("Error al guardar batch en Firestore:", batchError);
                            showImportStatusMessage('Error al guardar datos en la base de datos: ' + batchError.message, 'error');
                        }
                    } else if (errorCount > 0) {
                         showImportStatusMessage(`No se agregaron usuarios. ${errorCount} filas con errores.`, 'error');
                         console.error("Resumen de Errores de importación:", importErrors);
                         alert("Errores de importación:\n" + importErrors.join('\n'));
                    }
                    else {
                        showImportStatusMessage('No se encontraron datos válidos para importar.', 'info');
                    }


                } catch (parseError) {
                    console.error("Error al leer o parsear el archivo Excel:", parseError);
                    showImportStatusMessage('Error al leer o procesar el archivo: ' + parseError.message, 'error');
                } finally {
                    processImportButton.disabled = false; // Habilitar botón nuevamente
                    excelFileInput.value = null; // Limpiar el input de archivo
                }
            };

            reader.onerror = (error) => {
                console.error("Error al leer el archivo:", error);
                showImportStatusMessage('Error al leer el archivo.', 'error');
                processImportButton.disabled = false;
                 excelFileInput.value = null; // Limpiar el input de archivo
            };

            reader.readAsArrayBuffer(file); // Leer el archivo como ArrayBuffer
        });


        // --- Inicialización ---
        // Cargar la tabla de usuarios al cargar la página
        loadUsersTable();


    </script>

</body>
</html>
